<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Inspecciones M&amp;R</title>

<!-- OCR fallback para el esc√°ner -->
<script defer src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>

<style>
  :root{
    --brand:#0b74c7; --bg:#f6f8fb; --ink:#1f2937; --muted:#6b7280;
    --card:#fff; --line:#e5e7eb; --radius:14px
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.35 system-ui, Segoe UI, Roboto, Helvetica, Arial}
  .wrap{max-width:1200px;margin:0 auto;padding:16px}

  .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:0 10px 30px rgba(0,0,0,.06)}
  header{padding:12px 14px;border-bottom:1px solid var(--line);display:flex;gap:12px;align-items:center;justify-content:space-between}
  header h1{margin:0;font-size:18px;color:var(--brand)}
  .toolbar{display:flex;flex-wrap:wrap;gap:8px}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border:1px solid var(--line);border-radius:999px;font-size:12px;color:#334155;background:#fff}
  .muted{color:var(--muted)}
  .btn{border:1px solid var(--line);background:#fff;border-radius:10px;padding:8px 12px;cursor:pointer}
  .btn.primary{background:var(--brand);color:#fff;border-color:var(--brand)}
  .btn.ghost{background:transparent}
  .btn.danger{background:#dc2626;color:#fff;border-color:#dc2626}
  .btn:disabled{opacity:.55;cursor:not-allowed}
  .hide{display:none !important}

  .section{padding:12px 14px}
  .grid{display:grid;gap:12px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .qcard{border:1px solid var(--line);border-radius:12px;padding:10px 12px;background:#fff}
  .qtitle{font-size:12px;color:var(--muted);margin-bottom:6px}
  input[type="text"],input[type="number"],textarea,select{width:100%;border:1px solid #dbe2ea;border-radius:8px;padding:8px 10px;font:inherit}
  input[type="date"]{border:1px solid #dbe2ea;border-radius:8px;padding:6px 10px;font:inherit}
  input[readonly]{background:#f3f4f6}
  label.inline{display:inline-flex;align-items:center;gap:6px}
  .hint{font-size:12px;color:var(--muted)}
  .spacer{height:10px}

  /* Tabla */
  table{width:100%;border-collapse:separate;border-spacing:0}
  thead th{position:sticky;top:0;background:#f9fbfe;border-bottom:1px solid var(--line);font-weight:600;padding:8px;z-index:1}
  tbody td{border-bottom:1px dashed #eef2f7;padding:6px 8px;vertical-align:top}
  .badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid #cbd5e1;background:#fff;white-space:nowrap}
  .b-pend{border-color:#f59e0b;color:#92400e;background:#fffbeb}
  .b-send{border-color:#10b981;color:#065f46;background:#ecfdf5}
  .b-fail{border-color:#ef4444;color:#7f1d1d;background:#fef2f2}
  .b-prog{border-color:#3b82f6;color:#1e3a8a;background:#eff6ff}

  /* KPIs + Chips (AEMS) */
  .kpi{display:flex;gap:8px;flex-wrap:wrap}
  .kpi .pill{background:#f8fafc}
  .kpi .pill[data-st], .kpi .pill[data-a-st]{cursor:pointer;transition:all .15s ease}
  .kpi .pill[data-st].active, .kpi .pill[data-a-st].active{background:var(--brand);color:#fff;border-color:var(--brand)}

  /* Searchbar compacta */
  .searchbar{display:flex;align-items:center;gap:6px;background:#fff;border:1px solid var(--line);
    border-radius:999px;padding:4px 10px;width:240px}
  .searchbar input{border:none;outline:none;flex:1;font:inherit;background:transparent}

  /* Formulario l√≠neas */
  .qwrap{padding:12px 14px;display:grid;gap:12px}
  .qgrid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
  .cell-photos{width:160px}
  .cell-del{width:34px;text-align:center}
  thead th.small{min-width:90px}
  thead th.comp{min-width:160px}
  thead th.size{min-width:120px}
  thead th.qty{width:120px}
  thead th.resp{width:130px}
  td.td-loc  input{ max-width:90px  }
  td.td-dano input{ max-width:90px  }
  td.td-comp input{ min-width:160px }
  td.td-mrep input{ max-width:100px }
  td.td-size input{ max-width:120px }
  td.td-qty  input{ min-width:120px; font-size:15px }
  td.td-resp input{ min-width:130px; font-size:15px }

  /* Bot√≥n circular marcador "R" */
  .marker-btn{
    width:30px;height:30px;border-radius:999px;border:2px solid #94a3b8;background:#fff;
    display:inline-flex;align-items:center;justify-content:center;font-weight:700;cursor:pointer;
    user-select:none;transition:all .15s ease;
  }
  .marker-btn.active{background:#0b74c7;color:#fff;border-color:#0b74c7}

  /* Overlay */
  #overlay{ position:fixed; inset:0; background:rgba(15,23,42,.55);
    display:none; align-items:center; justify-content:center; z-index:9999; backdrop-filter: blur(2px); }
  .spinner{ width:56px; height:56px; border-radius:50%;
    border:6px solid rgba(255,255,255,.35); border-top-color:#fff; animation:spin 1s linear infinite; margin:0 auto; }
  @keyframes spin{to{transform:rotate(360deg)}}
  .loading-card{ background:#0b1220; color:#e5edf5; border-radius:16px; padding:18px 16px; min-width:240px; text-align:center; border:1px solid #263045 }
  .loading-card p{ margin:10px 0 0 0; font-size:14px; color:#b8c4d6 }

  /* Vista √©xito */
  #view-done{display:none}
  .done-wrap{padding:28px 20px;text-align:center}
  .done-emoji{font-size:44px;line-height:1;margin-bottom:6px}
  .done-title{font-size:18px;font-weight:700;margin:4px 0 8px}
  .done-sub{color:var(--muted);margin:0 0 16px}
  .done-actions{display:flex;gap:10px;flex-wrap:wrap;justify-content:center}
  .done-actions a, .done-actions button{min-width:180px}

  /* Toast */
  #toast{ position:fixed; left:12px; right:12px; bottom:12px; z-index:9999;
    display:none; padding:10px 12px; border-radius:10px; border:1px solid #dbe2ea; background:#ffffffcc;
    backdrop-filter:saturate(180%) blur(10px); box-shadow:0 8px 24px rgba(0,0,0,.08); font-size:14px }

  /* Modal Scanner */
  #scanModal{ position:fixed; inset:0; background:rgba(0,0,0,.8); display:none; z-index:9998; align-items:center; justify-content:center; }
  .scan-card{ background:#0b1220; color:#e5edf5; border:1px solid #263045; border-radius:16px; padding:12px; width:min(520px,94vw); }
  .scan-head{ display:flex; align-items:center; justify-content:space-between; gap:8px; padding:6px 2px 10px }
  .scan-body{ display:grid; gap:8px }
  .scan-vid{ width:100%; border-radius:12px; background:#000 }
  .scan-actions{ display:flex; gap:8px; justify-content:flex-end; padding-top:6px }
  .scan-actions button{ flex:1 }

  /* Modal T√©cnico/Vendor */
  #userModal{ position:fixed; inset:0; background:rgba(0,0,0,.6); display:none; z-index:9997; align-items:center; justify-content:center; }
  .user-card{ background:#fff; color:#0f172a; border:1px solid var(--line); border-radius:16px; padding:16px; width:min(520px,94vw); }
  .user-card h3{ margin:0 0 8px;font-size:18px }
  .user-grid{ display:grid; gap:10px }

  /* ============ DASHBOARD interno ============ */
  #view-admin{display:none}
  .pager{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .pager .btn{min-width:90px}

  /* Per-page abajo (AEMS) */
  .pager-bottom{display:flex;gap:8px;align-items:center;flex-wrap:wrap;justify-content:space-between;margin-top:10px}
  .pager-bottom select{border:1px solid var(--line);border-radius:10px;padding:8px 10px;background:#fff}

  .select{border:1px solid var(--line);border-radius:10px;padding:8px 10px;background:#fff}

  @media (max-width:1000px){ .qgrid{grid-template-columns:repeat(2,1fr)} }
  @media (max-width:640px){
    .qgrid{grid-template-columns:1fr}
    .submitbar{justify-content:stretch}
    .submitbar .btn{flex:1}
    .searchbar{width:100%}
  }
</style>
</head>
<body>
<div class="wrap">

  <!-- ============ VISTA COLA (INICIO) ============ -->
  <div id="view-queue" class="card">
    <header>
      <h1>Unidades en cola</h1>
      <div class="toolbar">
        <span class="pill" id="userBadge">üë§ T√©cnico & Vendor</span>
        <button class="btn" id="btnChangeUser">Cambiar t√©cnico/vendor</button>
        <button class="btn" id="btnNew">+ Nueva inspecci√≥n</button>
        <button class="btn primary" id="btnSendAll">Enviar todo</button>

        <!-- Admin controls -->
        <button class="btn" id="btnAdminLogin">Iniciar admin</button>
        <button class="btn" id="btnAdminLogout" style="display:none">Cerrar sesi√≥n</button>
        <button class="btn" id="btnGoAdmin" style="display:none">Dashboard</button>
      </div>
    </header>
    <div class="section">
      <div class="row" style="justify-content:space-between;align-items:center">
        <!-- KPIs con chips (AEMS) -->
        <div class="kpi">
          <span class="pill" data-st="all">All</span>
          <span class="pill" data-st="pendiente">Pendientes: <b id="kpiPend">0</b></span>
          <span class="pill" data-st="enviando">Enviando: <b id="kpiProg">0</b></span>
          <span class="pill" data-st="enviado">Enviadas: <b id="kpiOk">0</b></span>
          <span class="pill" data-st="fallido">Fallidas: <b id="kpiFail">0</b></span>
        </div>
        <!-- Searchbar compacta + acciones -->
        <div class="row">
          <div class="searchbar">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path stroke="#64748b" stroke-width="2" d="m21 21-4.35-4.35m2.35-5.15a7.5 7.5 0 1 1-15 0 7.5 7.5 0 0 1 15 0Z"/></svg>
            <input id="qSearch" type="text" placeholder="Buscar contenedor / folio‚Ä¶"/>
          </div>
          <button class="btn" id="btnRetryFail">Reintentar fallidas</button>
          <button class="btn danger" id="btnClearSent">Limpiar enviadas</button>
        </div>
      </div>

      <div class="spacer"></div>

      <div style="overflow:auto">
        <table>
          <thead>
            <tr>
              <th>Fecha</th>
              <th>Contenedor</th>
              <th>Gate</th>
              <th>Naviera</th>
              <th>Folio</th>
              <th>Estado</th>
              <th>Da√±os</th>
              <th>Fotos</th>
              <th>Status</th>
              <th style="min-width:230px">Acciones</th>
            </tr>
          </thead>
          <tbody id="tbodyQueue"></tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="spacer"></div>

  <!-- ============ FORMULARIO INSPECCI√ìN ============ -->
  <div id="view-form" class="card" style="display:none">
    <header>
      <h1>MAERSK ‚Äî Cuestionario</h1>
      <div class="toolbar">
        <button class="btn" id="btnBackQueue">‚Üê Volver a la cola</button>
        <!-- (Se eliminaron los botones de exportar para usuarios normales) -->
      </div>
    </header>

    <section class="qwrap">
      <div class="qgrid">

        <!-- Orden: Container ‚Üí Fecha ‚Üí Gate -->
        <div class="qcard">
          <div class="qtitle">Container N¬∫</div>
          <div class="row">
            <input id="q_container" type="text" placeholder="MSKU1549768" style="text-transform:uppercase;letter-spacing:.5px">
            <!-- bot√≥n scanner con √≠cono de barras -->
            <button class="btn" id="btnContScan" title="Escanear ID">
              <svg width="22" height="22" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <rect x="3" y="5" width="18" height="14" rx="2" stroke="#0b74c7" stroke-width="2"/>
                <path d="M7 8v8M12 8v8M17 8v8" stroke="#0b74c7" stroke-width="2"/>
              </svg>
            </button>
          </div>
          <div class="hint">11 caracteres (4 letras + 7 d√≠gitos). Sin guiones. Si el DV no coincide, podr√°s continuar igual.</div>
        </div>

        <div class="qcard"><div class="qtitle">Fecha</div><div class="row"><input id="q_fecha" type="date"></div></div>

        <div class="qcard">
          <div class="qtitle">Gate</div>
          <div class="row">
            <label class="inline"><input type="radio" name="q_gate" value="GATE IN"> GATE IN</label>
            <label class="inline"><input type="radio" name="q_gate" value="GATE OUT"> GATE OUT</label>
          </div>
        </div>

        <!-- Resto -->
        <div class="qcard"><div class="qtitle">Naviera</div><div class="row">
          <select id="q_naviera"><option>MAERSK</option><option>HAPAG-LLOYD</option><option>COSCO</option><option>TRANSMARES</option><option>OOCL</option><option>OTRA</option></select>
        </div></div>
        <div class="qcard"><div class="qtitle">Lugar</div><div class="row"><input id="q_lugar" type="text"></div></div>

        <div class="qcard"><div class="qtitle">Folio</div><div class="row"><input id="q_folio" type="text"></div></div>
        <div class="qcard"><div class="qtitle">Tipo</div><div class="row">
          <select id="q_tipo"><option>20 DRY</option><option selected>40 DRY</option><option>40 HC</option><option>20 RF</option><option>40 RF</option></select>
        </div></div>

        <div class="qcard"><div class="qtitle">Estado</div><div class="row">
          <label class="inline"><input type="radio" name="q_estado" value="B"> B</label>
          <label class="inline"><input type="radio" name="q_estado" value="M"> M</label>
          <span class="pill">opcional</span>
        </div></div>

        <div class="qcard"><div class="qtitle">Para</div><div class="row">
          <label class="inline"><input type="radio" name="q_para" value="EXP"> EXP</label>
          <label class="inline"><input type="radio" name="q_para" value="IMP"> IMP</label>
          <label class="inline"><input type="radio" name="q_para" value="CFS"> CFS</label>
          <span class="pill">opcional</span>
        </div></div>

        <div class="qcard"><div class="qtitle">Vacio</div><div class="row">
          <label class="inline"><input type="radio" name="q_vacio" value="S"> S</label>
          <label class="inline"><input type="radio" name="q_vacio" value="N"> N</label>
          <span class="pill">opcional</span>
        </div></div>

        <div class="qcard"><div class="qtitle">OOG</div><div class="row">
          <label class="inline"><input type="radio" name="q_oog" value="S"> S</label>
          <label class="inline"><input type="radio" name="q_oog" value="N"> N</label>
          <span class="pill">opcional</span>
        </div></div>

        <div class="qcard"><div class="qtitle">Transportista</div><div class="row"><input id="q_transportista" type="text"></div></div>
        <div class="qcard"><div class="qtitle">Patente Cami√≥n</div><div class="row"><input id="q_patente" type="text"></div></div>
        <div class="qcard"><div class="qtitle">Nave</div><div class="row"><input id="q_nave" type="text"></div></div>
        <div class="qcard"><div class="qtitle">Pto Embarque / Descarga</div><div class="row"><input id="q_ptoemb" class="half" type="text"><input id="q_ptodesc" class="half" type="text"></div></div>
        <div class="qcard"><div class="qtitle">Tara / Gross (KGS)</div><div class="row"><input id="q_tara" class="half" type="number" step="0.01"><input id="q_gross" class="half" type="number" step="0.01"></div></div>
        <div class="qcard"><div class="qtitle">Class / Status</div><div class="row"><input id="q_class" class="half" type="text"><input id="q_status" class="half" type="text"></div></div>
        <div class="qcard"><div class="qtitle">Interior Condition</div><div class="row"><input id="q_interior" type="text"></div></div>

      </div>
    </section>

    <header>
      <h1>REPAIR ESTIMATE ‚Äî l√≠neas din√°micas</h1>
      <div class="toolbar">
        <button class="btn primary" id="btnAdd">+ Agregar l√≠nea</button>
        <button class="btn" id="btnClear">Vaciar l√≠neas</button>
      </div>
    </header>

    <div class="section" style="overflow:auto">
      <table id="tabla">
        <thead>
          <tr>
            <th style="width:44px">‚úì</th>
            <th class="small">Loc</th>
            <th class="small">Da√±o</th>
            <th class="comp">Comp</th>
            <th class="small">M. Rep</th>
            <th class="size">Size</th>
            <th class="qty">Qty</th>
            <th class="resp">Resp</th>
            <th class="cell-photos">Cargar fotos</th>
            <th class="cell-del"></th>
          </tr>
        </thead>
        <tbody id="body"></tbody>
      </table>
    </div>

    <div class="section grid" style="grid-template-columns:1fr 1fr 1fr">
      <div><label class="qtitle">Remarks</label><textarea id="remarks" rows="3"></textarea></div>
      <div><label class="qtitle">Nombre T√©cnico</label><input id="insp" type="text" /></div>
      <div><label class="qtitle">Vendor</label><input id="vendor" type="text" /></div>
    </div>

    <div class="section row" style="justify-content:flex-end;border-top:1px solid var(--line);padding-top:12px">
      <button class="btn" id="btnSaveQueue">Guardar en cola</button>
      <button class="btn primary" id="btnSubmit">Guardar y enviar ahora</button>
    </div>

    <div id="log" class="section" style="white-space:pre-wrap;background:#0b1220;color:#cbd5e1;border-radius:10px;display:none"></div>
  </div>

  <!-- ============ √âXITO ============ -->
  <div id="view-done" class="card">
    <header>
      <h1>Enviado correctamente</h1>
      <div class="toolbar"><span class="pill">‚úÖ Listo</span></div>
    </header>
    <div class="done-wrap">
      <div class="done-emoji">‚úÖ</div>
      <div class="done-title">Tu inspecci√≥n fue enviada</div>
      <p class="done-sub" id="done-sub">Puedes ver la carpeta o volver a la cola.</p>
      <div class="done-actions">
        <button id="btnBackQueue2" class="btn">Volver a la cola</button>
        <a id="btnFolder" class="btn" target="_blank" rel="noopener">Abrir carpeta</a>
      </div>
    </div>
  </div>

  <!-- ============ DASHBOARD INTERNO ============ -->
  <div id="view-admin" class="card">
    <header>
      <h1>MAERSK ‚Äî Dashboard en vivo</h1>
      <div class="toolbar">
        <span class="pill" id="adminBadge">üë§ Invitado</span>
        <button class="btn" id="btnAdminBack">‚Üê Volver</button>
        <button class="btn" id="btnAdminRefresh">Refrescar</button>
        <button class="btn primary" id="btnExportSel" style="display:none">Exportar seleccionadas</button>
      </div>
    </header>

    <div class="section">
      <div class="row" style="justify-content:space-between">
        <!-- KPIs con chips (AEMS) -->
        <div class="row">
          <span class="pill" data-a-st="all">All</span>
          <span class="pill" data-a-st="pendiente">Pendientes: <b id="a_kpiPend">0</b></span>
          <span class="pill" data-a-st="enviando">Enviando: <b id="a_kpiProg">0</b></span>
          <span class="pill" data-a-st="enviado">Enviadas: <b id="a_kpiOk">0</b></span>
          <span class="pill" data-a-st="fallido">Fallidas: <b id="a_kpiFail">0</b></span>
        </div>
        <!-- Searchbar compacta -->
        <div class="row">
          <div class="searchbar">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path stroke="#64748b" stroke-width="2" d="m21 21-4.35-4.35m2.35-5.15a7.5 7.5 0 1 1-15 0 7.5 7.5 0 0 1 15 0Z"/></svg>
            <input id="a_txtSearch" type="text" placeholder="Buscar contenedor‚Ä¶">
          </div>
        </div>
      </div>

      <div style="height:10px"></div>

      <div style="overflow:auto">
        <table>
          <thead>
            <tr>
              <th id="a_thSel" style="width:30px"><input type="checkbox" id="a_checkAll" /></th>
              <th>Fecha</th>
              <th>Contenedor</th>
              <th>Gate</th>
              <th>Naviera</th>
              <th>Da√±os</th>
              <th>Fotos</th>
              <th>Status</th>
              <th>Carpeta</th>
            </tr>
          </thead>
          <tbody id="a_tbody"></tbody>
        </table>
      </div>

      <!-- Paginaci√≥n abajo (AEMS) -->
      <div class="pager-bottom">
        <div class="row">
          <button class="btn" id="a_prev">¬´ Anterior</button>
          <span class="pill" id="a_pageInfo">P√°gina 1/1</span>
          <button class="btn" id="a_next">Siguiente ¬ª</button>
        </div>
        <div class="row">
          <label class="muted" style="font-size:12px">Mostrar:</label>
          <select id="a_perPage" class="select">
            <option value="20" selected>20</option>
            <option value="40">40</option>
            <option value="100">100</option>
            <option value="200">200</option>
          </select>
          <span class="pill" id="a_lastUpdate">‚Äî</span>
        </div>
      </div>
    </div>
  </div>

</div>

<!-- Overlay -->
<div id="overlay" role="alert" aria-live="polite" aria-busy="true">
  <div class="loading-card">
    <div class="spinner" aria-hidden="true"></div>
    <p id="overlayMsg">Procesando‚Ä¶</p>
  </div>
</div>

<!-- Modal Scanner -->
<div id="scanModal">
  <div class="scan-card">
    <div class="scan-head">
      <strong>Escanear contenedor</strong>
      <button class="btn" id="scanClose" type="button">Cerrar</button>
    </div>
    <div class="scan-body">
      <video id="scanVideo" class="scan-vid" playsinline></video>
      <div class="scan-actions">
        <button class="btn" id="scanCapture" type="button">Capturar</button>
        <button class="btn primary" id="scanUse" type="button">Usar</button>
      </div>
      <div class="hint">Apunta al ID (texto/c√≥digo). Si no detecta, ‚ÄúUsar‚Äù intentar√° OCR del fotograma.</div>
    </div>
  </div>
</div>

<!-- Modal T√©cnico/Vendor -->
<div id="userModal">
  <div class="user-card">
    <h3>Identificaci√≥n</h3>
    <div class="user-grid">
      <div>
        <div class="qtitle">Nombre t√©cnico</div>
        <input id="u_tecnico" type="text" placeholder="Nombre y apellido"/>
      </div>
      <div>
        <div class="qtitle">Vendor</div>
        <input id="u_vendor" type="text" placeholder="Empresa / Taller"/>
      </div>
    </div>
    <div class="row" style="justify-content:flex-end;margin-top:10px">
      <button class="btn" id="btnUserCancel">Cerrar</button>
      <button class="btn primary" id="btnUserSave">Guardar</button>
    </div>
  </div>
</div>

<!-- Modal Login Admin -->
<div id="loginModal" style="position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;z-index:99999;align-items:center;justify-content:center">
  <div class="user-card" style="max-width:420px">
    <h3>Acceso administrador</h3>
    <div class="user-grid">
      <div><div class="qtitle">Usuario</div><input id="loginUser" type="text" placeholder="Usuario"></div>
      <div><div class="qtitle">Contrase√±a</div><input id="loginPass" type="password" placeholder="Contrase√±a"></div>
    </div>
    <div class="row" style="justify-content:flex-end;margin-top:10px">
      <button class="btn" id="btnLoginCancel">Cancelar</button>
      <button class="btn primary" id="btnLoginOk">Entrar</button>
    </div>
  </div>
</div>

<!-- Toast -->
<div id="toast"></div>

<!-- üí° La PARTE 2 incluye todo el <script> con la l√≥gica completa -->
<script>
/* ================= CONFIGURACI√ìN GENERAL ================= */
const GAS_URL = 'https://script.google.com/macros/s/AKfycbz22e7uZGaBmSDQujQCNVYJWlKJZYmsf3ch3yMt5wzZx-UXBRb8Rte0mFG5ZzbjzcQD8w/exec';
const API_URL = GAS_URL;

/* =============== UTILIDADES DE INTERFAZ =============== */
const $ = (q,el)=> (el||document).querySelector(q);
let toastTimer;
function toast(msg,ms){const t=$("#toast");t.textContent=msg;t.style.display='block';clearTimeout(toastTimer);toastTimer=setTimeout(()=>t.style.display='none',ms||2000);}
function setOverlay(on,msg){$("#overlayMsg").textContent=msg||"Procesando‚Ä¶";$("#overlay").style.display=on?'flex':'none';}
function show(v){
  $("#view-queue").style.display=(v==='queue')?'block':'none';
  $("#view-form").style.display=(v==='form')?'block':'none';
  $("#view-done").style.display=(v==='done')?'block':'none';
  $("#view-admin").style.display=(v==='admin')?'block':'none';
}

/* =============== ALMACENAMIENTO LOCAL (COLA) =============== */
const DB_NAME='reefer_inspections_db';const STORE='queue';const DB_VER=1;
function idbOpen(){return new Promise((res,rej)=>{const r=indexedDB.open(DB_NAME,DB_VER);
r.onupgradeneeded=()=>{const db=r.result;if(!db.objectStoreNames.contains(STORE)){db.createObjectStore(STORE,{keyPath:'id'});}};
r.onsuccess=()=>res(r.result);r.onerror=()=>rej(r.error);});}
async function dbTxn(mode){const db=await idbOpen();return db.transaction(STORE,mode);}
async function queueAdd(it){const tx=await dbTxn('readwrite');tx.objectStore(STORE).put(it);tx.db.close();}
async function queueGetAll(){const tx=await dbTxn('readonly');return new Promise(r=>{const req=tx.objectStore(STORE).getAll();req.onsuccess=()=>{tx.db.close();r(req.result||[])}});}
async function queueUpdate(id,patch){const tx=await dbTxn('readwrite');const st=tx.objectStore(STORE);const cur=await new Promise(r=>{const g=st.get(id);g.onsuccess=()=>r(g.result);});if(!cur)return;
Object.assign(cur,patch);st.put(cur);tx.db.close();}
async function queueDelete(id){const tx=await dbTxn('readwrite');tx.objectStore(STORE).delete(id);tx.db.close();}

/* =============== RENDERIZADO DE COLA =============== */
async function renderQueue(filter='all'){
  const q=$("#qSearch").value.trim().toUpperCase();
  const tbody=$("#tbodyQueue");tbody.innerHTML='';
  const all=await queueGetAll();
  const pend=all.filter(x=>x.status==='pendiente').length;
  const prog=all.filter(x=>x.status==='enviando').length;
  const ok=all.filter(x=>x.status==='enviado').length;
  const fail=all.filter(x=>x.status==='fallido').length;
  $("#kpiPend").textContent=pend;$("#kpiProg").textContent=prog;$("#kpiOk").textContent=ok;$("#kpiFail").textContent=fail;

  let data=all;
  if(filter!=='all')data=data.filter(x=>x.status===filter);
  if(q)data=data.filter(x=>(x.questionnaire.container||'').includes(q));
  data.sort((a,b)=>a.createdAt<b.createdAt?1:-1);

  for(const it of data){
    const st=it.status==='pendiente'?'b-pend':it.status==='enviado'?'b-send':it.status==='enviando'?'b-prog':'b-fail';
    const photos=(it.photos||[]).reduce((n,a)=>n+(a?.length||0),0);
    const damages=(it.lines||[]).length;
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${(it.questionnaire.fecha||'').slice(0,10)}</td>
      <td><b>${it.questionnaire.container||''}</b></td>
      <td>${it.questionnaire.gate||''}</td>
      <td>${it.questionnaire.naviera||''}</td>
      <td>${damages}</td>
      <td>${photos}</td>
      <td><span class="badge ${st}">${it.status}</span></td>
      <td>
        <div class="row">
          <button class="btn" data-act="edit" data-id="${it.id}">Editar</button>
          <button class="btn" data-act="send" data-id="${it.id}">Enviar</button>
          <button class="btn danger" data-act="del" data-id="${it.id}">Eliminar</button>
        </div>
      </td>`;
    tbody.appendChild(tr);
  }

  tbody.onclick=async e=>{
    const b=e.target.closest('button');if(!b)return;
    const id=b.dataset.id;const act=b.dataset.act;
    const all=await queueGetAll();const item=all.find(x=>x.id===id);if(!item)return;
    if(act==='del'){await queueDelete(id);renderQueue(filter);}
    if(act==='send'){sendItems([item]);}
  };
}

/* =============== ENV√çO DE ELEMENTOS =============== */
async function sendItems(items){
  if(!items.length)return;setOverlay(true,'Enviando inspecci√≥n‚Ä¶');
  for(const it of items){
    await queueUpdate(it.id,{status:'enviando'});
    const payload={meta:{naviera:it.questionnaire.naviera,fecha:it.questionnaire.fecha,unidad:it.questionnaire.container},form:it.questionnaire,lines:it.lines};
    try{
      const res=await fetch(GAS_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
      const j=await res.json();if(!j.ok)throw new Error(j.error);
      await queueUpdate(it.id,{status:'enviado',folderUrl:j.folderUrl||''});
    }catch(err){
      await queueUpdate(it.id,{status:'fallido',lastError:String(err)});
    }
  }
  setOverlay(false);renderQueue();
}

/* =============== LOGIN ADMIN / DASHBOARD =============== */
let AUTH_USER=null,AUTH_HASH=null,IS_ADMIN=false;
async function sha256Hex(str){const enc=new TextEncoder().encode(str);const buf=await crypto.subtle.digest('SHA-256',enc);return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');}
async function apiGet(fn){const u=new URL(API_URL);u.searchParams.set('fn',fn);if(AUTH_USER)u.searchParams.set('user',AUTH_USER);if(AUTH_HASH)u.searchParams.set('passHash',AUTH_HASH);return fetch(u).then(r=>r.json());}
function setAdminUI(is){IS_ADMIN=is;$("#btnAdminLogin").style.display=is?'none':'inline-block';$("#btnAdminLogout").style.display=is?'inline-block':'none';$("#btnGoAdmin").style.display=is?'inline-block':'none';$("#adminBadge").textContent=is?`üë§ Admin (${AUTH_USER||''})`:'üë§ Invitado';}
async function doLogin(){const u=$("#loginUser").value.trim(),p=$("#loginPass").value;if(!u||!p){toast('Completa usuario y clave');return;}
const h=await sha256Hex(p);AUTH_USER=u;AUTH_HASH=h;const info=await apiGet('whoami');if(info?.ok&&info.isAdmin){localStorage.setItem('auth_user',u);localStorage.setItem('auth_hash',h);setAdminUI(true);$("#loginModal").style.display='none';}else toast('Credenciales inv√°lidas');}
function doLogout(){AUTH_USER=null;AUTH_HASH=null;IS_ADMIN=false;localStorage.clear();setAdminUI(false);show('queue');}

/* =============== DASHBOARD =============== */
let a_all=[],a_filtered=[],a_page=1,a_per=20,a_selected=new Set();
function a_render(filter='all'){
  const tb=$("#a_tbody");tb.innerHTML='';
  let rows=a_all;
  if(filter!=='all')rows=rows.filter(r=>(r.status||'').toLowerCase()===filter);
  const q=$("#a_txtSearch").value.toUpperCase();
  if(q)rows=rows.filter(r=>(r.container||'').toUpperCase().includes(q));
  const total=rows.length,pages=Math.max(1,Math.ceil(total/a_per));if(a_page>pages)a_page=pages;
  const ini=(a_page-1)*a_per,fin=Math.min(total,ini+a_per);
  for(let i=ini;i<fin;i++){
    const r=rows[i];const st=r.status==='pendiente'?'b-pend':r.status==='enviado'?'b-send':r.status==='enviando'?'b-prog':'b-fail';
    const tr=document.createElement('tr');
    const folder=r.folderUrl?`<a href="${r.folderUrl}" target="_blank">Abrir</a>`:'‚Äî';
    tr.innerHTML=`<td><input type="checkbox" class="row-check" data-id="${r.id}"></td>
      <td>${r.fecha||''}</td><td><b>${r.container||''}</b></td><td>${r.gate||''}</td>
      <td>${r.naviera||''}</td><td>${r.linesCount||0}</td><td>${r.photosCount||0}</td>
      <td><span class="badge ${st}">${r.status}</span></td><td>${folder}</td>`;
    tb.appendChild(tr);
  }
  $("#a_pageInfo").textContent=`P√°gina ${a_page}/${pages}`;
}
async function a_refresh(){if(!IS_ADMIN){toast('Admin requerido');return;}
const r=await apiGet('getinspections');if(r?.ok){a_all=r.items||[];a_render();$("#a_lastUpdate").textContent=new Date().toLocaleString();}}
async function a_export(){
  if(!IS_ADMIN){toast('Admin requerido');return;}
  const ids=Array.from(a_selected);if(!ids.length){toast('Selecciona al menos 1');return;}
  const res=await fetch(API_URL+'?fn=exportinspectionsbyids',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({user:AUTH_USER,passHash:AUTH_HASH,ids})}).then(r=>r.json());
  if(res?.ok){const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([JSON.stringify(res,null,2)],{type:'application/json'}));a.download='inspecciones.json';a.click();}
}

/* =============== EVENTOS =============== */
function attachEvents(){
  $("#btnNew").onclick=()=>show('form');
  $("#btnBackQueue,#btnBackQueue2,#btnAdminBack").forEach?null:($("#btnBackQueue").onclick=()=>show('queue'));
  $("#btnSendAll").onclick=async()=>{const all=await queueGetAll();const pend=all.filter(x=>x.status==='pendiente');sendItems(pend);}
  $("#btnRetryFail").onclick=async()=>{const all=await queueGetAll();const fail=all.filter(x=>x.status==='fallido');sendItems(fail);}
  $("#btnClearSent").onclick=async()=>{const all=await queueGetAll();for(const i of all){if(i.status==='enviado')await queueDelete(i.id);}renderQueue();}
  $("#btnAdminLogin").onclick=()=>$("#loginModal").style.display='flex';
  $("#btnLoginCancel").onclick=()=>$("#loginModal").style.display='none';
  $("#btnLoginOk").onclick=doLogin;
  $("#btnAdminLogout").onclick=doLogout;
  $("#btnGoAdmin").onclick=()=>{if(IS_ADMIN)show('admin');a_refresh();};
  $("#btnAdminRefresh").onclick=a_refresh;
  $("#btnExportSel").onclick=a_export;
  $("#qSearch").oninput=()=>renderQueue(activeFilter);
  document.querySelectorAll('[data-st]').forEach(p=>p.onclick=()=>{document.querySelectorAll('[data-st]').forEach(x=>x.classList.remove('active'));p.classList.add('active');activeFilter=p.dataset.st;renderQueue(activeFilter);});
  document.querySelectorAll('[data-a-st]').forEach(p=>p.onclick=()=>{document.querySelectorAll('[data-a-st]').forEach(x=>x.classList.remove('active'));p.classList.add('active');a_render(p.dataset.aSt);});
}
let activeFilter='all';

/* =============== INICIALIZACI√ìN =============== */
window.addEventListener('DOMContentLoaded',async()=>{
  attachEvents();renderQueue();
  const u=localStorage.getItem('auth_user'),h=localStorage.getItem('auth_hash');
  if(u&&h){AUTH_USER=u;AUTH_HASH=h;const info=await apiGet('whoami');if(info?.ok&&info.isAdmin)setAdminUI(true);}
});
</script>
</body>
</html>
