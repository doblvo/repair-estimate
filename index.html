<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MAERSK – Cuestionario + Repair Estimate (GAS Backend)</title>
  <style>
    :root{ --brand:#0b74c7; --bg:#f6f8fb; --ink:#1f2937; --muted:#6b7280; --card:#fff; --line:#e5e7eb; --radius:14px }
    *{box-sizing:border-box}
    body{margin:0;padding:24px;background:var(--bg);color:var(--ink);font:14px/1.35 system-ui, Segoe UI, Roboto, Helvetica, Arial}
    .wrap{max-width:1200px;margin:0 auto}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:0 10px 30px rgba(0,0,0,.06)}
    header{padding:14px 16px;border-bottom:1px solid var(--line);display:flex;gap:12px;align-items:center;justify-content:space-between}
    header h1{margin:0;font-size:18px}
    .toolbar{display:flex;flex-wrap:wrap;gap:8px}
    button{border:1px solid var(--line);background:#fff;border-radius:10px;padding:8px 12px;cursor:pointer}
    button.primary{background:var(--brand);color:#fff;border-color:var(--brand)}
    button.ghost{background:transparent}
    button:disabled{opacity:.5;cursor:not-allowed}
    .qwrap{padding:14px 16px;display:grid;gap:12px}
    .qgrid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
    .qcard{border:1px solid var(--line);border-radius:12px;padding:10px 12px;background:#fff}
    .qtitle{font-size:12px;color:var(--muted);margin-bottom:6px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .row input[type="text"], .row input[type="number"], .row input[type="date"], .row input[type="time"], .row select{width:100%;border:1px solid #dbe2ea;border-radius:8px;padding:6px 8px;font:inherit}
    .row .half{flex:1 1 48%}
    .pill{display:inline-block;padding:2px 8px;border:1px solid var(--line);border-radius:999px;font-size:12px}
    table{width:100%;border-collapse:separate;border-spacing:0}
    thead th{position:sticky;top:0;background:#f9fbfe;border-bottom:1px solid var(--line);font-weight:600;padding:8px 6px;z-index:1}
    tbody td{border-bottom:1px dashed #eef2f7;padding:4px}
    tfoot td{border-top:2px solid var(--line);font-weight:700;padding:8px 6px;background:#fafbfd}
    input[type="text"], input[type="number"], textarea{width:100%;border:1px solid #dbe2ea;border-radius:8px;padding:6px 8px;font:inherit}
    input[readonly]{background:#f3f4f6}
    .cell-photos{width:140px}
    .cell-del{width:34px;text-align:center}
    .grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;padding:12px 16px;border-top:1px solid var(--line)}
    .grid>div label{display:block;font-size:12px;color:var(--muted);margin-bottom:4px}
    .submitbar{display:flex;gap:10px;justify-content:flex-end;padding:12px 16px;border-top:1px solid var(--line)}
    @media (max-width:1000px){ .qgrid{grid-template-columns:repeat(2,1fr)} }
    @media (max-width:600px){
      header{flex-direction:column;align-items:flex-start}
      .qgrid{grid-template-columns:1fr}
      .grid{grid-template-columns:1fr}
      table{font-size:13px}
    }
    #log{white-space:pre-wrap;background:#0b1220;color:#cbd5e1;padding:12px;border-radius:10px;margin:12px;max-height:220px;overflow:auto}
  </style>
</head>
<body>
<div class="wrap card">
  <header>
    <h1>MAERSK — Cuestionario inicial</h1>
    <div class="toolbar">
      <button id="btnCSV" type="button">Exportar CSV</button>
      <button id="btnJSON" type="button">Exportar JSON</button>
    </div>
  </header>

  <!-- CUESTIONARIO -->
  <section class="qwrap">
    <div class="qgrid">
      <div class="qcard"><div class="qtitle">Container Nº</div><div class="row"><input id="q_container" type="text" placeholder="MSKU1234567"></div></div>
      <div class="qcard"><div class="qtitle">Folio Nº</div><div class="row"><input id="q_folio" type="text"></div></div>
      <div class="qcard"><div class="qtitle">Estado</div><div class="row">
        <label><input type="radio" name="q_estado" value="B"> B</label>
        <label><input type="radio" name="q_estado" value="M"> M</label>
        <span class="pill">(opcional)</span>
      </div></div>
      <div class="qcard"><div class="qtitle">Tipo</div><div class="row">
        <select id="q_tipo"><option>20 DRY</option><option selected>40 DRY</option><option>40 HC</option><option>20 RF</option><option>40 RF</option></select>
      </div></div>

      <div class="qcard"><div class="qtitle">Para</div><div class="row">
        <label><input type="radio" name="q_para" value="EXP"> EXP</label>
        <label><input type="radio" name="q_para" value="IMP"> IMP</label>
        <label><input type="radio" name="q_para" value="CFS"> CFS</label>
        <span class="pill">(opcional)</span>
      </div></div>
      <div class="qcard"><div class="qtitle">Naviera</div><div class="row">
        <select id="q_naviera">
          <option>MAERSK</option><option>HAPAG-LLOYD</option><option>COSCO</option><option>TRANSMARES</option><option>OOCL</option><option>OTRA</option>
        </select>
      </div></div>
      <div class="qcard"><div class="qtitle">Lugar</div><div class="row"><input id="q_lugar" type="text" placeholder="CL"></div></div>
      <div class="qcard"><div class="qtitle">Fecha y Hora</div><div class="row">
        <input id="q_fecha" class="half" type="date"><input id="q_hora" class="half" type="time">
      </div></div>

      <div class="qcard"><div class="qtitle">Vacio</div><div class="row">
        <label><input type="radio" name="q_vacio" value="S"> S</label>
        <label><input type="radio" name="q_vacio" value="N"> N</label>
        <span class="pill">(opcional)</span>
      </div></div>
      <div class="qcard"><div class="qtitle">OOG</div><div class="row">
        <label><input type="radio" name="q_oog" value="S"> S</label>
        <label><input type="radio" name="q_oog" value="N"> N</label>
        <span class="pill">(opcional)</span>
      </div></div>
      <div class="qcard"><div class="qtitle">Transportista</div><div class="row"><input id="q_transportista" type="text"></div></div>
      <div class="qcard"><div class="qtitle">Patente Camión</div><div class="row"><input id="q_patente" type="text"></div></div>
      <div class="qcard"><div class="qtitle">Nave</div><div class="row"><input id="q_nave" type="text"></div></div>
      <div class="qcard"><div class="qtitle">Pto Embarque / Descarga</div><div class="row"><input id="q_ptoemb" class="half" type="text" placeholder="CL"><input id="q_ptodesc" class="half" type="text"></div></div>
      <div class="qcard"><div class="qtitle">Tara / Gross (KGS)</div><div class="row"><input id="q_tara" class="half" type="number" step="0.01" placeholder="7250"><input id="q_gross" class="half" type="number" step="0.01" placeholder="32500"></div></div>
      <div class="qcard"><div class="qtitle">Class / Status</div><div class="row"><input id="q_class" class="half" type="text" placeholder="S"><input id="q_status" class="half" type="text" placeholder="PTI"></div></div>
      <div class="qcard"><div class="qtitle">Interior Condition</div><div class="row"><input id="q_interior" type="text" placeholder="06-25"></div></div>
    </div>
  </section>

  <!-- REPAIR ESTIMATE -->
  <header>
    <h1>REPAIR ESTIMATE — líneas dinámicas</h1>
    <div class="toolbar">
      <button id="btnAdd" class="primary" type="button">+ Agregar línea</button>
      <button id="btnClear" class="ghost" type="button">Vaciar líneas</button>
    </div>
  </header>

  <div style="overflow:auto;">
    <table id="tabla">
      <thead>
        <tr>
          <th style="width:54px">#</th>
          <th style="min-width:110px">Location</th>
          <th style="min-width:120px">Type of Damage</th>
          <th style="min-width:190px">Component & Repair Method</th>
          <th style="min-width:130px">Size of Repair</th>
          <th style="width:70px">Qty</th>
          <th style="min-width:80px">Code</th>
          <th style="width:110px">Man Hours</th>
          <th style="width:140px">Material Cost</th>
          <th style="width:60px">R</th>
          <th class="cell-photos">Cargar fotos</th>
          <th class="cell-del"></th>
        </tr>
      </thead>
      <tbody id="body"></tbody>
      <tfoot>
        <tr>
          <td colspan="7">Totales</td>
          <td id="totHH">0.0</td>
          <td id="totMat">0.00</td>
          <td colspan="3"></td>
        </tr>
      </tfoot>
    </table>
  </div>

  <div class="grid">
    <div><label>Remarks</label><textarea id="remarks" rows="3" placeholder="Observaciones generales..."></textarea></div>
    <div><label>Nombre Técnico</label><input id="insp" type="text" placeholder="Nombre" /></div>
    <div><label>Correo Técnico</label><input id="insp_email" type="text" placeholder="tecnico@empresa.cl" /></div>
    <div><label>Fecha / Lugar</label><input id="fecha" type="datetime-local" /></div>
  </div>

  <div class="submitbar">
    <button id="btnSubmit" class="primary" type="button">Submit</button>
  </div>

  <div id="log"></div>
</div>

<script>
/* ===================== CONFIG (GAS BACKEND) ===================== */
var GAS_URL = 'https://script.google.com/macros/s/AKfycbyZozDbNtG-Qt8vtLSJr93lDraU8nzdzu1N6e0RwYhBZsn7ITBP0ZCysc2cKqP99DRmmg/exec';

/* ===================== UTIL/UI ===================== */
function $(q, el){ return (el||document).querySelector(q); }
var logEl = null;
function log(m){ logEl.textContent += m + "\n"; logEl.scrollTop = logEl.scrollHeight; }

/* Radios des-seleccionables (sin template strings) */
document.addEventListener('click', function(e){
  if(e.target && e.target.matches('input[type="radio"]')){
    var r = e.target;
    if(r._was){ r.checked=false; r._was=false; }
    else{
      var list = document.querySelectorAll('input[name="' + r.name + '"]');
      for(var i=0;i<list.length;i++){ list[i]._was=false; }
      r._was=true;
    }
  }
});

/* ===================== CUESTIONARIO/REPAIR ===================== */
function getRadio(name){
  var el = document.querySelector('input[name="'+name+'"]:checked');
  return el ? el.value : "";
}
function getQuestionnaire(){
  return {
    container: $('#q_container').value.trim(),
    folio: $('#q_folio').value.trim(),
    estado: getRadio('q_estado'),
    tipo: $('#q_tipo').value,
    para: getRadio('q_para'),
    naviera: $('#q_naviera').value,
    lugar: $('#q_lugar').value.trim(),
    fecha: $('#q_fecha').value, hora: $('#q_hora').value,
    vacio: getRadio('q_vacio'),
    oog: getRadio('q_oog'),
    transportista: $('#q_transportista').value.trim(),
    patente: $('#q_patente').value.trim(),
    nave: $('#q_nave').value.trim(),
    pto_embarque: $('#q_ptoemb').value.trim(),
    pto_descarga: $('#q_ptodesc').value.trim(),
    tara_kgs: $('#q_tara').value,
    gross_kgs: $('#q_gross').value,
    class: $('#q_class').value.trim(),
    status: $('#q_status').value.trim(),
    interior_condition: $('#q_interior').value.trim()
  };
}

var bodyEl = null;
var seq = 0;
var photos = new Map();

function addRow(p){
  p = p || {};
  seq++;
  var id = seq;
  var tr = document.createElement('tr');
  tr.setAttribute('data-row', String(id));
  tr.innerHTML =
    '<td><input type="number" value="'+id+'" min="1" step="1" readonly></td>' +
    '<td><input type="text" placeholder="1/1/X or 11xXX" value="'+(p.location||'')+'"></td>' +
    '<td><input type="text" placeholder="RIC / DY..." value="'+(p.damage||'')+'"></td>' +
    '<td><input type="text" placeholder="COMP + METHOD" value="'+(p.component||'')+'"></td>' +
    '<td><input type="text" placeholder="PC / MON/10x5" value="'+(p.size||'')+'"></td>' +
    '<td><input type="number" min="0" step="1" value="'+(p.qty!==undefined?p.qty:'')+'" oninput="recalc()"></td>' +
    '<td><input type="text" value="'+(p.code||'')+'"></td>' +
    '<td><input type="number" min="0" step="0.1" value="'+(p.hh!==undefined?p.hh:'')+'" oninput="recalc()"></td>' +
    '<td><input type="number" min="0" step="0.01" value="'+(p.material!==undefined?p.material:'')+'" oninput="recalc()"></td>' +
    '<td><input type="text" placeholder="D/U/I" value="'+(p.r||'')+'"></td>' +
    '<td class="cell-photos">' +
      '<input id="file_'+id+'" type="file" accept="image/*" multiple style="display:none">' +
      '<button type="button" onclick="document.getElementById(\'file_'+id+'\').click()">Cargar fotos</button>' +
      '<div id="fc_'+id+'" class="pill" style="margin-top:6px">0 archivo(s)</div>' +
    '</td>' +
    '<td class="cell-del"><button type="button" onclick="delRow('+id+')">✕</button></td>';
  bodyEl.appendChild(tr);

  var fi = tr.querySelector('#file_'+id);
  fi.addEventListener('change', function(){
    photos.set(id, fi.files);
    $('#fc_'+id).textContent = (fi.files ? fi.files.length : 0) + ' archivo(s)';
  });
}

function delRow(id){
  var tr = bodyEl.querySelector('tr[data-row="'+id+'"]');
  if(tr){ tr.remove(); photos.delete(id); recalc(); }
}

function getLines(){
  var out = [];
  var rows = bodyEl.querySelectorAll('tr');
  for(var r=0; r<rows.length; r++){
    var tr = rows[r];
    var c = tr.querySelectorAll('input');
    out.push({
      line: Number(c[0].value||0),
      location: (c[1].value||'').trim(),
      damage: (c[2].value||'').trim(),
      component: (c[3].value||'').trim(),
      size: (c[4].value||'').trim(),
      qty: Number(c[5].value||0),
      code: (c[6].value||'').trim(),
      man_hours: Number(c[7].value||0),
      material_cost: Number(c[8].value||0),
      r: (c[9].value||'').trim(),
      hasPhotos: (photos.get(Number(tr.getAttribute('data-row')))||[]).length>0
    });
  }
  return out;
}

function getDoc(){
  var lines = getLines();
  var totals = {hh:0, mat:0};
  for(var i=0;i<lines.length;i++){
    totals.hh += lines[i].man_hours||0;
    totals.mat += lines[i].material_cost||0;
  }
  return {
    questionnaire: getQuestionnaire(),
    lines: lines,
    totals: totals,
    remarks: ($('#remarks').value||'').trim(),
    inspector: ($('#insp').value||'').trim(),
    inspector_email: ($('#insp_email').value||'').trim(),
    datetime: $('#fecha').value
  };
}

function recalc(){
  var d = getDoc();
  $('#totHH').textContent = d.totals.hh.toFixed(1);
  $('#totMat').textContent = d.totals.mat.toFixed(2);
}

/* ===================== EXPORT LOCAL ===================== */
function toCSV(data){
  var q=data.questionnaire, i, arr, rows=[], body, head;
  var headPairs=[], tailPairs=[];
  for(var k in q){ headPairs.push(k.toUpperCase()+',"' + String(q[k]).replace(/"/g,'""') + '"'); }
  var tail=[['INSPECTOR',data.inspector],['INSPECTOR_EMAIL',data.inspector_email],['DATETIME',data.datetime],['TOTAL_HH',data.totals.hh],['TOTAL_MAT',data.totals.mat],['REMARKS',data.remarks]];
  for(i=0;i<tail.length;i++){ tailPairs.push(tail[i][0]+',"' + String(tail[i][1]).replace(/"/g,'""') + '"'); }
  head=['Line','Location','Damage','ComponentMethod','SizeRepair','Qty','Code','ManHours','MaterialCost','R','HasPhotos'];
  for(i=0;i<data.lines.length;i++){
    arr=data.lines[i];
    rows.push([arr.line,arr.location,arr.damage,arr.component,arr.size,arr.qty,arr.code,arr.man_hours,arr.material_cost,arr.r,arr.hasPhotos]);
  }
  body=[head].concat(rows).map(function(a){
    return a.map(function(v){ return '"' + String(v).replace(/"/g,'""') + '"'; }).join(',');
  }).join('\n');
  return headPairs.join('\n')+'\n'+tailPairs.join('\n')+'\n\n'+body;
}
function download(name, content, mime){
  var a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([content],{type:mime}));
  a.download=name; a.click();
}

/* ===================== FRONTEND→GAS ===================== */
function fileToBase64(file){
  return new Promise(function(res, rej){
    var fr = new FileReader();
    fr.onload = function(){
      var s = String(fr.result);
      res(s.substring(s.indexOf(',')+1));
    };
    fr.onerror = rej;
    fr.readAsDataURL(file);
  });
}

async function submitToGAS(doc){
  var q = doc.questionnaire;
  var fechaBase = q.fecha ? q.fecha : (doc.datetime ? doc.datetime.slice(0,10) : new Date().toISOString().slice(0,10));

  // fotos [{name,mimeType,dataBase64,line}]
  var photosPayload = [];
  var it = photos.entries();
  for(var ent = it.next(); !ent.done; ent = it.next()){
    var rowId = ent.value[0];
    var fileList = ent.value[1];
    if(!fileList || fileList.length===0) continue;
    for(var i=0;i<fileList.length;i++){
      var f = fileList[i];
      var b64 = await fileToBase64(f);
      photosPayload.push({ name: f.name, mimeType: f.type, dataBase64: b64, line: rowId });
    }
  }

  var payload = {
    meta:  { naviera: q.naviera, fecha: fechaBase, unidad: q.container },
    form:  {
      container:q.container, folio:q.folio, estado:q.estado, tipo:q.tipo, para:q.para, naviera:q.naviera, lugar:q.lugar,
      fecha:q.fecha, hora:q.hora, vacio:q.vacio, oog:q.oog, transportista:q.transportista, patente:q.patente,
      nave:q.nave, pto_embarque:q.pto_embarque, pto_descarga:q.pto_descarga, tara_kgs:q.tara_kgs, gross_kgs:q.gross_kgs,
      class:q.class, status:q.status, interior_condition:q.interior_condition,
      inspector: doc.inspector, inspector_email: doc.inspector_email, remarks: doc.remarks, totals: doc.totals, fechaHora: doc.datetime
    },
    lines:  doc.lines,
    photos: photosPayload
  };

  var res = await fetch(GAS_URL, {
    method: 'POST',
    headers: { 'Content-Type':'text/plain;charset=utf-8' }, /* evita preflight CORS */
    body: JSON.stringify(payload)
  });
  if(!res.ok) throw new Error('HTTP '+res.status);
  var j = await res.json();
  if(!j.ok) throw new Error(j.error || 'Error en backend');
  return j;
}

/* ===================== SUBMIT ===================== */
async function submitDoc(){
  try{
    logEl.textContent = ""; log("Validando…");
    // si línea tiene datos, exigir 1 foto
    var trs = bodyEl.querySelectorAll('tr');
    for(var t=0;t<trs.length;t++){
      var tr = trs[t];
      var id = Number(tr.getAttribute('data-row'));
      var files = photos.get(id) || [];
      var c = tr.querySelectorAll('input');
      var any = false;
      for(var i=1;i<=9;i++){
        var v = c[i] ? String(c[i].value||'').trim() : '';
        if(v!==''){ any=true; break; }
      }
      if(any && files.length===0){ alert('La línea '+id+' requiere al menos 1 foto.'); return; }
    }

    var doc = getDoc();
    log("Enviando a Google Apps Script…");
    var result = await submitToGAS(doc);
    log("OK. Carpeta: " + result.folderUrl);
    alert("Enviado con éxito. Carpeta: " + result.folderUrl);
  }catch(err){
    console.error(err);
    log("ERROR: " + (err.message || err));
    alert("Error: " + (err.message || err));
  }
}

/* ===================== BOTONES + INIT ===================== */
function init(){
  logEl = $('#log');
  bodyEl = $('#body');
  $('#btnAdd').onclick = function(){ addRow(); };
  $('#btnClear').onclick = function(){ bodyEl.innerHTML=''; seq=0; addRow(); recalc(); };
  $('#btnCSV').onclick = function(){ var d=getDoc(); download('maersk_repair_'+Date.now()+'.csv', toCSV(d), 'text/csv'); };
  $('#btnJSON').onclick = function(){ var d=getDoc(); download('maersk_repair_'+Date.now()+'.json', JSON.stringify(d, null, 2), 'application/json'); };
  $('#btnSubmit').onclick = submitDoc;

  addRow(); recalc();
}
window.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
