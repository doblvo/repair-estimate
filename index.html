<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>MAERSK ‚Äî Inspecciones + Dashboard</title>

<!-- OCR fallback para el esc√°ner -->
<script defer src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>

<style>
:root{
  --brand:#0b74c7;
  --bg:#f6f8fb;
  --ink:#1f2937;
  --muted:#6b7280;
  --card:#fff;
  --line:#e5e7eb;
  --radius:14px;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  background:var(--bg);
  color:var(--ink);
  font:14px/1.35 system-ui,Segoe UI,Roboto,Helvetica,Arial;
}

/* ====== LAYOUT ====== */
.wrap{max-width:1200px;margin:0 auto;padding:16px;display:none}
body.auth-ok .wrap{display:block}

.card{
  background:var(--card);
  border:1px solid var(--line);
  border-radius:var(--radius);
  box-shadow:0 10px 30px rgba(0,0,0,.06)
}
header{
  padding:12px 14px;
  border-bottom:1px solid var(--line);
  display:flex;
  gap:12px;
  align-items:center;
  justify-content:space-between
}
header h1{margin:0;font-size:18px}
.toolbar{display:flex;flex-wrap:wrap;gap:8px}
.pill{
  display:inline-flex;
  align-items:center;
  gap:6px;
  padding:4px 10px;
  border:1px solid var(--line);
  border-radius:999px;
  font-size:12px;
  color:#334155;
  background:#fff;
  cursor:default;
  user-select:none;
}
.pill.clickable{cursor:pointer}
.pill.clickable.active{outline:2px solid var(--brand)}
.muted{color:var(--muted)}
.btn{
  border:1px solid var(--line);
  background:#fff;
  border-radius:10px;
  padding:8px 12px;
  cursor:pointer
}
.btn.primary{background:var(--brand);color:#fff;border-color:var(--brand)}
.btn.ghost{background:transparent}
.btn.danger{background:#dc2626;color:#fff;border-color:#dc2626}
.btn:disabled{opacity:.55;cursor:not-allowed}
.hide{display:none!important}
.section{padding:12px 14px}
.grid{display:grid;gap:12px}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.qcard{
  border:1px solid var(--line);
  border-radius:12px;
  padding:10px 12px;
  background:#fff
}
.qtitle{font-size:12px;color:var(--muted);margin-bottom:6px}
input[type=text],
input[type=number],
textarea,
select{
  width:100%;
  border:1px solid #dbe2ea;
  border-radius:8px;
  padding:8px 10px;
  font:inherit
}
input[type=date]{
  border:1px solid #dbe2ea;
  border-radius:8px;
  padding:6px 10px;
  font:inherit
}
input[readonly]{background:#f3f4f6}
label.inline{display:inline-flex;align-items:center;gap:6px}
.hint{font-size:12px;color:var(--muted)}
.spacer{height:10px}

/* ====== TABLA ====== */
table{width:100%;border-collapse:separate;border-spacing:0}
thead th{
  position:sticky;
  top:0;
  background:#f9fbfe;
  border-bottom:1px solid var(--line);
  font-weight:600;
  padding:8px;
  z-index:1
}
tbody td{
  border-bottom:1px dashed #eef2f7;
  padding:6px 8px;
  vertical-align:top
}
.badge{
  display:inline-block;
  padding:2px 8px;
  border-radius:999px;
  font-size:12px;
  border:1px solid #cbd5e1;
  background:#fff
}
.b-pend{border-color:#f59e0b;color:#92400e;background:#fffbeb}
.b-send{border-color:#10b981;color:#065f46;background:#ecfdf5}
.b-fail{border-color:#ef4444;color:#7f1d1d;background:#fef2f2}
.b-prog{border-color:#3b82f6;color:#1e3a8a;background:#eff6ff}

/* ====== MARCADOR L√çNEAS ====== */
.marker-btn{
  width:30px;height:30px;
  border-radius:999px;
  border:2px solid #94a3b8;
  background:#fff;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  font-weight:700;
  cursor:pointer;
  user-select:none;
  transition:all .15s ease
}
.marker-btn.active{background:#0b74c7;color:#fff;border-color:#0b74c7}

/* ====== OVERLAY / SPINNER ====== */
#overlay{
  position:fixed;
  inset:0;
  background:rgba(15,23,42,.55);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:9999;
  backdrop-filter:blur(2px)
}
.spinner{
  width:56px;height:56px;
  border-radius:50%;
  border:6px solid rgba(255,255,255,.35);
  border-top-color:#fff;
  animation:spin 1s linear infinite;
  margin:0 auto
}
@keyframes spin{to{transform:rotate(360deg)}}
.loading-card{
  background:#0b1220;
  color:#e5edf5;
  border-radius:16px;
  padding:18px 16px;
  min-width:240px;
  text-align:center;
  border:1px solid #263045
}
.loading-card p{margin:10px 0 0;font-size:14px;color:#b8c4d6}

/* ====== TOAST ====== */
#toast{
  position:fixed;
  left:12px;right:12px;bottom:12px;
  z-index:9999;
  display:none;
  padding:10px 12px;
  border-radius:10px;
  border:1px solid #dbe2ea;
  background:#ffffffcc;
  backdrop-filter:saturate(180%) blur(10px);
  box-shadow:0 8px 24px rgba(0,0,0,.08);
  font-size:14px
}

/* ====== LOGIN GATE (obligatorio) ====== */
#loginGate{
  position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
  background:var(--bg); z-index:100000;
}
.login-card{
  width:min(420px,94vw); background:#fff; border:1px solid var(--line);
  border-radius:16px; padding:18px; box-shadow:0 12px 40px rgba(0,0,0,.12)
}
.login-card h2{margin:.2rem 0 1rem}
.login-card .qtitle{font-size:12px;color:var(--muted);margin:.5rem 0 .3rem}
.login-actions{display:flex; justify-content:flex-end; gap:8px; margin-top:12px}
#lg_msg{color:#b91c1c; font-size:13px; min-height:18px}

/* ====== PAGINACI√ìN (cola) ====== */
.pager{display:flex; align-items:center; justify-content:space-between; gap:8px; margin-top:10px}
.pager .pages{display:flex; gap:6px; align-items:center; flex-wrap:wrap}
.page-btn{
  border:1px solid var(--line); background:#fff; border-radius:8px; padding:6px 10px; cursor:pointer; font-size:13px
}
.page-btn.active{background:var(--brand); color:#fff; border-color:var(--brand)}
</style>
</head>

<body>

<!-- === LOGIN GATE (obligatorio) === -->
<div id="loginGate">
  <div class="login-card">
    <h2>Acceso</h2>
    <div>
      <div class="qtitle">Usuario</div>
      <input id="lg_user" type="text" placeholder="user o admin" autofocus>
    </div>
    <div>
      <div class="qtitle">Contrase√±a</div>
      <input id="lg_pass" type="password" placeholder="Contrase√±a">
    </div>
    <div id="lg_msg"></div>
    <div class="login-actions">
      <button class="btn" id="lg_btn">Iniciar sesi√≥n</button>
    </div>
  </div>
</div>

<div class="wrap">
  <!-- ==================== UNIDADES EN COLA ==================== -->
  <div id="view-queue" class="card">
    <header>
      <h1>Unidades en cola</h1>
      <div class="toolbar">
        <span class="pill" id="userBadge">üë§ Sesi√≥n</span>
        <button class="btn" id="btnChangeUser" style="display:none">Cambiar t√©cnico/vendor</button>
        <button class="btn" id="btnNew">+ Nueva inspecci√≥n</button>
        <button class="btn primary" id="btnSendAll">Enviar todo</button>
        <!-- Bot√≥n de admin s√≥lo visible si rol=admin -->
        <button class="btn" id="btnAdminLogin" style="display:none">Iniciar admin</button>
        <button class="btn" id="btnAdminLogout" style="display:none">Cerrar sesi√≥n</button>
      </div>
    </header>

    <div class="section">
      <!-- KPIs como filtros (incluye ALL). Se marcan como .clickable -->
      <div class="row" style="justify-content:space-between;align-items:center">
        <div class="row kpi">
          <span class="pill clickable filter-pill active" data-status="all">All: <b id="kpiAll">0</b></span>
          <span class="pill clickable filter-pill" data-status="pendiente">Pendientes: <b id="kpiPend">0</b></span>
          <span class="pill clickable filter-pill" data-status="enviando">Enviando: <b id="kpiProg">0</b></span>
          <span class="pill clickable filter-pill" data-status="enviado">Enviadas: <b id="kpiOk">0</b></span>
          <span class="pill clickable filter-pill" data-status="fallido">Fallidas: <b id="kpiFail">0</b></span>
        </div>
        <div class="row">
          <input id="qSearch" type="text" placeholder="Buscar contenedor / folio‚Ä¶" style="min-width:260px"/>
          <!-- Quitamos el select de estado: los KPIs hacen de filtros -->
          <button class="btn" id="btnRetryFail">Reintentar fallidas</button>
          <button class="btn danger" id="btnClearSent">Limpiar enviadas</button>
        </div>
      </div>

      <div class="spacer"></div>

      <div style="overflow:auto">
        <table>
          <thead>
            <tr>
              <th>Fecha</th>
              <th>Contenedor</th>
              <th>Gate</th>
              <th>Naviera</th>
              <th>Da√±os</th>
              <th>Fotos</th>
              <th>Status</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="tbodyQueue"></tbody>
        </table>
      </div>

      <!-- Paginaci√≥n para la cola (usuario operador) -->
      <div class="pager" id="q_pager">
        <div class="row">
          <label class="qtitle">Per page</label>
          <select id="q_perPage" class="select">
            <option value="20" selected>20</option>
            <option value="40">40</option>
            <option value="100">100</option>
            <option value="200">200</option>
          </select>
        </div>
        <div class="pages" id="q_pages"></div>
        <div class="row">
          <span class="pill" id="q_pageInfo">Mostrando 0 de 0</span>
        </div>
      </div>
    </div>
  </div>

  <div class="spacer"></div>

  <!-- ===== La siguiente parte continuar√° con: FORMULARIO, √âXITO, ADMIN, OVERLAY/TOAST, y SCRIPTS ===== -->
</div>
<!-- ==================== FORMULARIO DE INSPECCI√ìN ==================== -->
<div id="view-form" class="card hide">
  <header>
    <h1>Nueva inspecci√≥n</h1>
    <div class="toolbar">
      <button class="btn" id="btnBackQueue">‚Üê Volver</button>
      <button class="btn" id="btnFormClear">Limpiar</button>
      <button class="btn primary" id="btnFormSave">Guardar en cola</button>
    </div>
  </header>

  <div class="section grid" style="grid-template-columns:1.2fr 1fr">
    <!-- Columna izquierda: cuestionario -->
    <div class="grid" style="grid-template-columns:1fr">
      <div class="qcard">
        <div class="qtitle">Fecha</div>
        <input type="date" id="f_date">
      </div>

      <div class="qcard">
        <div class="qtitle">Contenedor (ej. MSKU1234567)</div>
        <input type="text" id="f_cntr" placeholder="Ej: MSKU1234567" maxlength="12">
        <div class="hint">Puede usar el bot√≥n ‚ÄúEscanear‚Äù para OCR (tesseract.js).</div>
        <div class="row" style="margin-top:8px">
          <button class="btn" id="btnScan">Escanear</button>
          <input type="file" id="scanFile" accept="image/*" class="hide">
        </div>
      </div>

      <div class="qcard">
        <div class="row">
          <div style="flex:1">
            <div class="qtitle">Gate</div>
            <select id="f_gate">
              <option value="">‚Äî</option>
              <option>Gate IN</option>
              <option>Gate OUT</option>
            </select>
          </div>
          <div style="flex:1">
            <div class="qtitle">Naviera</div>
            <select id="f_line">
              <option value="">‚Äî</option>
              <option>MAERSK</option>
              <option>HAPAG-LLOYD</option>
              <option>COSCO</option>
              <option>OOCL</option>
              <option>TRANSMARES</option>
              <option>OTRA</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Da√±os din√°micos -->
      <div class="qcard">
        <div class="row" style="justify-content:space-between;align-items:center">
          <div class="qtitle">Da√±os (l√≠neas din√°micas)</div>
          <button class="btn" id="btnAddDamage">+ Agregar da√±o</button>
        </div>
        <div id="damageList"></div>
        <template id="tplDamage">
          <div class="qcard" style="margin-top:8px">
            <div class="row" style="align-items:flex-end">
              <div style="flex:1">
                <div class="qtitle">Ubicaci√≥n</div>
                <input type="text" placeholder="Ej: Panel derecho / piso / puerta">
              </div>
              <div style="flex:1">
                <div class="qtitle">C√≥digo de da√±o</div>
                <input type="text" placeholder="Ej: 1332 / 5332 / 818555E">
              </div>
              <div style="flex:.7">
                <div class="qtitle">Severidad</div>
                <select>
                  <option value="">‚Äî</option>
                  <option>Leve</option>
                  <option>Media</option>
                  <option>Grave</option>
                </select>
              </div>
              <div>
                <button class="btn" data-act="upload">Cargar fotos</button>
                <input type="file" accept="image/*" multiple class="hide">
              </div>
              <div>
                <button class="btn danger" data-act="remove">‚úï</button>
              </div>
            </div>
            <div class="hint" style="margin-top:6px">Fotos adjuntas: <span data-role="photosCount">0</span></div>
          </div>
        </template>
      </div>

      <div class="qcard">
        <div class="qtitle">Observaciones</div>
        <textarea id="f_notes" rows="3" placeholder="Notas, comentarios, particularidades‚Ä¶"></textarea>
      </div>
    </div>

    <!-- Columna derecha: resumen y acciones -->
    <aside class="grid" style="grid-template-columns:1fr">
      <div class="qcard">
        <div class="qtitle">T√©cnico / Vendor</div>
        <input id="f_vendor" type="text" placeholder="Nombre o c√≥digo de t√©cnico">
        <div class="hint">Este dato se mostrar√° junto a la sesi√≥n actual, permite reasignar.</div>
      </div>

      <div class="qcard">
        <div class="qtitle">Resumen</div>
        <div id="f_preview" class="muted">Sin datos a√∫n‚Ä¶</div>
      </div>

      <div class="qcard">
        <div class="row" style="justify-content:flex-end">
          <button class="btn" id="btnFormCancel">Cancelar</button>
          <button class="btn primary" id="btnFormQueue">Guardar en cola</button>
          <button class="btn" id="btnFormSubmit">Enviar ahora</button>
        </div>
        <div class="hint">No hay auto-refresh. Solo se env√≠a cuando presionas ‚ÄúEnviar ahora‚Äù o desde la cola ‚ÄúEnviar todo‚Äù.</div>
      </div>
    </aside>
  </div>
</div>

<div class="spacer"></div>

<!-- ==================== √âXITO ==================== -->
<div id="view-success" class="card hide">
  <header>
    <h1>Env√≠o realizado</h1>
    <div class="toolbar">
      <button class="btn primary" id="btnSuccessBack">‚Üê Volver a la cola</button>
    </div>
  </header>
  <div class="section">
    <div class="qcard">
      <p>La unidad <b id="succCntr"></b> fue enviada correctamente.</p>
      <p class="muted">Puedes revisar el estado en ‚ÄúUnidades en cola‚Äù.</p>
    </div>
  </div>
</div>

<div class="spacer"></div>

<!-- ==================== ADMIN DASHBOARD (solo lectura) ==================== -->
<div id="view-admin" class="card hide">
  <header>
    <h1>Dashboard Administrador</h1>
    <div class="toolbar">
      <button class="btn" id="btnAdminBack">‚Üê Volver</button>
      <button class="btn" id="btnAdminRefresh">Refrescar</button>
      <button class="btn" id="btnAdminOnlySent">Solo enviadas</button>
    </div>
  </header>

  <div class="section">
    <div class="row" style="justify-content:space-between;align-items:center">
      <div class="row">
        <span class="pill clickable admin-pill active" data-status="all">All: <b id="aAll">0</b></span>
        <span class="pill clickable admin-pill" data-status="pendiente">Pendientes: <b id="aPend">0</b></span>
        <span class="pill clickable admin-pill" data-status="enviando">Enviando: <b id="aProg">0</b></span>
        <span class="pill clickable admin-pill" data-status="enviado">Enviadas: <b id="aOk">0</b></span>
        <span class="pill clickable admin-pill" data-status="fallido">Fallidas: <b id="aFail">0</b></span>
      </div>
      <div class="row">
        <input id="aSearch" type="text" placeholder="Buscar contenedor / folio‚Ä¶" style="min-width:260px">
        <button class="btn" id="btnAdminExport">Exportar CSV</button>
      </div>
    </div>

    <div class="spacer"></div>

    <div style="overflow:auto">
      <table>
        <thead>
          <tr>
            <th>Fecha</th>
            <th>Contenedor</th>
            <th>Gate</th>
            <th>Naviera</th>
            <th>T√©cnico</th>
            <th>Da√±os</th>
            <th>Fotos</th>
            <th>Status</th>
            <th>Ver</th>
          </tr>
        </thead>
        <tbody id="tbodyAdmin"></tbody>
      </table>
    </div>

    <!-- Paginaci√≥n admin -->
    <div class="pager" id="a_pager">
      <div class="row">
        <label class="qtitle">Per page</label>
        <select id="a_perPage" class="select">
          <option value="20" selected>20</option>
          <option value="40">40</option>
          <option value="100">100</option>
          <option value="200">200</option>
        </select>
      </div>
      <div class="pages" id="a_pages"></div>
      <div class="row">
        <span class="pill" id="a_pageInfo">Mostrando 0 de 0</span>
      </div>
    </div>
  </div>
</div>

<!-- ==================== OVERLAY / TOAST ==================== -->
<div id="overlay">
  <div class="loading-card">
    <div class="spinner"></div>
    <p id="overlayText">Procesando‚Ä¶</p>
  </div>
</div>
<div id="toast"></div>

<!-- ==================== SCRIPTS ==================== -->
<script>
/* ---------- Config ---------- */
const CONFIG = {
  GAS_ENDPOINT: 'https://script.google.com/macros/s/AKfycbyZozDbNtG-Qt8vtLSJr93lDraU8nzdzu1N6e0RwYhBZsn7ITBP0ZCysc2cKq/exec', // REEMPLAZA si corresponde
  MAX_PHOTOS_PER_DAMAGE: 10,
  PAGE_DEFAULT: 20
};

/* ---------- Estado global ---------- */
let STATE = {
  role: 'user', // 'user' | 'admin'
  user: '',
  queue: [],        // Cola local (pendiente / enviando / enviado / fallido)
  adminData: [],    // Datos cargados para admin
  filters: {
    queueStatus: 'all',
    adminStatus: 'all',
    searchQueue: '',
    searchAdmin: ''
  },
  pager: {
    q: { page: 1, per: CONFIG.PAGE_DEFAULT },
    a: { page: 1, per: CONFIG.PAGE_DEFAULT }
  }
};

/* ---------- Utilidades ---------- */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const fmt = n => new Intl.NumberFormat('es-CL').format(n);
const todayISO = () => new Date().toISOString().slice(0,10);

function show(id){
  ['view-queue','view-form','view-success','view-admin'].forEach(v => $('#'+v).classList.add('hide'));
  $('#'+id).classList.remove('hide');
}

function toast(msg, ms=2500){
  const el = $('#toast');
  el.textContent = msg;
  el.style.display = 'block';
  setTimeout(()=> el.style.display='none', ms);
}

function overlay(showing=true, text='Procesando‚Ä¶'){
  $('#overlayText').textContent = text;
  $('#overlay').style.display = showing ? 'flex' : 'none';
}

function saveLocal(){
  localStorage.setItem('ml_queue', JSON.stringify(STATE.queue));
  localStorage.setItem('ml_user', STATE.user);
}
function loadLocal(){
  STATE.queue = JSON.parse(localStorage.getItem('ml_queue')||'[]');
  STATE.user = localStorage.getItem('ml_user') || '';
}

/* ---------- Login ---------- */
function doLogin(){
  const u = $('#lg_user').value.trim();
  const p = $('#lg_pass').value.trim();
  const okUser  = (u === 'user'  && p === 'Contopsa01');
  const okAdmin = (u === 'admin' && p === 'Maersk01');
  if(!okUser && !okAdmin){
    $('#lg_msg').textContent = 'Credenciales inv√°lidas.';
    return;
  }
  document.body.classList.add('auth-ok');
  $('#loginGate').style.display = 'none';

  STATE.role = okAdmin ? 'admin' : 'user';
  STATE.user = u;
  saveLocal();

  // Toggle botones de sesi√≥n
  $('#userBadge').textContent = `üë§ ${u}`;
  $('#btnAdminLogin').style.display  = okAdmin ? 'none' : 'inline-block';
  $('#btnAdminLogout').style.display = okAdmin ? 'inline-block' : 'none';
  $('#btnChangeUser').style.display  = 'inline-block';

  if(okAdmin){
    show('view-admin');
    adminLoad();
  }else{
    show('view-queue');
    renderQueue();
  }
}

$('#lg_btn').addEventListener('click', doLogin);
$('#lg_pass').addEventListener('keydown', e=>{ if(e.key==='Enter') doLogin(); });

/* ---------- Inicializaci√≥n ---------- */
(function init(){
  loadLocal();
  if(STATE.user){
    document.body.classList.add('auth-ok');
    $('#loginGate').style.display = 'none';
    $('#userBadge').textContent = `üë§ ${STATE.user}`;
    if(STATE.role === 'admin'){
      $('#btnAdminLogout').style.display = 'inline-block';
      show('view-admin'); adminLoad();
    }else{
      show('view-queue'); renderQueue();
    }
  } else {
    // permanece en login
  }
})();

/* ---------- Navegaci√≥n b√°sica ---------- */
$('#btnNew').addEventListener('click', ()=>{
  resetForm();
  show('view-form');
});
$('#btnBackQueue').addEventListener('click', ()=> show('view-queue'));
$('#btnFormCancel').addEventListener('click', ()=> show('view-queue'));
$('#btnSuccessBack').addEventListener('click', ()=> show('view-queue'));
$('#btnAdminBack').addEventListener('click', ()=> show('view-queue'));

/* ---------- Cambios de sesi√≥n ---------- */
$('#btnChangeUser').addEventListener('click', ()=>{
  const v = prompt('Nuevo t√©cnico/vendor (visible en formulario y cola):', STATE.user || '');
  if(v!==null){
    STATE.user = v.trim();
    $('#userBadge').textContent = `üë§ ${STATE.user}`;
    saveLocal();
  }
});
$('#btnAdminLogin').addEventListener('click', ()=>{
  overlay(true, 'Abriendo sesi√≥n admin‚Ä¶');
  setTimeout(()=>{
    overlay(false);
    toast('Usa usuario "admin" y pass "Maersk01".');
    $('#loginGate').style.display='flex';
  }, 600);
});
$('#btnAdminLogout').addEventListener('click', ()=>{
  STATE.role = 'user';
  $('#btnAdminLogout').style.display='none';
  $('#btnAdminLogin').style.display='inline-block';
  show('view-queue');
});

/* ---------- Cola (lista operario) ---------- */
function renderQueue(){
  const tbody = $('#tbodyQueue');
  tbody.innerHTML = '';

  // Filtro por texto y estado
  const text = STATE.filters.searchQueue.toLowerCase();
  const st = STATE.filters.queueStatus;

  const rows = STATE.queue.filter(r=>{
    const hit = (r.cntr||'').toLowerCase().includes(text) || (r.folio||'').toLowerCase().includes(text);
    const sOk = (st==='all') ? true : r.status===st;
    return hit && sOk;
  });

  // KPI
  const k = (status)=> rows.filter(x=>x.status===status).length;
  $('#kpiAll').textContent  = rows.length;
  $('#kpiPend').textContent = rows.filter(x=>x.status==='pendiente').length;
  $('#kpiProg').textContent = rows.filter(x=>x.status==='enviando').length;
  $('#kpiOk').textContent   = rows.filter(x=>x.status==='enviado').length;
  $('#kpiFail').textContent = rows.filter(x=>x.status==='fallido').length;

  // Paginaci√≥n
  const {page,per} = STATE.pager.q;
  const totalPages = Math.max(1, Math.ceil(rows.length / per));
  const pageClamped = Math.min(page, totalPages);
  STATE.pager.q.page = pageClamped;

  const start = (pageClamped-1)*per;
  const slice = rows.slice(start, start+per);

  slice.forEach(r=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${r.date||''}</td>
      <td>${r.cntr||''}</td>
      <td>${r.gate||''}</td>
      <td>${r.line||''}</td>
      <td>${r.damages?.length||0}</td>
      <td>${r.photosCount||0}</td>
      <td>${renderStatusBadge(r.status)}</td>
      <td>
        <div class="row">
          <button class="btn" data-act="show" data-id="${r.id}" style="padding:4px 8px">Mostrar</button>
          ${r.status!=='enviado' ? `<button class="btn primary" data-act="send" data-id="${r.id}" style="padding:4px 8px">Enviar</button>`:''}
          <button class="btn danger" data-act="del" data-id="${r.id}" style="padding:4px 8px">Borrar</button>
        </div>
      </td>`;
    tbody.appendChild(tr);
  });

  renderPager('q_pages','q_pageInfo', rows.length, pageClamped, per, (p)=>{ STATE.pager.q.page=p; renderQueue(); });
}

function renderStatusBadge(s){
  const map = {
    pendiente: 'badge b-pend',
    enviando: 'badge b-prog',
    enviado: 'badge b-send',
    fallido: 'badge b-fail'
  };
  return `<span class="${map[s]||'badge'}">${s||'‚Äî'}</span>`;
}

function renderPager(pagesId, infoId, total, page, per, onGo){
  const pagesEl = $('#'+pagesId);
  pagesEl.innerHTML = '';
  const totalPages = Math.max(1, Math.ceil(total/per));

  const mkBtn = (label, p, active=false)=> {
    const b = document.createElement('button');
    b.className = 'page-btn'+(active?' active':'');
    b.textContent = label;
    b.addEventListener('click', ()=> onGo(p));
    return b;
  };

  pagesEl.appendChild(mkBtn('¬´', 1));
  pagesEl.appendChild(mkBtn('‚Äπ', Math.max(1, page-1)));
  for(let i=1;i<=totalPages;i++){
    if(i===1 || i===totalPages || Math.abs(i-page)<=2){
      pagesEl.appendChild(mkBtn(String(i), i, i===page));
    } else if (Math.abs(i-page)===3){
      const span = document.createElement('span'); span.textContent='‚Ä¶'; span.style.margin='0 6px';
      pagesEl.appendChild(span);
    }
  }
  pagesEl.appendChild(mkBtn('‚Ä∫', Math.min(totalPages, page+1)));
  pagesEl.appendChild(mkBtn('¬ª', totalPages));

  $('#'+infoId).textContent = `Mostrando ${Math.min(total, (page-1)*per+1)}‚Äì${Math.min(total, page*per)} de ${fmt(total)}`;
}

/* Interacciones cola */
$('#qSearch').addEventListener('input', e=>{ STATE.filters.searchQueue = e.target.value; STATE.pager.q.page=1; renderQueue(); });
$('#q_perPage').addEventListener('change', e=>{ STATE.pager.q.per = +e.target.value; STATE.pager.q.page=1; renderQueue(); });
$$('.filter-pill').forEach(p=>{
  p.addEventListener('click', ()=>{
    $$('.filter-pill').forEach(x=>x.classList.remove('active'));
    p.classList.add('active');
    STATE.filters.queueStatus = p.dataset.status;
    STATE.pager.q.page=1; renderQueue();
  });
});

$('#tbodyQueue').addEventListener('click', async (e)=>{
  const btn = e.target.closest('button'); if(!btn) return;
  const act = btn.dataset.act; const id = btn.dataset.id;
  if(act==='del'){
    STATE.queue = STATE.queue.filter(x=>x.id!==id); saveLocal(); renderQueue(); toast('Eliminado de la cola.');
  } else if (act==='send'){
    const row = STATE.queue.find(x=>x.id===id);
    if(!row) return;
    await sendOne(row);
  } else if (act==='show'){
    const row = STATE.queue.find(x=>x.id===id);
    if(!row) return;
    alert(`Contenedor: ${row.cntr}\nGate: ${row.gate}\nNaviera: ${row.line}\nDa√±os: ${row.damages.length}\nFotos: ${row.photosCount}\nStatus: ${row.status}`);
  }
});

$('#btnSendAll').addEventListener('click', async ()=>{
  const pend = STATE.queue.filter(x=>x.status==='pendiente' || x.status==='fallido');
  if(!pend.length){ toast('Nada que enviar.'); return; }
  overlay(true, 'Enviando cola‚Ä¶');
  for(const r of pend){ await sendOne(r); }
  overlay(false);
  toast('Proceso de env√≠o finalizado.');
});
$('#btnRetryFail').addEventListener('click', async ()=>{
  const fails = STATE.queue.filter(x=>x.status==='fallido');
  if(!fails.length){ toast('No hay fallidas.'); return; }
  overlay(true, 'Reintentando fallidas‚Ä¶');
  for(const r of fails){ await sendOne(r); }
  overlay(false);
});
$('#btnClearSent').addEventListener('click', ()=>{
  const before = STATE.queue.length;
  STATE.queue = STATE.queue.filter(x=>x.status!=='enviado');
  saveLocal(); renderQueue();
  toast(`Limpiaste ${before - STATE.queue.length} enviadas.`);
});

/* ---------- Env√≠o (mock + GAS) ---------- */
async function sendOne(row){
  row.status = 'enviando'; renderQueue(); saveLocal();
  try{
    // Adjunta payload b√°sico:
    const payload = {...row};
    overlay(true, `Enviando ${row.cntr}‚Ä¶`);
    const res = await fetch(CONFIG.GAS_ENDPOINT, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    const ok = res.ok;
    // Si tu GAS retorna JSON con {ok:true}, puedes validarlo aqu√≠:
    row.status = ok ? 'enviado' : 'fallido';
  }catch(err){
    console.error(err);
    row.status = 'fallido';
  }finally{
    overlay(false);
    saveLocal(); renderQueue();
  }
}

/* ---------- Formulario ---------- */
function resetForm(){
  $('#f_date').value = todayISO();
  $('#f_cntr').value = '';
  $('#f_gate').value = '';
  $('#f_line').value = '';
  $('#f_vendor').value = STATE.user || '';
  $('#f_notes').value = '';
  $('#f_preview').textContent = 'Sin datos a√∫n‚Ä¶';
  $('#damageList').innerHTML = '';
}

function formToObj(){
  const damages = [];
  $$('#damageList .qcard').forEach(card=>{
    const [loc, code, sev] = card.querySelectorAll('input,select');
    const fileInput = card.querySelector('input[type=file]');
    damages.push({
      loc: loc.value.trim(),
      code: code.value.trim(),
      sev: sev.value,
      photos: Array.from(fileInput?.files||[]).map(f=>({name:f.name,size:f.size,type:f.type}))
    });
  });
  const photosCount = damages.reduce((a,d)=> a + d.photos.length, 0);
  return {
    id: 'Q'+Date.now(),
    date: $('#f_date').value,
    cntr: $('#f_cntr').value.trim().toUpperCase(),
    gate: $('#f_gate').value,
    line: $('#f_line').value,
    vendor: $('#f_vendor').value.trim(),
    damages,
    notes: $('#f_notes').value.trim(),
    photosCount,
    status:'pendiente'
  };
}

function refreshPreview(){
  const d = formToObj();
  $('#f_preview').innerHTML = `
    <div><b>${d.cntr||'‚Äî'}</b> ‚Ä¢ ${d.date||'‚Äî'} ‚Ä¢ ${d.gate||'‚Äî'} ‚Ä¢ ${d.line||'‚Äî'}</div>
    <div class="muted">Da√±os: ${d.damages.length} ‚Ä¢ Fotos: ${d.photosCount}</div>
    <div class="muted">T√©cnico: ${d.vendor||'‚Äî'}</div>
  `;
}

['#f_date','#f_cntr','#f_gate','#f_line','#f_vendor','#f_notes'].forEach(sel=>{
  $(sel).addEventListener('input', refreshPreview);
});

$('#btnAddDamage').addEventListener('click', ()=>{
  const t = $('#tplDamage').content.cloneNode(true);
  const card = t.querySelector('.qcard');
  const btnUpload = card.querySelector('button[data-act=upload]');
  const btnRemove = card.querySelector('button[data-act=remove]');
  const inputFiles = card.querySelector('input[type=file]');
  const photosCountEl = card.querySelector('[data-role=photosCount]');

  btnUpload.addEventListener('click', ()=> inputFiles.click());
  inputFiles.addEventListener('change', ()=>{
    if(inputFiles.files.length > CONFIG.MAX_PHOTOS_PER_DAMAGE){
      toast(`M√°ximo ${CONFIG.MAX_PHOTOS_PER_DAMAGE} fotos por da√±o.`);
      inputFiles.value = '';
    }
    photosCountEl.textContent = inputFiles.files.length;
    refreshPreview();
  });
  btnRemove.addEventListener('click', ()=>{ card.remove(); refreshPreview(); });

  $('#damageList').appendChild(t);
});

$('#btnFormClear').addEventListener('click', resetForm);
$('#btnFormQueue').addEventListener('click', ()=>{
  const o = formToObj();
  if(!o.cntr){ toast('Indica el contenedor.'); return; }
  STATE.queue.unshift(o);
  saveLocal();
  toast('Guardado en cola.');
  show('view-queue'); renderQueue();
});
$('#btnFormSave').addEventListener('click', ()=> $('#btnFormQueue').click());
$('#btnFormSubmit').addEventListener('click', async ()=>{
  const o = formToObj();
  if(!o.cntr){ toast('Indica el contenedor.'); return; }
  STATE.queue.unshift(o); saveLocal(); renderQueue();
  await sendOne(o);
  $('#succCntr').textContent = o.cntr;
  show('view-success');
});

/* ---------- OCR escaneo ---------- */
$('#btnScan').addEventListener('click', ()=> $('#scanFile').click());
$('#scanFile').addEventListener('change', async (e)=>{
  const file = e.target.files?.[0]; if(!file) return;
  overlay(true,'Reconociendo texto‚Ä¶');
  try{
    const img = URL.createObjectURL(file);
    const result = await Tesseract.recognize(img, 'eng');
    const text = (result?.data?.text || '').replace(/\s+/g,'').toUpperCase();
    // Heur√≠stica simple para contenedores tipo XXXX1234567
    const match = text.match(/[A-Z]{4}\d{7}/);
    if(match){ $('#f_cntr').value = match[0]; refreshPreview(); toast('Contenedor detectado.'); }
    else toast('No se detect√≥ un contenedor claro.');
  }catch(err){ console.error(err); toast('Fallo OCR.'); }
  finally{ overlay(false); }
});

/* ---------- Admin ---------- */
async function adminLoad(){
  overlay(true,'Cargando datos‚Ä¶');
  try{
    // Nota: aqu√≠ puedes traer TODO (pendientes, enviadas, fallidas) desde tu base
    // Para ejemplo, combinamos la cola local con una consulta al GAS (si lo implementas)
    const localAll = [...STATE.queue];
    let remote = [];
    try{
      const r = await fetch(CONFIG.GAS_ENDPOINT+'?list=1');
      if(r.ok) remote = await r.json(); // define tu formato [{...}]
    }catch(_){}
    // Marcar las remotas como 'enviado' si no traen status
    remote = (remote||[]).map(x=>({...x, status: x.status || 'enviado'}));
    STATE.adminData = [...remote, ...localAll]; // ejemplo: combinar
  }finally{
    overlay(false);
    renderAdmin();
  }
}

function renderAdmin(){
  const tbody = $('#tbodyAdmin');
  tbody.innerHTML = '';

  const text = STATE.filters.searchAdmin.toLowerCase();
  const st = STATE.filters.adminStatus;

  const rows = STATE.adminData.filter(r=>{
    const hit = (r.cntr||'').toLowerCase().includes(text) || (r.folio||'').toLowerCase().includes(text);
    const sOk = (st==='all') ? true : r.status===st;
    return hit && sOk;
  });

  // KPI
  $('#aAll').textContent  = rows.length;
  $('#aPend').textContent = rows.filter(x=>x.status==='pendiente').length;
  $('#aProg').textContent = rows.filter(x=>x.status==='enviando').length;
  $('#aOk').textContent   = rows.filter(x=>x.status==='enviado').length;
  $('#aFail').textContent = rows.filter(x=>x.status==='fallido').length;

  // Paginaci√≥n
  const {page,per} = STATE.pager.a;
  const totalPages = Math.max(1, Math.ceil(rows.length / per));
  const pageClamped = Math.min(page, totalPages);
  STATE.pager.a.page = pageClamped;

  const start = (pageClamped-1)*per;
  const slice = rows.slice(start, start+per);

  slice.forEach(r=>{
    const tr = document.createElement('tr');
    const damagesCount = r.damages?.length || 0;
    const photosCount = typeof r.photosCount==='number' ? r.photosCount
                      : (r.damages||[]).reduce((a,d)=> a + (d.photos?.length||0), 0);
    tr.innerHTML = `
      <td>${r.date||''}</td>
      <td>${r.cntr||''}</td>
      <td>${r.gate||''}</td>
      <td>${r.line||''}</td>
      <td>${r.vendor||''}</td>
      <td>${damagesCount}</td>
      <td>${photosCount}</td>
      <td>${renderStatusBadge(r.status)}</td>
      <td><button class="btn" data-act="view" data-id="${r.id||''}" style="padding:4px 8px">Mostrar</button></td>
    `;
    tbody.appendChild(tr);
  });

  renderPager('a_pages','a_pageInfo', rows.length, pageClamped, per, (p)=>{ STATE.pager.a.page=p; renderAdmin(); });
}

$('#a_perPage').addEventListener('change', e=>{ STATE.pager.a.per=+e.target.value; STATE.pager.a.page=1; renderAdmin(); });
$('#aSearch').addEventListener('input', e=>{ STATE.filters.searchAdmin = e.target.value; STATE.pager.a.page=1; renderAdmin(); });
$$('.admin-pill').forEach(p=>{
  p.addEventListener('click', ()=>{
    $$('.admin-pill').forEach(x=>x.classList.remove('active'));
    p.classList.add('active');
    STATE.filters.adminStatus = p.dataset.status;
    STATE.pager.a.page=1; renderAdmin();
  });
});
$('#btnAdminRefresh').addEventListener('click', adminLoad);
$('#btnAdminOnlySent').addEventListener('click', ()=>{
  STATE.filters.adminStatus = 'enviado';
  $$('.admin-pill').forEach(x=> x.classList.toggle('active', x.dataset.status==='enviado'));
  STATE.pager.a.page=1; renderAdmin();
});
$('#tbodyAdmin').addEventListener('click', (e)=>{
  const btn = e.target.closest('button'); if(!btn) return;
  if(btn.dataset.act==='view'){
    const id = btn.dataset.id;
    const r = STATE.adminData.find(x=>String(x.id)===String(id)) || {};
    alert(`(Solo lectura)\nContenedor: ${r.cntr||'‚Äî'}\nFecha: ${r.date||'‚Äî'}\nGate: ${r.gate||'‚Äî'}\nNaviera: ${r.line||'‚Äî'}\nT√©cnico: ${r.vendor||'‚Äî'}\nDa√±os: ${r.damages?.length||0}\nStatus: ${r.status||'‚Äî'}`);
  }
});

/* ---------- Acciones r√°pidas de la cola ---------- */
$('#btnNew').addEventListener('click', ()=> refreshPreview());
$('#btnBackQueue').addEventListener('click', ()=> renderQueue());

/* ---------- Hooks accesibles desde la UI ---------- */
$('#btnAdminLogin'); // ya manejado arriba
</script>

</body>
</html>
