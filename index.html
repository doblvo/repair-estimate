<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MAERSK ‚Äì Cuestionario + Repair Estimate (GAS Backend)</title>
  <!-- OCR fallback para esc√°ner -->
  <script defer src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
  <style>
    :root{ --brand:#0b74c7; --bg:#f6f8fb; --ink:#1f2937; --muted:#6b7280; --card:#fff; --line:#e5e7eb; --radius:14px }
    *{box-sizing:border-box}
    body{margin:0;padding:24px;background:var(--bg);color:var(--ink);font:14px/1.35 system-ui, Segoe UI, Roboto, Helvetica, Arial}
    .wrap{max-width:1200px;margin:0 auto}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:0 10px 30px rgba(0,0,0,.06)}
    header{padding:14px 16px;border-bottom:1px solid var(--line);display:flex;gap:12px;align-items:center;justify-content:space-between}
    header h1{margin:0;font-size:18px}
    .toolbar{display:flex;flex-wrap:wrap;gap:8px}
    button{border:1px solid var(--line);background:#fff;border-radius:10px;padding:8px 12px;cursor:pointer}
    button.primary{background:var(--brand);color:#fff;border-color:var(--brand)}
    button.ghost{background:transparent}
    button:disabled{opacity:.5;cursor:not-allowed}
    .pill{display:inline-block;padding:2px 8px;border:1px solid var(--line);border-radius:999px;font-size:12px}
    input[type="text"], input[type="number"], textarea, select{width:100%;border:1px solid #dbe2ea;border-radius:8px;padding:6px 8px;font:inherit}
    input[readonly]{background:#f3f4f6}

    .qwrap{padding:14px 16px;display:grid;gap:12px}
    .qgrid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
    .qcard{border:1px solid var(--line);border-radius:12px;padding:10px 12px;background:#fff}
    .qtitle{font-size:12px;color:var(--muted);margin-bottom:6px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .row .half{flex:1 1 48%}

    table{width:100%;border-collapse:separate;border-spacing:0}
    thead th{position:sticky;top:0;background:#f9fbfe;border-bottom:1px solid var(--line);font-weight:600;padding:8px 6px;z-index:1}
    tbody td{border-bottom:1px dashed #eef2f7;padding:4px}
    .cell-photos{width:160px}
    .cell-del{width:34px;text-align:center}

    .grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;padding:12px 16px;border-top:1px solid var(--line)}
    .grid>div label{display:block;font-size:12px;color:var(--muted);margin-bottom:4px}
    .submitbar{display:flex;gap:10px;justify-content:flex-end;padding:12px 16px;border-top:1px solid var(--line)}

    /* M√≥vil */
    @media (max-width:1000px){ .qgrid{grid-template-columns:repeat(2,1fr)} }
    @media (max-width:600px){
      body{padding:12px}
      header{flex-direction:column;align-items:flex-start;gap:6px}
      .qgrid{grid-template-columns:1fr}
      .grid{grid-template-columns:1fr}
      table{font-size:13px}
      .cell-photos{width:140px}
      .submitbar{justify-content:stretch}
      .submitbar button{flex:1}
    }

    #log{white-space:pre-wrap;background:#0b1220;color:#cbd5e1;padding:12px;border-radius:10px;margin:12px;max-height:220px;overflow:auto}

    /* Overlay de carga */
    #overlay{ position:fixed; inset:0; background:rgba(15,23,42,.55);
      display:none; align-items:center; justify-content:center; z-index:9999; backdrop-filter: blur(2px); }
    .spinner{ width:56px; height:56px; border-radius:50%;
      border:6px solid rgba(255,255,255,.35); border-top-color:#fff; animation:spin 1s linear infinite; margin:0 auto; }
    @keyframes spin{to{transform:rotate(360deg)}}
    .loading-card{ background:#0b1220; color:#e5edf5; border-radius:16px; padding:18px 16px; min-width:240px; text-align:center; border:1px solid #263045 }
    .loading-card p{ margin:10px 0 0 0; font-size:14px; color:#b8c4d6 }

    /* Vista de √©xito */
    #view-done{display:none}
    .done-wrap{padding:28px 20px;text-align:center}
    .done-emoji{font-size:44px;line-height:1;margin-bottom:6px}
    .done-title{font-size:18px;font-weight:700;margin:4px 0 8px}
    .done-sub{color:var(--muted);margin:0 0 16px}
    .done-actions{display:flex;gap:10px;flex-wrap:wrap;justify-content:center}
    .done-actions a, .done-actions button{min-width:180px}

    /* Toast sutil */
    #toast{ position:fixed; left:12px; right:12px; bottom:12px; z-index:9999;
      display:none; padding:10px 12px; border-radius:10px; border:1px solid #dbe2ea; background:#ffffffcc;
      backdrop-filter:saturate(180%) blur(10px); box-shadow:0 8px 24px rgba(0,0,0,.08); font-size:14px }

    /* Vista START (pre-buscador) */
    #view-start{display:block}
    .start-wrap{padding:18px 16px; display:grid; gap:12px}
    .start-row{display:flex;gap:8px}
    .start-row input{flex:1; text-transform:uppercase; letter-spacing:.5px}
    .hint{font-size:12px;color:var(--muted);margin-top:6px}

    /* Scanner modal */
    #scanModal{ position:fixed; inset:0; background:rgba(0,0,0,.8); display:none; z-index:9998; align-items:center; justify-content:center; }
    .scan-card{ background:#0b1220; color:#e5edf5; border:1px solid #263045; border-radius:16px; padding:12px; width:min(520px,94vw); }
    .scan-head{ display:flex; align-items:center; justify-content:space-between; gap:8px; padding:6px 2px 10px }
    .scan-body{ display:grid; gap:8px }
    .scan-vid{ width:100%; border-radius:12px; background:#000 }
    .scan-actions{ display:flex; gap:8px; justify-content:flex-end; padding-top:6px }
    .scan-actions button{ flex:1 }

    /* Tabla: anchos por columna */
    td.td-loc  input{ max-width:80px  }
    td.td-dano input{ max-width:90px  }
    td.td-comp input{ min-width:160px } /* igual */
    td.td-mrep input{ max-width:90px  }
    td.td-size input{ max-width:120px }
    td.td-qty  input{ min-width:150px; font-size:16px } /* m√°s grande + evitar zoom */
    td.td-resp input{ min-width:170px; font-size:16px } /* m√°s grande + evitar zoom */

    /* Bot√≥n marcador circular "R" */
    .marker-btn{
      width:30px;height:30px;border-radius:999px;border:2px solid #94a3b8;background:#fff;
      display:inline-flex;align-items:center;justify-content:center;font-weight:700;cursor:pointer;
      user-select:none;transition:all .15s ease;
    }
    .marker-btn.active{background:#0b74c7;color:#fff;border-color:#0b74c7}
  </style>
</head>
<body>
<div class="wrap card">

  <!-- VISTA START: pre-buscador -->
  <div id="view-start">
    <header>
      <h1>Pre ingreso</h1>
      <div class="toolbar"><span class="pill">Paso 1</span></div>
    </header>
    <div class="start-wrap">
      <div class="qcard">
        <div class="qtitle">Container ID</div>
        <div class="start-row">
          <input id="start_unit" type="text" inputmode="latin" autocomplete="off" maxlength="11" placeholder="EJ: MSKU1549768" />
          <button id="btnStartSearch" class="primary" type="button" title="Validar">üîé</button>
          <button id="btnStartScan" class="ghost" type="button" title="Escanear">üì∑</button>
          <button id="btnStartProceed" class="ghost" type="button" title="Continuar" style="display:none">‚úèÔ∏è</button>
          <input id="start_file" type="file" accept="image/*" capture="environment" style="display:none">
        </div>
        <div class="hint">11 caracteres (4 letras + 7 d√≠gitos). Sin guiones. Si el DV no coincide, podr√°s continuar igual.</div>
      </div>

      <div class="qcard">
        <div class="qtitle">Gate</div>
        <div class="row">
          <label><input type="radio" name="start_gate" value="GATE IN"> GATE IN</label>
          <label><input type="radio" name="start_gate" value="GATE OUT"> GATE OUT</label>
        </div>
      </div>

      <div class="qcard">
        <div class="qtitle">Fecha</div>
        <div class="row"><input id="start_fecha" type="date"></div>
      </div>

      <div class="qcard">
        <div class="qtitle">Folio</div>
        <div class="row"><input id="start_folio" type="text"></div>
      </div>

      <div class="qcard">
        <div class="qtitle">Tipo</div>
        <div class="row">
          <select id="start_tipo">
            <option>20 DRY</option><option selected>40 DRY</option><option>40 HC</option><option>20 RF</option><option>40 RF</option>
          </select>
        </div>
      </div>
    </div>
  </div>

  <!-- VISTA FORMULARIO -->
  <div id="view-form" style="display:none">
    <header>
      <h1>MAERSK ‚Äî Cuestionario</h1>
      <div class="toolbar">
        <button id="btnCSV" type="button">Exportar CSV</button>
        <button id="btnJSON" type="button">Exportar JSON</button>
      </div>
    </header>

    <!-- CUESTIONARIO -->
    <section class="qwrap">
      <div class="qgrid">
        <div class="qcard"><div class="qtitle">Container N¬∫</div><div class="row"><input id="q_container" type="text" readonly></div></div>
        <div class="qcard"><div class="qtitle">Folio</div><div class="row"><input id="q_folio" type="text" readonly></div></div>
        <div class="qcard"><div class="qtitle">Tipo</div><div class="row"><input id="q_tipo" type="text" readonly></div></div>

        <!-- Muevo Gate y Fecha inmediatamente ac√° -->
        <div class="qcard"><div class="qtitle">Gate</div><div class="row"><input id="q_gate" type="text" readonly></div></div>
        <div class="qcard"><div class="qtitle">Fecha</div><div class="row"><input id="q_fecha" type="date" readonly></div></div>

        <div class="qcard"><div class="qtitle">Estado</div><div class="row">
          <label><input type="radio" name="q_estado" value="B"> B</label>
          <label><input type="radio" name="q_estado" value="M"> M</label>
          <span class="pill">(opcional)</span>
        </div></div>

        <div class="qcard"><div class="qtitle">Para</div><div class="row">
          <label><input type="radio" name="q_para" value="EXP"> EXP</label>
          <label><input type="radio" name="q_para" value="IMP"> IMP</label>
          <label><input type="radio" name="q_para" value="CFS"> CFS</label>
          <span class="pill">(opcional)</span>
        </div></div>

        <div class="qcard"><div class="qtitle">Naviera</div><div class="row">
          <select id="q_naviera">
            <option>MAERSK</option><option>HAPAG-LLOYD</option><option>COSCO</option><option>TRANSMARES</option><option>OOCL</option><option>OTRA</option>
          </select>
        </div></div>

        <div class="qcard"><div class="qtitle">Lugar</div><div class="row"><input id="q_lugar" type="text"></div></div>

        <div class="qcard"><div class="qtitle">Vacio</div><div class="row">
          <label><input type="radio" name="q_vacio" value="S"> S</label>
          <label><input type="radio" name="q_vacio" value="N"> N</label>
          <span class="pill">(opcional)</span>
        </div></div>

        <div class="qcard"><div class="qtitle">OOG</div><div class="row">
          <label><input type="radio" name="q_oog" value="S"> S</label>
          <label><input type="radio" name="q_oog" value="N"> N</label>
          <span class="pill">(opcional)</span>
        </div></div>

        <div class="qcard"><div class="qtitle">Transportista</div><div class="row"><input id="q_transportista" type="text"></div></div>
        <div class="qcard"><div class="qtitle">Patente Cami√≥n</div><div class="row"><input id="q_patente" type="text"></div></div>
        <div class="qcard"><div class="qtitle">Nave</div><div class="row"><input id="q_nave" type="text"></div></div>
        <div class="qcard"><div class="qtitle">Pto Embarque / Descarga</div><div class="row"><input id="q_ptoemb" class="half" type="text"><input id="q_ptodesc" class="half" type="text"></div></div>
        <div class="qcard"><div class="qtitle">Tara / Gross (KGS)</div><div class="row"><input id="q_tara" class="half" type="number" step="0.01"><input id="q_gross" class="half" type="number" step="0.01"></div></div>
        <div class="qcard"><div class="qtitle">Class / Status</div><div class="row"><input id="q_class" class="half" type="text"><input id="q_status" class="half" type="text"></div></div>
        <div class="qcard"><div class="qtitle">Interior Condition</div><div class="row"><input id="q_interior" type="text"></div></div>
      </div>
    </section>

    <!-- REPAIR ESTIMATE -->
    <header>
      <h1>REPAIR ESTIMATE ‚Äî l√≠neas din√°micas</h1>
      <div class="toolbar">
        <button id="btnAdd" class="primary" type="button">+ Agregar l√≠nea</button>
        <button id="btnClear" class="ghost" type="button">Vaciar l√≠neas</button>
      </div>
    </header>

    <div style="overflow:auto;">
      <table id="tabla">
        <thead>
          <tr>
            <th style="width:44px">‚úì</th>
            <th style="min-width:90px">Loc</th>
            <th style="min-width:90px">Da√±o</th>
            <th style="min-width:160px">Comp</th>
            <th style="min-width:100px">M. Rep</th>
            <th style="min-width:120px">Size</th>
            <th style="width:150px">Qty</th>
            <th style="width:170px">Resp</th>
            <th class="cell-photos">Cargar fotos</th>
            <th class="cell-del"></th>
          </tr>
        </thead>
        <tbody id="body"></tbody>
      </table>
    </div>

    <div class="grid">
      <div><label>Remarks</label><textarea id="remarks" rows="3"></textarea></div>
      <div><label>Nombre T√©cnico</label><input id="insp" type="text" /></div>
      <div><label>Vendor</label><input id="insp_email" type="text" /></div>
      <!-- (Quitado) Fecha / Lugar -->
    </div>

    <div class="submitbar">
      <button id="btnSubmit" class="primary" type="button">Submit</button>
    </div>

    <div id="log"></div>
  </div>

  <!-- VISTA √âXITO -->
  <div id="view-done" style="display:none">
    <header>
      <h1>Enviado correctamente</h1>
      <div class="toolbar"><span class="pill">‚úÖ Listo</span></div>
    </header>
    <div class="done-wrap">
      <div class="done-emoji">‚úÖ</div>
      <div class="done-title">Tu inspecci√≥n fue enviada</div>
      <p class="done-sub" id="done-sub">Puedes iniciar otra cuando quieras.</p>
      <div class="done-actions">
        <button id="btnAnother" class="primary" type="button">Enviar otra inspecci√≥n</button>
        <a id="btnFolder" class="ghost" target="_blank" rel="noopener">Abrir carpeta</a>
      </div>
    </div>
  </div>
</div>

<!-- Overlay de carga -->
<div id="overlay" role="alert" aria-live="polite" aria-busy="true">
  <div class="loading-card">
    <div class="spinner" aria-hidden="true"></div>
    <p>Enviando‚Ä¶</p>
  </div>
</div>

<!-- Scanner modal -->
<div id="scanModal">
  <div class="scan-card">
    <div class="scan-head">
      <strong>Escanear contenedor</strong>
      <button id="scanClose" type="button">Cerrar</button>
    </div>
    <div class="scan-body">
      <video id="scanVideo" class="scan-vid" playsinline></video>
      <div class="scan-actions">
        <button id="scanCapture" class="ghost" type="button">Capturar</button>
        <button id="scanUse" class="primary" type="button">Usar</button>
      </div>
      <div class="hint">Apunta al ID (texto/c√≥digo). Si no detecta, ‚ÄúUsar‚Äù intentar√° OCR del fotograma.</div>
    </div>
  </div>
</div>

<!-- Toast -->
<div id="toast"></div>

<script>
/* ===================== CONFIG (GAS BACKEND) ===================== */
var GAS_URL = 'https://script.google.com/macros/s/AKfycbyZozDbNtG-Qt8vtLSJr93lDraU8nzdzu1N6e0RwYhBZsn7ITBP0ZCysc2cKqP99DRmmg/exec';

/* ===================== UTIL/UI ===================== */
function $(q, el){ return (el||document).querySelector(q); }
var logEl = null;
function log(m){ if(!logEl) return; logEl.textContent += m + "\n"; logEl.scrollTop = logEl.scrollHeight; }

var toastTimer=null;
function showToast(msg, ms){
  var t = $('#toast'); if(!t) return;
  t.textContent = msg; t.style.display = 'block';
  clearTimeout(toastTimer);
  toastTimer = setTimeout(function(){ t.style.display='none'; }, ms||2600);
}
function showView(which){
  $('#view-start').style.display = (which==='start') ? 'block' : 'none';
  $('#view-form' ).style.display = (which==='form')  ? 'block' : 'none';
  $('#view-done' ).style.display = (which==='done')  ? 'block' : 'none';
}
function setLoading(on){
  var ov = $('#overlay');
  var btns = document.querySelectorAll('button');
  for(var i=0;i<btns.length;i++){ btns[i].disabled = !!on; }
  ov.style.display = on ? 'flex' : 'none';
}

/* ===================== ISO 6346 (11 chars, sin guiones; DV no bloquea) ===================== */
var ISO_MAP = {A:10,B:12,C:13,D:14,E:15,F:16,G:17,H:18,I:19,J:20,K:21,L:23,M:24,N:25,O:26,P:27,Q:28,R:29,S:30,T:31,U:32,V:34,W:35,X:36,Y:37,Z:38};
function isoVal(ch){ return /[0-9]/.test(ch) ? Number(ch) : (ISO_MAP[ch]||NaN); }
function isoCheckDigit(ownerCatSerial10){ var s=ownerCatSerial10.toUpperCase(),sum=0; for(var i=0;i<10;i++){ sum+= isoVal(s[i]) * Math.pow(2,i);} var r=sum%11; return (r%10); }
function isoClean(s){ return (s||"").toUpperCase().replace(/[^A-Z0-9]/g,"").trim(); }
function isoPattern11(s){ return /^[A-Z]{4}[0-9]{7}$/.test(s); } // 11 sin guiones

/* ===================== PRE-BUSCADOR ===================== */
function handleStartSearch(){
  var el = $('#start_unit');
  var raw = isoClean(el.value);

  if (raw.length !== 11){
    $('#btnStartProceed').style.display = 'none';
    showToast('Debe tener 11 caracteres (4 letras + 7 d√≠gitos).', 2600);
    return;
  }
  if (!isoPattern11(raw)){
    $('#btnStartProceed').style.display = 'none';
    showToast('Formato inv√°lido. Ej: MSKU1549768', 2600);
    return;
  }

  var expected = isoCheckDigit(raw.slice(0,10));
  if (Number(raw[10]) !== expected){
    showToast('DV esperado: '+expected+' (continuar de todas formas)', 2800);
  } else {
    showToast('Unidad v√°lida ‚úì', 1800);
  }
  el.value = raw;
  $('#btnStartProceed').style.display = 'inline-block';
}

function handleStartProceed(){
  // volcamos valores de inicio al formulario (readonly)
  $('#q_container').value = isoClean($('#start_unit').value);
  $('#q_folio').value = ($('#start_folio').value||'').trim();
  $('#q_tipo').value = $('#start_tipo').value;
  $('#q_gate').value = (document.querySelector('input[name="start_gate"]:checked')||{value:""}).value || "";
  $('#q_fecha').value = $('#start_fecha').value || "";
  showView('form');
}

/* ===================== Scanner en vivo (BarcodeDetector + fallback OCR) ===================== */
var scanStream=null, scanLoopOn=false, scanCandidate=null, barcodeSupported=false;

async function startScanner(){
  try{
    barcodeSupported = ('BarcodeDetector' in window);
    $('#scanModal').style.display = 'flex';
    const constraints = { video: { facingMode: { ideal: 'environment' } }, audio:false };
    scanStream = await navigator.mediaDevices.getUserMedia(constraints);
    const video = $('#scanVideo');
    video.srcObject = scanStream;
    await video.play();

    scanCandidate = null;
    scanLoopOn = true;
    if(barcodeSupported){
      const detector = new BarcodeDetector({ formats:['code_128','qr_code','code_39','itf','ean_13','ean_8','upc_a','upc_e'] });
      const loop = async ()=>{
        if(!scanLoopOn) return;
        try{
          const codes = await detector.detect(video);
          if(codes && codes.length){
            const raw = codes[0].rawValue || '';
            const m = (raw.toUpperCase().match(/[A-Z]{4}\d{7}/)||[])[0];
            if(m){
              scanCandidate = m;
              showToast('Detectado: '+m, 1400);
            }
          }
        }catch(e){}
        requestAnimationFrame(loop);
      };
      loop();
    }else{
      showToast('Esc√°ner nativo no disponible. Usa ‚ÄúUsar‚Äù para OCR.', 2800);
    }
  }catch(err){
    console.error(err);
    $('#scanModal').style.display='none';
    showToast('No se pudo abrir la c√°mara (revisa permisos).', 3000);
  }
}

function stopScanner(){
  scanLoopOn=false;
  try{
    const v = $('#scanVideo');
    if(v){ v.pause(); v.srcObject=null; }
    if(scanStream){ scanStream.getTracks().forEach(t=>t.stop()); scanStream=null; }
  }catch(e){}
  $('#scanModal').style.display='none';
}

async function ocrCurrentFrame(){
  const video = $('#scanVideo');
  const canvas = document.createElement('canvas');
  canvas.width = video.videoWidth || 1280;
  canvas.height= video.videoHeight|| 720;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(video, 0,0, canvas.width, canvas.height);
  const dataURL = canvas.toDataURL('image/jpeg', 0.9);
  const worker = Tesseract;
  const res = await worker.recognize(dataURL, 'eng', { logger:()=>{} });
  const text = (res && res.data && res.data.text ? res.data.text : '') || '';
  const match = text.toUpperCase().match(/[A-Z]{4}\d{7}/);
  return match ? match[0] : null;
}

async function scanUse(){
  try{
    if(!scanCandidate){
      showToast('Intentando OCR‚Ä¶', 1200);
      scanCandidate = await ocrCurrentFrame();
    }
    if(scanCandidate){
      $('#start_unit').value = scanCandidate;
      stopScanner();
      handleStartSearch();
    }else{
      showToast('No se detect√≥. Ac√©rcate m√°s o usa ‚ÄúCapturar‚Äù.', 2600);
    }
  }catch(err){
    console.error(err);
    showToast('Error en OCR.', 2500);
  }
}

async function scanCapture(){
  try{
    showToast('Procesando OCR‚Ä¶', 1200);
    const id = await ocrCurrentFrame();
    if(id){
      scanCandidate = id;
      showToast('Detectado: '+scanCandidate, 1500);
    }else{
      showToast('No se detect√≥ un ID en la captura.', 2500);
    }
  }catch(err){
    console.error(err);
    showToast('Error en OCR.', 2500);
  }
}

/* ===================== Radios des-seleccionables ===================== */
document.addEventListener('click', function(ev){
  if(ev.target && ev.target.matches('input[type="radio"]')){
    var r = ev.target;
    if(r._was){ r.checked=false; r._was=false; }
    else{
      var list = document.querySelectorAll('input[name="' + r.name + '"]');
      for(var i=0;i<list.length;i++){ list[i]._was=false; }
      r._was=true;
    }
  }
});

/* ===================== CUESTIONARIO/REPAIR ===================== */
function getRadio(name){
  var el = document.querySelector('input[name="'+name+'"]:checked');
  return el ? el.value : "";
}
function getQuestionnaire(){
  return {
    // de la vista start (readonly en form)
    container: $('#q_container').value.trim(),
    folio: $('#q_folio').value.trim(),
    tipo: $('#q_tipo').value,
    gate: $('#q_gate').value,
    fecha: $('#q_fecha').value,

    // del resto del formulario
    estado: getRadio('q_estado'),
    para: getRadio('q_para'),
    naviera: $('#q_naviera').value,
    lugar: $('#q_lugar').value.trim(),
    vacio: getRadio('q_vacio'),
    oog: getRadio('q_oog'),
    transportista: $('#q_transportista').value.trim(),
    patente: $('#q_patente').value.trim(),
    nave: $('#q_nave').value.trim(),
    pto_embarque: $('#q_ptoemb').value.trim(),
    pto_descarga: $('#q_ptodesc').value.trim(),
    tara_kgs: $('#q_tara').value,
    gross_kgs: $('#q_gross').value,
    class: $('#q_class').value.trim(),
    status: $('#q_status').value.trim(),
    interior_condition: $('#q_interior').value.trim()
  };
}

var bodyEl = null;
var seq = 0;
var photos = new Map();

function toggleMarker(btn){
  var on = btn.classList.toggle('active');
  btn.textContent = on ? 'R' : '';
  var tr = btn.closest('tr');
  if(tr) tr.setAttribute('data-reparado', on ? '1' : '0');
}

function addRow(p){
  p = p || {};
  seq++;
  var id = seq;
  var tr = document.createElement('tr');
  tr.setAttribute('data-row', String(id));
  tr.setAttribute('data-reparado', p.reparado ? '1' : '0');

  tr.innerHTML =
    '<td style="text-align:center">' +
      '<button class="marker-btn'+(p.reparado?' active':'')+'" type="button">'+(p.reparado?'R':'')+'</button>' +
    '</td>' +
    '<td class="td-loc"><input type="text" value="'+(p.location||'')+'"></td>' +
    '<td class="td-dano"><input type="text" value="'+(p.damage||'')+'"></td>' +
    '<td class="td-comp"><input type="text" value="'+(p.component||'')+'"></td>' +
    '<td class="td-mrep"><input type="text" value="'+(p.method||'')+'"></td>' +
    '<td class="td-size"><input type="text" value="'+(p.size||'')+'"></td>' +
    '<td class="td-qty"><input type="number" inputmode="numeric" pattern="[0-9]*" min="0" step="1" value="'+(p.qty!==undefined?p.qty:'')+'"></td>' +
    '<td class="td-resp"><input type="text" value="'+(p.resp||'')+'"></td>' +
    '<td class="cell-photos">' +
      '<input id="file_'+id+'" type="file" accept="image/*" capture="environment" multiple style="display:none">' +
      '<button id="btnf_'+id+'" type="button">Cargar fotos</button>' +
      '<div id="fc_'+id+'" class="pill" style="margin-top:6px">0 archivo(s)</div>' +
    '</td>' +
    '<td class="cell-del"><button id="btndel_'+id+'" type="button">‚úï</button></td>';

  bodyEl.appendChild(tr);

  tr.querySelector('.marker-btn').addEventListener('click', function(){ toggleMarker(this); });
  var fi   = tr.querySelector('#file_'+id);
  var btnf = tr.querySelector('#btnf_'+id);
  btnf.addEventListener('click', function(){ fi.click(); });
  fi.addEventListener('change', function(){
    photos.set(id, fi.files);
    $('#fc_'+id).textContent = (fi.files ? fi.files.length : 0) + ' archivo(s)';
  });
  tr.querySelector('#btndel_'+id).addEventListener('click', function(){ tr.remove(); photos.delete(id); });
}

function getLines(){
  var out = [];
  var rows = bodyEl.querySelectorAll('tr');
  for(var r=0; r<rows.length; r++){
    var tr = rows[r];
    var c = tr.querySelectorAll('input');
    out.push({
      line: r+1,
      marker: tr.querySelector('.marker-btn').classList.contains('active') ? 'R' : '',
      reparado: tr.getAttribute('data-reparado') === '1',
      location: (c[0].value||'').trim(),   // Loc
      damage: (c[1].value||'').trim(),     // Da√±o
      component: (c[2].value||'').trim(),  // Comp
      method: (c[3].value||'').trim(),     // M. Rep
      size: (c[4].value||'').trim(),       // Size
      qty: Number(c[5].value||0),          // Qty
      resp: (c[6].value||'').trim(),       // Resp
      hasPhotos: (photos.get(Number(tr.getAttribute('data-row')))||[]).length>0
    });
  }
  return out;
}

function getDoc(){
  return {
    questionnaire: getQuestionnaire(),
    lines: getLines(),
    totals: {}, // sin HH/MAT
    remarks: ($('#remarks').value||'').trim(),
    inspector: ($('#insp').value||'').trim(),
    vendor: ($('#insp_email').value||'').trim(), // renombrado
    datetime: '' // ya no usamos hora/lugar
  };
}

/* ===================== EXPORT LOCAL ===================== */
function toCSV(data){
  var q=data.questionnaire, i, arr, rows=[], body, head;
  var headPairs=[], tailPairs=[];
  for(var k in q){ headPairs.push(k.toUpperCase()+',"' + String(q[k]).replace(/"/g,'""') + '"'); }
  var tail=[['INSPECTOR',data.inspector],['VENDOR',data.vendor],['REMARKS',data.remarks]];
  for(i=0;i<tail.length;i++){ tailPairs.push(tail[i][0]+',"' + String(tail[i][1]).replace(/"/g,'""') + '"'); }
  head=['Line','Marker','Reparado','Loc','Da√±o','Comp','MRep','Size','Qty','Resp','HasPhotos'];
  var lines = data.lines;
  for(i=0;i<lines.length;i++){
    arr=lines[i];
    rows.push([arr.line,arr.marker,arr.reparado,arr.location,arr.damage,arr.component,arr.method,arr.size,arr.qty,arr.resp,arr.hasPhotos]);
  }
  body=[head].concat(rows).map(function(a){
    return a.map(function(v){ return '"' + String(v).replace(/"/g,'""') + '"'; }).join(',');
  }).join('\n');
  return headPairs.join('\n')+'\n'+tailPairs.join('\n')+'\n\n'+body;
}
function download(name, content, mime){
  var a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([content],{type:mime}));
  a.download=name; a.click();
}

/* ===================== FRONTEND‚ÜíGAS ===================== */
function fileToBase64(file){
  return new Promise(function(res, rej){
    var fr = new FileReader();
    fr.onload = function(){ var s = String(fr.result); res(s.substring(s.indexOf(',')+1)); };
    fr.onerror = rej;
    fr.readAsDataURL(file);
  });
}
async function submitToGAS(doc){
  var q = doc.questionnaire;
  var fechaBase = q.fecha || new Date().toISOString().slice(0,10);

  var photosPayload = [];
  for(const [rowId, fileList] of photos.entries()){
    if(!fileList || fileList.length===0) continue;
    for(var i=0;i<fileList.length;i++){
      var f = fileList[i];
      var b64 = await fileToBase64(f);
      photosPayload.push({ name: f.name, mimeType: f.type, dataBase64: b64, line: rowId });
    }
  }

  var payload = {
    meta:  { naviera: q.naviera, fecha: fechaBase, unidad: q.container },
    form:  {
      container:q.container, folio:q.folio, tipo:q.tipo, gate:q.gate, fecha:q.fecha,
      estado:q.estado, para:q.para, naviera:q.naviera, lugar:q.lugar,
      vacio:q.vacio, oog:q.oog, transportista:q.transportista, patente:q.patente,
      nave:q.nave, pto_embarque:q.pto_embarque, pto_descarga:q.pto_descarga, tara_kgs:q.tara_kgs, gross_kgs:q.gross_kgs,
      class:q.class, status:q.status, interior_condition:q.interior_condition,
      inspector: doc.inspector, vendor: doc.vendor, remarks: doc.remarks
    },
    lines:  doc.lines,
    photos: photosPayload
  };

  var res = await fetch(GAS_URL, {
    method: 'POST',
    headers: { 'Content-Type':'text/plain;charset=utf-8' }, /* evita preflight CORS */
    body: JSON.stringify(payload)
  });
  if(!res.ok) throw new Error('HTTP '+res.status);
  var j = await res.json();
  if(!j.ok) throw new Error(j.error || 'Error en backend');
  return j;
}

/* ===================== SUBMIT ===================== */
async function submitDoc(){
  try{
    logEl.textContent = ""; log("Validando‚Ä¶");
    // Si l√≠nea tiene datos, exigir 1 foto
    var trs = bodyEl.querySelectorAll('tr');
    for(var t=0;t<trs.length;t++){
      var tr = trs[t];
      var id = Number(tr.getAttribute('data-row'));
      var files = photos.get(id) || [];
      var c = tr.querySelectorAll('input');
      var any = false;
      for(var i=0;i<=6;i++){ // 0..6 = loc, da√±o, comp, mrep, size, qty, resp
        var v = c[i] ? String(c[i].value||'').trim() : '';
        if(v!==''){ any=true; break; }
      }
      if(any && files.length===0){
        showToast('La l√≠nea '+(t+1)+' requiere al menos 1 foto.', 3000);
        return;
      }
    }

    setLoading(true);
    log("Enviando a Google Apps Script‚Ä¶");
    var result = await submitToGAS(getDoc());
    log("OK. Carpeta: " + result.folderUrl);

    var folderBtn = $('#btnFolder');
    if(result.folderUrl){ folderBtn.href = result.folderUrl; folderBtn.style.display='inline-block'; }
    else { folderBtn.removeAttribute('href'); folderBtn.style.display='none'; }

    showView('done');
    showToast('Enviado correctamente ‚úÖ', 2200);
  }catch(err){
    console.error(err);
    log("ERROR: " + (err.message || err));
    showToast('Error al enviar: ' + (err.message || err), 4000);
  }finally{
    setLoading(false);
  }
}

/* ===================== RESET PARA OTRA INSPECCI√ìN ===================== */
function resetAll(){
  // limpiar start
  $('#start_unit').value = '';
  $('#start_folio').value = '';
  $('#start_fecha').value = '';
  $('#btnStartProceed').style.display = 'none';
  var gates = document.querySelectorAll('input[name="start_gate"]');
  gates.forEach(g=>{ g.checked=false; g._was=false; });

  // limpiar formulario
  var inputs = document.querySelectorAll('#view-form input[type="text"], #view-form input[type="number"], #view-form input[type="date"], #view-form textarea');
  for(var i=0;i<inputs.length;i++){ inputs[i].value=''; }
  var radios = document.querySelectorAll('#view-form input[type="radio"]');
  for(var r=0;r<radios.length;r++){ radios[r].checked=false; radios[r]._was=false; }

  // limpiar l√≠neas
  bodyEl.innerHTML=''; seq=0; photos.clear(); addRow();
  logEl.textContent = "";
  showView('start');
}

/* ===================== BOTONES + INIT ===================== */
function init(){
  logEl = $('#log');
  bodyEl = $('#body');

  // Start view
  $('#btnStartSearch').onclick = handleStartSearch;
  $('#btnStartProceed').onclick = handleStartProceed;
  $('#btnStartScan').onclick = startScanner;

  // Scanner modal events
  $('#scanClose').onclick = function(){ stopScanner(); };
  $('#scanUse').onclick = scanUse;
  $('#scanCapture').onclick = scanCapture;

  // Form view
  $('#btnAdd').onclick   = function(){ addRow(); };
  $('#btnClear').onclick = function(){ bodyEl.innerHTML=''; seq=0; photos.clear(); addRow(); };
  $('#btnCSV').onclick   = function(){ var d=getDoc(); download('maersk_repair_'+Date.now()+'.csv', toCSV(d), 'text/csv'); };
  $('#btnJSON').onclick  = function(){ var d=getDoc(); download('maersk_repair_'+Date.now()+'.json', JSON.stringify(d, null, 2), 'application/json'); };
  $('#btnSubmit').onclick= submitDoc;
  $('#btnAnother').onclick = resetAll;

  // Primera fila
  addRow();

  showView('start');
}
window.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
