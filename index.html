<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>MAERSK ‚Äî Inspecciones + Dashboard</title>

<!-- OCR fallback para el esc√°ner -->
<script defer src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>

<style>
  :root{ --brand:#0b74c7; --bg:#f6f8fb; --ink:#1f2937; --muted:#6b7280; --card:#fff; --line:#e5e7eb; --radius:14px }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.35 system-ui, Segoe UI, Roboto, Helvetica, Arial}
  .wrap{max-width:1200px;margin:0 auto;padding:16px}

  .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:0 10px 30px rgba(0,0,0,.06)}
  header{padding:12px 14px;border-bottom:1px solid var(--line);display:flex;gap:12px;align-items:center;justify-content:space-between}
  header h1{margin:0;font-size:18px}
  .toolbar{display:flex;flex-wrap:wrap;gap:8px}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border:1px solid var(--line);border-radius:999px;font-size:12px;color:#334155;background:#fff}
  .muted{color:var(--muted)}
  .btn{border:1px solid var(--line);background:#fff;border-radius:10px;padding:8px 12px;cursor:pointer}
  .btn.primary{background:var(--brand);color:#fff;border-color:var(--brand)}
  .btn.ghost{background:transparent}
  .btn.danger{background:#dc2626;color:#fff;border-color:#dc2626}
  .btn:disabled{opacity:.55;cursor:not-allowed}
  .hide{display:none !important}

  .section{padding:12px 14px}
  .grid{display:grid;gap:12px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .qcard{border:1px solid var(--line);border-radius:12px;padding:10px 12px;background:#fff}
  .qtitle{font-size:12px;color:var(--muted);margin-bottom:6px}
  input[type="text"],input[type="number"],textarea,select{width:100%;border:1px solid #dbe2ea;border-radius:8px;padding:8px 10px;font:inherit}
  input[type="date"]{border:1px solid #dbe2ea;border-radius:8px;padding:6px 10px;font:inherit}
  input[readonly]{background:#f3f4f6}
  label.inline{display:inline-flex;align-items:center;gap:6px}
  .hint{font-size:12px;color:var(--muted)}
  .spacer{height:10px}

  /* Tabla cola */
  table{width:100%;border-collapse:separate;border-spacing:0}
  thead th{position:sticky;top:0;background:#f9fbfe;border-bottom:1px solid var(--line);font-weight:600;padding:8px;z-index:1}
  tbody td{border-bottom:1px dashed #eef2f7;padding:6px 8px;vertical-align:top}
  .badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid #cbd5e1;background:#fff}
  .b-pend{border-color:#f59e0b;color:#92400e;background:#fffbeb}
  .b-send{border-color:#10b981;color:#065f46;background:#ecfdf5}
  .b-fail{border-color:#ef4444;color:#7f1d1d;background:#fef2f2}
  .b-prog{border-color:#3b82f6;color:#1e3a8a;background:#eff6ff}
  .kpi{display:flex;gap:8px;flex-wrap:wrap}
  .kpi .pill{background:#f8fafc}

  /* Formulario l√≠neas */
  .qwrap{padding:12px 14px;display:grid;gap:12px}
  .qgrid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
  .cell-photos{width:160px}
  .cell-del{width:34px;text-align:center}
  thead th.small{min-width:90px}
  thead th.comp{min-width:160px}
  thead th.size{min-width:120px}
  thead th.qty{width:120px}
  thead th.resp{width:130px}
  td.td-loc  input{ max-width:90px  }
  td.td-dano input{ max-width:90px  }
  td.td-comp input{ min-width:160px }
  td.td-mrep input{ max-width:100px }
  td.td-size input{ max-width:120px }
  td.td-qty  input{ min-width:120px; font-size:15px }
  td.td-resp input{ min-width:130px; font-size:15px }

  /* Bot√≥n circular marcador "R" */
  .marker-btn{
    width:30px;height:30px;border-radius:999px;border:2px solid #94a3b8;background:#fff;
    display:inline-flex;align-items:center;justify-content:center;font-weight:700;cursor:pointer;
    user-select:none;transition:all .15s ease;
  }
  .marker-btn.active{background:#0b74c7;color:#fff;border-color:#0b74c7}

  /* Overlay */
  #overlay{ position:fixed; inset:0; background:rgba(15,23,42,.55);
    display:none; align-items:center; justify-content:center; z-index:9999; backdrop-filter: blur(2px); }
  .spinner{ width:56px; height:56px; border-radius:50%;
    border:6px solid rgba(255,255,255,.35); border-top-color:#fff; animation:spin 1s linear infinite; margin:0 auto; }
  @keyframes spin{to{transform:rotate(360deg)}}
  .loading-card{ background:#0b1220; color:#e5edf5; border-radius:16px; padding:18px 16px; min-width:240px; text-align:center; border:1px solid #263045 }
  .loading-card p{ margin:10px 0 0 0; font-size:14px; color:#b8c4d6 }

  /* Vista √©xito */
  #view-done{display:none}
  .done-wrap{padding:28px 20px;text-align:center}
  .done-emoji{font-size:44px;line-height:1;margin-bottom:6px}
  .done-title{font-size:18px;font-weight:700;margin:4px 0 8px}
  .done-sub{color:var(--muted);margin:0 0 16px}
  .done-actions{display:flex;gap:10px;flex-wrap:wrap;justify-content:center}
  .done-actions a, .done-actions button{min-width:180px}

  /* Toast */
  #toast{ position:fixed; left:12px; right:12px; bottom:12px; z-index:9999;
    display:none; padding:10px 12px; border-radius:10px; border:1px solid #dbe2ea; background:#ffffffcc;
    backdrop-filter:saturate(180%) blur(10px); box-shadow:0 8px 24px rgba(0,0,0,.08); font-size:14px }

  /* Modal Scanner */
  #scanModal{ position:fixed; inset:0; background:rgba(0,0,0,.8); display:none; z-index:9998; align-items:center; justify-content:center; }
  .scan-card{ background:#0b1220; color:#e5edf5; border:1px solid #263045; border-radius:16px; padding:12px; width:min(520px,94vw); }
  .scan-head{ display:flex; align-items:center; justify-content:space-between; gap:8px; padding:6px 2px 10px }
  .scan-body{ display:grid; gap:8px }
  .scan-vid{ width:100%; border-radius:12px; background:#000 }
  .scan-actions{ display:flex; gap:8px; justify-content:flex-end; padding-top:6px }
  .scan-actions button{ flex:1 }

  /* Modal T√©cnico/Vendor */
  #userModal{ position:fixed; inset:0; background:rgba(0,0,0,.6); display:none; z-index:9997; align-items:center; justify-content:center; }
  .user-card{ background:#fff; color:#0f172a; border:1px solid var(--line); border-radius:16px; padding:16px; width:min(520px,94vw); }
  .user-card h3{ margin:0 0 8px;font-size:18px }
  .user-grid{ display:grid; gap:10px }

  /* ============ DASHBOARD interno ============ */
  #view-admin{display:none}
  .pager{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .pager .btn{min-width:90px}
  .select{border:1px solid var(--line);border-radius:10px;padding:8px 10px;background:#fff}
  @media (max-width:1000px){ .qgrid{grid-template-columns:repeat(2,1fr)} }
  @media (max-width:640px){
    .qgrid{grid-template-columns:1fr}
    .submitbar{justify-content:stretch}
    .submitbar .btn{flex:1}
  }
</style>
</head>
<body>
<div class="wrap">

  <!-- ============ VISTA COLA (INICIO) ============ -->
  <div id="view-queue" class="card">
    <header>
      <h1>Unidades en cola</h1>
      <div class="toolbar">
        <span class="pill" id="userBadge">üë§ T√©cnico & Vendor</span>
        <button class="btn" id="btnChangeUser">Cambiar t√©cnico/vendor</button>
        <button class="btn" id="btnNew">+ Nueva inspecci√≥n</button>
        <button class="btn primary" id="btnSendAll">Enviar todo</button>

        <!-- Admin controls -->
        <button class="btn" id="btnAdminLogin">Iniciar admin</button>
        <button class="btn" id="btnAdminLogout" style="display:none">Cerrar sesi√≥n</button>
        <button class="btn" id="btnGoAdmin" style="display:none">Dashboard</button>
      </div>
    </header>
    <div class="section">
      <div class="row" style="justify-content:space-between;align-items:center">
        <div class="kpi">
          <span class="pill">Pendientes: <b id="kpiPend">0</b></span>
          <span class="pill">Enviando: <b id="kpiProg">0</b></span>
          <span class="pill">Enviadas: <b id="kpiOk">0</b></span>
          <span class="pill">Fallidas: <b id="kpiFail">0</b></span>
        </div>
        <div class="row">
          <input id="qSearch" type="text" placeholder="Buscar contenedor / folio‚Ä¶" style="min-width:240px"/>
          <select id="qFilter">
            <option value="all">Todos</option>
            <option value="pendiente">Pendientes</option>
            <option value="enviando">Enviando</option>
            <option value="enviado">Enviadas</option>
            <option value="fallido">Fallidas</option>
          </select>
          <button class="btn" id="btnRetryFail">Reintentar fallidas</button>
          <button class="btn danger" id="btnClearSent">Limpiar enviadas</button>
        </div>
      </div>

      <div class="spacer"></div>

      <div style="overflow:auto">
        <table>
          <thead>
            <tr>
              <th>Fecha</th>
              <th>Contenedor</th>
              <th>Gate</th>
              <th>Naviera</th>
              <th>Folio</th>
              <th>Estado</th>
              <th>L√≠neas</th>
              <th>Fotos</th>
              <th>Status</th>
              <th style="min-width:230px">Acciones</th>
            </tr>
          </thead>
          <tbody id="tbodyQueue"></tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="spacer"></div>

  <!-- ============ FORMULARIO INSPECCI√ìN ============ -->
  <div id="view-form" class="card" style="display:none">
    <header>
      <h1>MAERSK ‚Äî Cuestionario</h1>
      <div class="toolbar">
        <button class="btn" id="btnBackQueue">‚Üê Volver a la cola</button>
        <!-- (Se eliminaron los botones de exportar para usuarios normales) -->
      </div>
    </header>

    <section class="qwrap">
      <div class="qgrid">

        <!-- Orden: Container ‚Üí Fecha ‚Üí Gate -->
        <div class="qcard">
          <div class="qtitle">Container N¬∫</div>
          <div class="row">
            <input id="q_container" type="text" placeholder="MSKU1549768" style="text-transform:uppercase;letter-spacing:.5px">
            <!-- bot√≥n scanner con √≠cono de barras -->
            <button class="btn" id="btnContScan" title="Escanear ID">
              <svg width="22" height="22" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <rect x="3" y="5" width="18" height="14" rx="2" stroke="#0b74c7" stroke-width="2"/>
                <path d="M7 8v8M12 8v8M17 8v8" stroke="#0b74c7" stroke-width="2"/>
              </svg>
            </button>
          </div>
          <div class="hint">11 caracteres (4 letras + 7 d√≠gitos). Sin guiones. Si el DV no coincide, podr√°s continuar igual.</div>
        </div>

        <div class="qcard"><div class="qtitle">Fecha</div><div class="row"><input id="q_fecha" type="date"></div></div>

        <div class="qcard">
          <div class="qtitle">Gate</div>
          <div class="row">
            <label class="inline"><input type="radio" name="q_gate" value="GATE IN"> GATE IN</label>
            <label class="inline"><input type="radio" name="q_gate" value="GATE OUT"> GATE OUT</label>
          </div>
        </div>

        <!-- Resto -->
        <div class="qcard"><div class="qtitle">Naviera</div><div class="row">
          <select id="q_naviera"><option>MAERSK</option><option>HAPAG-LLOYD</option><option>COSCO</option><option>TRANSMARES</option><option>OOCL</option><option>OTRA</option></select>
        </div></div>
        <div class="qcard"><div class="qtitle">Lugar</div><div class="row"><input id="q_lugar" type="text"></div></div>

        <div class="qcard"><div class="qtitle">Folio</div><div class="row"><input id="q_folio" type="text"></div></div>
        <div class="qcard"><div class="qtitle">Tipo</div><div class="row">
          <select id="q_tipo"><option>20 DRY</option><option selected>40 DRY</option><option>40 HC</option><option>20 RF</option><option>40 RF</option></select>
        </div></div>

        <div class="qcard"><div class="qtitle">Estado</div><div class="row">
          <label class="inline"><input type="radio" name="q_estado" value="B"> B</label>
          <label class="inline"><input type="radio" name="q_estado" value="M"> M</label>
          <span class="pill">opcional</span>
        </div></div>

        <div class="qcard"><div class="qtitle">Para</div><div class="row">
          <label class="inline"><input type="radio" name="q_para" value="EXP"> EXP</label>
          <label class="inline"><input type="radio" name="q_para" value="IMP"> IMP</label>
          <label class="inline"><input type="radio" name="q_para" value="CFS"> CFS</label>
          <span class="pill">opcional</span>
        </div></div>

        <div class="qcard"><div class="qtitle">Vacio</div><div class="row">
          <label class="inline"><input type="radio" name="q_vacio" value="S"> S</label>
          <label class="inline"><input type="radio" name="q_vacio" value="N"> N</label>
          <span class="pill">opcional</span>
        </div></div>

        <div class="qcard"><div class="qtitle">OOG</div><div class="row">
          <label class="inline"><input type="radio" name="q_oog" value="S"> S</label>
          <label class="inline"><input type="radio" name="q_oog" value="N"> N</label>
          <span class="pill">opcional</span>
        </div></div>

        <div class="qcard"><div class="qtitle">Transportista</div><div class="row"><input id="q_transportista" type="text"></div></div>
        <div class="qcard"><div class="qtitle">Patente Cami√≥n</div><div class="row"><input id="q_patente" type="text"></div></div>
        <div class="qcard"><div class="qtitle">Nave</div><div class="row"><input id="q_nave" type="text"></div></div>
        <div class="qcard"><div class="qtitle">Pto Embarque / Descarga</div><div class="row"><input id="q_ptoemb" class="half" type="text"><input id="q_ptodesc" class="half" type="text"></div></div>
        <div class="qcard"><div class="qtitle">Tara / Gross (KGS)</div><div class="row"><input id="q_tara" class="half" type="number" step="0.01"><input id="q_gross" class="half" type="number" step="0.01"></div></div>
        <div class="qcard"><div class="qtitle">Class / Status</div><div class="row"><input id="q_class" class="half" type="text"><input id="q_status" class="half" type="text"></div></div>
        <div class="qcard"><div class="qtitle">Interior Condition</div><div class="row"><input id="q_interior" type="text"></div></div>

      </div>
    </section>

    <header>
      <h1>REPAIR ESTIMATE ‚Äî l√≠neas din√°micas</h1>
      <div class="toolbar">
        <button class="btn primary" id="btnAdd">+ Agregar l√≠nea</button>
        <button class="btn" id="btnClear">Vaciar l√≠neas</button>
      </div>
    </header>

    <div class="section" style="overflow:auto">
      <table id="tabla">
        <thead>
          <tr>
            <th style="width:44px">‚úì</th>
            <th class="small">Loc</th>
            <th class="small">Da√±o</th>
            <th class="comp">Comp</th>
            <th class="small">M. Rep</th>
            <th class="size">Size</th>
            <th class="qty">Qty</th>
            <th class="resp">Resp</th>
            <th class="cell-photos">Cargar fotos</th>
            <th class="cell-del"></th>
          </tr>
        </thead>
        <tbody id="body"></tbody>
      </table>
    </div>

    <div class="section grid" style="grid-template-columns:1fr 1fr 1fr">
      <div><label class="qtitle">Remarks</label><textarea id="remarks" rows="3"></textarea></div>
      <div><label class="qtitle">Nombre T√©cnico</label><input id="insp" type="text" /></div>
      <div><label class="qtitle">Vendor</label><input id="vendor" type="text" /></div>
    </div>

    <div class="section row" style="justify-content:flex-end;border-top:1px solid var(--line);padding-top:12px">
      <button class="btn" id="btnSaveQueue">Guardar en cola</button>
      <button class="btn primary" id="btnSubmit">Guardar y enviar ahora</button>
    </div>

    <div id="log" class="section" style="white-space:pre-wrap;background:#0b1220;color:#cbd5e1;border-radius:10px;display:none"></div>
  </div>

  <!-- ============ √âXITO ============ -->
  <div id="view-done" class="card">
    <header>
      <h1>Enviado correctamente</h1>
      <div class="toolbar"><span class="pill">‚úÖ Listo</span></div>
    </header>
    <div class="done-wrap">
      <div class="done-emoji">‚úÖ</div>
      <div class="done-title">Tu inspecci√≥n fue enviada</div>
      <p class="done-sub" id="done-sub">Puedes ver la carpeta o volver a la cola.</p>
      <div class="done-actions">
        <button id="btnBackQueue2" class="btn">Volver a la cola</button>
        <a id="btnFolder" class="btn" target="_blank" rel="noopener">Abrir carpeta</a>
      </div>
    </div>
  </div>

  <!-- ============ DASHBOARD INTERNO ============ -->
  <div id="view-admin" class="card">
    <header>
      <h1>MAERSK ‚Äî Dashboard en vivo</h1>
      <div class="toolbar">
        <span class="pill" id="adminBadge">üë§ Invitado</span>
        <button class="btn" id="btnAdminBack">‚Üê Volver</button>
        <button class="btn" id="btnAdminRefresh">Refrescar</button>
        <button class="btn primary" id="btnExportSel" style="display:none">Exportar seleccionadas</button>
      </div>
    </header>

    <div class="section">
      <div class="row" style="justify-content:space-between">
        <div class="row">
          <span class="pill">Pendientes: <b id="a_kpiPend">0</b></span>
          <span class="pill">Enviando: <b id="a_kpiProg">0</b></span>
          <span class="pill">Enviadas: <b id="a_kpiOk">0</b></span>
          <span class="pill">Fallidas: <b id="a_kpiFail">0</b></span>
        </div>
        <div class="row">
          <input id="a_txtSearch" type="text" placeholder="Buscar contenedor / folio‚Ä¶">
          <select id="a_selStatus" class="select">
            <option value="all">Todos</option>
            <option value="pendiente">Pendientes</option>
            <option value="enviando">Enviando</option>
            <option value="enviado">Enviadas</option>
            <option value="fallido">Fallidas</option>
          </select>
          <select id="a_perPage" class="select">
            <option value="20" selected>20</option>
            <option value="40">40</option>
            <option value="100">100</option>
            <option value="200">200</option>
          </select>
        </div>
      </div>

      <div style="height:10px"></div>

      <div style="overflow:auto">
        <table>
          <thead>
            <tr>
              <th id="a_thSel" style="width:30px"><input type="checkbox" id="a_checkAll" /></th>
              <th>Fecha</th>
              <th>Contenedor</th>
              <th>Gate</th>
              <th>Naviera</th>
              <th>Folio</th>
              <th>Estado</th>
              <th>L√≠neas</th>
              <th>Fotos</th>
              <th>Status</th>
              <th>Carpeta</th>
            </tr>
          </thead>
          <tbody id="a_tbody"></tbody>
        </table>
      </div>

      <div class="row pager" style="justify-content:space-between;margin-top:10px">
        <div class="row">
          <button class="btn" id="a_prev">¬´ Anterior</button>
          <span class="pill" id="a_pageInfo">P√°gina 1/1</span>
          <button class="btn" id="a_next">Siguiente ¬ª</button>
        </div>
        <span class="pill" id="a_lastUpdate">‚Äî</span>
      </div>
    </div>
  </div>

</div>

<!-- Overlay -->
<div id="overlay" role="alert" aria-live="polite" aria-busy="true">
  <div class="loading-card">
    <div class="spinner" aria-hidden="true"></div>
    <p id="overlayMsg">Procesando‚Ä¶</p>
  </div>
</div>

<!-- Modal Scanner -->
<div id="scanModal">
  <div class="scan-card">
    <div class="scan-head">
      <strong>Escanear contenedor</strong>
      <button class="btn" id="scanClose" type="button">Cerrar</button>
    </div>
    <div class="scan-body">
      <video id="scanVideo" class="scan-vid" playsinline></video>
      <div class="scan-actions">
        <button class="btn" id="scanCapture" type="button">Capturar</button>
        <button class="btn primary" id="scanUse" type="button">Usar</button>
      </div>
      <div class="hint">Apunta al ID (texto/c√≥digo). Si no detecta, ‚ÄúUsar‚Äù intentar√° OCR del fotograma.</div>
    </div>
  </div>
</div>

<!-- Modal T√©cnico/Vendor -->
<div id="userModal">
  <div class="user-card">
    <h3>Identificaci√≥n</h3>
    <div class="user-grid">
      <div>
        <div class="qtitle">Nombre t√©cnico</div>
        <input id="u_tecnico" type="text" placeholder="Nombre y apellido"/>
      </div>
      <div>
        <div class="qtitle">Vendor</div>
        <input id="u_vendor" type="text" placeholder="Empresa / Taller"/>
      </div>
    </div>
    <div class="row" style="justify-content:flex-end;margin-top:10px">
      <button class="btn" id="btnUserCancel">Cerrar</button>
      <button class="btn primary" id="btnUserSave">Guardar</button>
    </div>
  </div>
</div>

<!-- Modal Login Admin -->
<div id="loginModal" style="position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;z-index:99999;align-items:center;justify-content:center">
  <div class="user-card" style="max-width:420px">
    <h3>Acceso administrador</h3>
    <div class="user-grid">
      <div><div class="qtitle">Usuario</div><input id="loginUser" type="text" placeholder="Usuario"></div>
      <div><div class="qtitle">Contrase√±a</div><input id="loginPass" type="password" placeholder="Contrase√±a"></div>
    </div>
    <div class="row" style="justify-content:flex-end;margin-top:10px">
      <button class="btn" id="btnLoginCancel">Cancelar</button>
      <button class="btn primary" id="btnLoginOk">Entrar</button>
    </div>
  </div>
</div>

<!-- Toast -->
<div id="toast"></div>

<script>
/* ===================== CONFIG ===================== */
const GAS_URL = 'https://script.google.com/macros/s/AKfycbz22e7uZGaBmSDQujQCNVYJWlKJZYmsf3ch3yMt5wzZx-UXBRb8Rte0mFG5ZzbjzcQD8w/exec'; // <--- para enviar inspecciones
const API_URL = GAS_URL; // mismo endpoint para dashboard (whoami/getinspections/exportinspectionsbyids)

/* ===================== UTIL UI ===================== */
const $ = (q,el)=> (el||document).querySelector(q);
let logEl=null;
const log = m => { if(!logEl) return; if(logEl.style.display!=='block') logEl.style.display='block'; logEl.textContent += m + "\n"; logEl.scrollTop = logEl.scrollHeight; };
let toastTimer;
function toast(msg,ms){ const t=$("#toast"); t.textContent=msg; t.style.display='block'; clearTimeout(toastTimer); toastTimer=setTimeout(()=>t.style.display='none', ms||2200); }
function setOverlay(on,msg){ const ov=$("#overlay"); $("#overlayMsg").textContent=msg||"Procesando‚Ä¶"; const btns=document.querySelectorAll("button"); btns.forEach(b=>b.disabled=!!on); ov.style.display=on?'flex':'none'; }
function show(v){
  $("#view-queue").style.display = (v==='queue')?'block':'none';
  $("#view-form").style.display  = (v==='form')?'block':'none';
  $("#view-done").style.display  = (v==='done')?'block':'none';
  $("#view-admin").style.display = (v==='admin')?'block':'none';
}

/* ===================== ISO 6346 ===================== */
const ISO_MAP={A:10,B:12,C:13,D:14,E:15,F:16,G:17,H:18,I:19,J:20,K:21,L:23,M:24,N:25,O:26,P:27,Q:28,R:29,S:30,T:31,U:32,V:34,W:35,X:36,Y:37,Z:38};
const isoVal=ch=>/[0-9]/.test(ch)?Number(ch):(ISO_MAP[ch]||NaN);
function isoCheckDigit(s10){ const s=s10.toUpperCase(); let sum=0; for(let i=0;i<10;i++){ sum+= isoVal(s[i]) * (2**i); } const r=sum%11; return (r%10); }
const isoClean=s=>(s||"").toUpperCase().replace(/[^A-Z0-9]/g,"").trim();
const isoPattern11 = s => /^[A-Z]{4}[0-9]{7}$/.test(s);

/* ===================== Scanner ===================== */
let scanStream=null, scanLoop=false, scanCandidate=null, barcodeSupported=false;
async function startScanner(){
  try{
    barcodeSupported=('BarcodeDetector' in window);
    $("#scanModal").style.display='flex';
    scanStream=await navigator.mediaDevices.getUserMedia({video:{facingMode:{ideal:'environment'}},audio:false});
    const v=$("#scanVideo"); v.srcObject=scanStream; await v.play();
    scanCandidate=null; scanLoop=true;
    if(barcodeSupported){
      const det=new BarcodeDetector({formats:['code_128','qr_code','code_39','itf','ean_13','ean_8','upc_a','upc_e']});
      const loop=async()=>{
        if(!scanLoop) return;
        try{ const codes=await det.detect(v); if(codes&&codes.length){ const raw=codes[0].rawValue||''; const m=(raw.toUpperCase().match(/[A-Z]{4}\d{7}/)||[])[0]; if(m){ scanCandidate=m; toast('Detectado: '+m,1200);} } }catch(e){}
        requestAnimationFrame(loop);
      }; loop();
    }else{ toast('Esc√°ner nativo no disponible. Usa ‚ÄúUsar‚Äù para OCR.',2600); }
  }catch(e){ console.error(e); $("#scanModal").style.display='none'; toast('No se pudo abrir la c√°mara.',2800); }
}
function stopScanner(){ scanLoop=false; const v=$("#scanVideo"); try{ if(v){v.pause(); v.srcObject=null;} if(scanStream){scanStream.getTracks().forEach(t=>t.stop());} }catch(e){} $("#scanModal").style.display='none'; }
async function ocrFrame(){
  const v=$("#scanVideo"); const c=document.createElement('canvas');
  c.width=v.videoWidth||1280; c.height=v.videoHeight||720; c.getContext('2d').drawImage(v,0,0,c.width,c.height);
  const res=await Tesseract.recognize(c.toDataURL('image/jpeg',0.9),'eng',{logger:()=>{}}); const t=(res?.data?.text||'').toUpperCase();
  const m=t.match(/[A-Z]{4}\d{7}/); return m?m[0]:null;
}
async function scanUse(){ try{ if(!scanCandidate){ toast('Intentando OCR‚Ä¶',1000); scanCandidate=await ocrFrame(); } if(scanCandidate){ $("#q_container").value=scanCandidate; stopScanner(); validateContainer(); } else toast('No se detect√≥. Prueba ‚ÄúCapturar‚Äù.',2200);}catch(e){console.error(e);toast('Error en OCR.',2200);} }
async function scanCapture(){ try{ toast('Procesando OCR‚Ä¶',1000); const id=await ocrFrame(); if(id){ scanCandidate=id; toast('Detectado: '+id,1500);} else toast('No se detect√≥ un ID.',2200);}catch(e){console.error(e);toast('Error en OCR.',2200);} }

/* ===================== Forzar MAY√öSCULAS (l√≠neas) ===================== */
function forceUpperOnBody(){
  $("#body").addEventListener('input',e=>{
    const t=e.target;
    if(t && t.tagName==='INPUT' && t.type==='text'){ const pos=t.selectionStart; t.value=t.value.toUpperCase(); try{ t.setSelectionRange(pos,pos);}catch(_){ } }
  });
}

/* ===================== L√çNEAS ===================== */
let seq=0; let bodyEl=null; const photos=new Map();
function toggleMarker(btn){ const on=btn.classList.toggle('active'); btn.textContent=on?'R':''; const tr=btn.closest('tr'); if(tr) tr.dataset.reparado = on ? '1':'0'; }
function addRow(p){ p=p||{}; seq++; const id=seq; const tr=document.createElement('tr'); tr.dataset.row=String(id); tr.dataset.reparado=p.reparado?'1':'0';
  tr.innerHTML =
  '<td style="text-align:center"><button class="marker-btn'+(p.reparado?' active':'')+'" type="button">'+(p.reparado?'R':'')+'</button></td>'+
  '<td class="td-loc"><input type="text" value="'+(p.location||'')+'"></td>'+
  '<td class="td-dano"><input type="text" value="'+(p.damage||'')+'"></td>'+
  '<td class="td-comp"><input type="text" value="'+(p.component||'')+'"></td>'+
  '<td class="td-mrep"><input type="text" value="'+(p.method||'')+'"></td>'+
  '<td class="td-size"><input type="text" value="'+(p.size||'')+'"></td>'+
  '<td class="td-qty"><input type="number" inputmode="numeric" min="0" step="1" value="'+(p.qty??'')+'"></td>'+
  '<td class="td-resp"><input type="text" value="'+(p.resp||'')+'"></td>'+
  '<td class="cell-photos"><input id="file_'+id+'" type="file" accept="image/*" capture="environment" multiple style="display:none"><button id="btnf_'+id+'" class="btn">Cargar fotos</button><div id="fc_'+id+'" class="pill" style="margin-top:6px">0 archivo(s)</div></td>'+
  '<td class="cell-del"><button id="btndel_'+id+'" class="btn">‚úï</button></td>';
  bodyEl.appendChild(tr);
  tr.querySelector('.marker-btn').addEventListener('click',function(){toggleMarker(this);});
  const fi=tr.querySelector('#file_'+id); const btn=tr.querySelector('#btnf_'+id); btn.addEventListener('click',()=>fi.click());
  fi.addEventListener('change',()=>{ photos.set(id, fi.files); $('#fc_'+id).textContent=(fi.files?fi.files.length:0)+' archivo(s)'; });
  tr.querySelector('#btndel_'+id).addEventListener('click',()=>{ tr.remove(); photos.delete(id); });
}

/* ===================== FORM ‚Üí OBJ ===================== */
function getRadio(name){ const el=document.querySelector('input[name="'+name+'"]:checked'); return el?el.value:''; }
function getQuestionnaire(){
  return {
    container: isoClean($('#q_container').value),
    fecha: $('#q_fecha').value,
    gate: getRadio('q_gate'),
    naviera: $('#q_naviera').value,
    lugar: $('#q_lugar').value.trim(),
    folio: $('#q_folio').value.trim(),
    tipo: $('#q_tipo').value,
    estado: getRadio('q_estado'),
    para: getRadio('q_para'),
    vacio: getRadio('q_vacio'),
    oog: getRadio('q_oog'),
    transportista: $('#q_transportista').value.trim(),
    patente: $('#q_patente').value.trim(),
    nave: $('#q_nave').value.trim(),
    pto_embarque: $('#q_ptoemb').value.trim(),
    pto_descarga: $('#q_ptodesc').value.trim(),
    tara_kgs: $('#q_tara').value,
    gross_kgs: $('#q_gross').value,
    class: $('#q_class').value.trim(),
    status: $('#q_status').value.trim(),
    interior_condition: $('#q_interior').value.trim()
  };
}
function getLines(){
  const out=[]; const rows=bodyEl.querySelectorAll('tr');
  rows.forEach((tr,idx)=>{
    const c=tr.querySelectorAll('input');
    out.push({
      n: idx+1,
      marker: tr.querySelector('.marker-btn').classList.contains('active')?'R':'',
      reparado: tr.dataset.reparado==='1',
      loc: (c[0].value||'').trim(),
      dano:(c[1].value||'').trim(),
      comp:(c[2].value||'').trim(),
      mrep:(c[3].value||'').trim(),
      size:(c[4].value||'').trim(),
      qty: Number(c[5].value||0),
      resp:(c[6].value||'').trim(),
      hasPhotos: (photos.get(Number(tr.dataset.row))||[]).length>0
    });
  });
  return out;
}
function buildDoc(){
  return {
    questionnaire: getQuestionnaire(),
    lines: getLines(),
    remarks: ($('#remarks').value||'').trim(),
    tecnico: ($('#insp').value||'').trim(),
    vendor:  ($('#vendor').value||'').trim()
  };
}

/* ===================== VALIDACIONES ===================== */
function validateContainer(){
  const el=$("#q_container"); const raw=isoClean(el.value);
  if(raw.length!==11){ toast('Debe tener 11 caracteres (4 letras + 7 d√≠gitos).',2400); return false; }
  if(!isoPattern11(raw)){ toast('Formato inv√°lido. Ej: MSKU1549768',2400); return false; }
  const exp=isoCheckDigit(raw.slice(0,10)); if(Number(raw[10])!==exp){ toast('DV esperado: '+exp+' (puedes continuar igual).',2400); }
  el.value=raw; return true;
}
function requirePhotoIfLineHasData(){
  const trs=bodyEl.querySelectorAll('tr');
  for(let t=0;t<trs.length;t++){
    const tr=trs[t]; const id=Number(tr.dataset.row); const files=photos.get(id)||[]; const c=tr.querySelectorAll('input');
    let any=false; for(let i=0;i<=6;i++){ const v=c[i]?String(c[i].value||'').trim():''; if(v!==''){ any=true; break; } }
    if(any && files.length===0){ toast('La l√≠nea '+(t+1)+' requiere al menos 1 foto.',2600); return false; }
  }
  return true;
}

/* ===================== COMPRESI√ìN & ENCODE ===================== */
function compressImage(file,maxSide=1280,quality=0.72){
  return new Promise((res,rej)=>{
    const img=new Image(); const fr=new FileReader();
    fr.onload=()=>{ img.onload=()=>{ const c=document.createElement('canvas'); let {width:w,height:h}=img;
      if(Math.max(w,h)>maxSide){ if(w>h){ h=Math.round(h*maxSide/w); w=maxSide; } else { w=Math.round(h*maxSide/w); w=Math.round(w); h=maxSide; } }
      c.width=w; c.height=h; const ctx=c.getContext('2d'); ctx.drawImage(img,0,0,w,h);
      c.toBlob(b=>res(b), 'image/jpeg', quality);
    }; img.src=fr.result; }; fr.onerror=rej; fr.readAsDataURL(file);
  });
}
function blobToBase64(blob){
  return new Promise((res,rej)=>{ const fr=new FileReader(); fr.onload=()=>{ const s=String(fr.result); res(s.substring(s.indexOf(',')+1)); }; fr.onerror=rej; fr.readAsDataURL(blob); });
}

/* ===================== IndexedDB (cola) ===================== */
const DB_NAME='reefer_inspections_db'; const DB_VER=1; const STORE='queue';
function idbOpen(){
  return new Promise((res,rej)=>{
    const req=indexedDB.open(DB_NAME,DB_VER);
    req.onupgradeneeded=()=>{ const db=req.result; if(!db.objectStoreNames.contains(STORE)){ const st=db.createObjectStore(STORE,{keyPath:'id'}); st.createIndex('status','status',{unique:false}); st.createIndex('createdAt','createdAt',{unique:false}); } };
    req.onsuccess=()=>res(req.result); req.onerror=()=>rej(req.error);
  });
}
async function dbTxn(mode){ const db=await idbOpen(); return db.transaction(STORE,mode); }
async function queueAdd(item){ const tx=await dbTxn('readwrite'); await new Promise((res,rej)=>{ tx.objectStore(STORE).put(item).onsuccess=()=>res(); tx.onerror=()=>rej(tx.error); }); tx.db.close(); }
async function queueGetAll(){ const tx=await dbTxn('readonly'); return new Promise((res,rej)=>{ const req=tx.objectStore(STORE).getAll(); req.onsuccess=()=>{ tx.db.close(); res(req.result||[]);} ; req.onerror=()=>{ tx.db.close(); rej(req.error);} }); }
async function queueUpdate(id,patch){ const tx=await dbTxn('readwrite'); const st=tx.objectStore(STORE); const cur=await new Promise((res,rej)=>{ const r=st.get(id); r.onsuccess=()=>res(r.result); r.onerror=()=>rej(r.error); });
  if(!cur){ tx.db.close(); return; } Object.assign(cur,patch,{updatedAt:new Date().toISOString()});
  await new Promise((res,rej)=>{ st.put(cur).onsuccess=()=>res(); st.put(cur).onerror=()=>rej(); }); tx.db.close();
}
async function queueDelete(id){ const tx=await dbTxn('readwrite'); await new Promise((res,rej)=>{ tx.objectStore(STORE).delete(id).onsuccess=()=>res(); tx.onerror=()=>rej(tx.error); }); tx.db.close(); }

/* ===================== RENDER COLA ===================== */
function shortS(s){ return (s||'').slice(0,10); }
async function renderQueue(){
  const q=$("#qSearch").value.trim().toUpperCase(); const filter=$("#qFilter").value;
  const tbody=$("#tbodyQueue"); tbody.innerHTML='';
  const all=await queueGetAll();
  // KPIs
  const pend=all.filter(x=>x.status==='pendiente').length;
  const prog=all.filter(x=>x.status==='enviando').length;
  const ok  =all.filter(x=>x.status==='enviado').length;
  const fail=all.filter(x=>x.status==='fallido').length;
  $("#kpiPend").textContent=pend; $("#kpiProg").textContent=prog; $("#kpiOk").textContent=ok; $("#kpiFail").textContent=fail;

  let data=all;
  if(filter!=='all') data=data.filter(x=>x.status===filter);
  if(q) data=data.filter(x=>(x.questionnaire.container||'').includes(q) || (x.questionnaire.folio||'').toUpperCase().includes(q));
  data.sort((a,b)=> (a.createdAt<b.createdAt?1:-1) );

  for(const it of data){
    const tr=document.createElement('tr');
    const st = it.status==='pendiente' ? 'b-pend' : it.status==='enviado' ? 'b-send' : it.status==='enviando' ? 'b-prog' : 'b-fail';
    const photosCount = (it.photos || []).reduce((acc,p)=> acc + (p?.length||0), 0);
    tr.innerHTML =
      `<td>${shortS(it.questionnaire.fecha)}</td>
       <td><b>${it.questionnaire.container||''}</b></td>
       <td>${it.questionnaire.gate||''}</td>
       <td>${it.questionnaire.naviera||''}</td>
       <td>${it.questionnaire.folio||''}</td>
       <td>${it.questionnaire.estado||''}</td>
       <td>${(it.lines||[]).length}</td>
       <td>${photosCount}</td>
       <td><span class="badge ${st}">${it.status}</span></td>
       <td>
         <div class="row">
           <button class="btn" data-act="edit" data-id="${it.id}">Inspeccionar/Editar</button>
           <button class="btn" data-act="send" data-id="${it.id}">Enviar</button>
           <button class="btn danger" data-act="del" data-id="${it.id}">Eliminar</button>
         </div>
       </td>`;
    tbody.appendChild(tr);
  }

  // acciones
  tbody.onclick = async (e)=>{
    const b=e.target.closest('button'); if(!b) return;
    const id=b.getAttribute('data-id'); const act=b.getAttribute('data-act');
    const all=await queueGetAll(); const item=all.find(x=>x.id===id);
    if(!item) return;
    if(act==='edit'){ loadItemToForm(item); show('form'); }
    if(act==='del'){ await queueDelete(id); toast('Eliminado.',1500); renderQueue(); }
    if(act==='send'){ sendItems([item]); }
  };
}

/* ===================== GUARDAR EN COLA ===================== */
function makeId(container){
  const d=new Date(); const iso=d.toISOString().replace(/[:.]/g,'').slice(0,15);
  return `${iso}_${container||'UNKN'}`;
}
async function gatherPhotosCompressed(){
  const arr=[];
  const rows=bodyEl.querySelectorAll('tr');
  for(const tr of rows){
    const rowId=Number(tr.dataset.row); const fl=photos.get(rowId)||[];
    const list=[];
    for(const f of fl){ const b=await compressImage(f); list.push({name:f.name.replace(/\.(png|jpg|jpeg|heic|webp)$/i,'.jpg'), type:'image/jpeg', blob:b}); }
    arr.push(list);
  }
  return arr;
}
async function saveToQueueFromForm(){
  if(!validateContainer()) return;
  if(!requirePhotoIfLineHasData()) return;
  const doc=buildDoc();
  const id=makeId(doc.questionnaire.container);
  const photosCompressed = await gatherPhotosCompressed();
  const item={
    id, questionnaire:doc.questionnaire, lines:doc.lines, remarks:doc.remarks,
    tecnico:doc.tecnico, vendor:doc.vendor, photos:photosCompressed, status:'pendiente',
    createdAt:new Date().toISOString(), updatedAt:new Date().toISOString(), retries:0
  };
  await queueAdd(item);
  toast('Guardado en cola.',1600);
  show('queue'); renderQueue();
}

/* ===================== ENV√çO ===================== */
async function sendItems(items){
  if(!items || !items.length) return;
  setOverlay(true,'Enviando '+items.length+' inspecci√≥n(es)‚Ä¶');

  const concurrency = 2;
  let idx=0;
  async function worker(){
    while(idx < items.length){
      const k = idx++;
      const it = items[k];
      await queueUpdate(it.id,{status:'enviando'}); renderQueue();
      try{
        const linesPayload = [];
        const photosPayload = [];
        const q = it.questionnaire;

        for(let i=0;i<it.lines.length;i++){
          const L = it.lines[i];
          linesPayload.push({
            line: L.n, marker:L.marker, reparado:L.reparado,
            location:L.loc, damage:L.dano, component:L.comp, method:L.mrep, size:L.size, qty:L.qty, resp:L.resp
          });
          const files = (it.photos[i]||[]);
          for(const pf of files){
            const b64 = await blobToBase64(pf.blob);
            photosPayload.push({ name: pf.name, mimeType: pf.type, dataBase64: b64, line: L.n });
          }
        }

        const raw= q.container || '';
        const isoValid = isoPattern11(raw);
        const dvExp = isoValid ? isoCheckDigit(raw.slice(0,10)) : null;
        const dvMatch = isoValid ? (Number(raw[10])===dvExp) : null;
        const unit_state = {
          container: raw, iso_valid_format: !!isoValid, dv_expected: dvExp, dv_match: dvMatch,
          gate: q.gate, date: q.fecha, naviera:q.naviera, vacio:q.vacio, oog:q.oog,
          lines_count: it.lines.length,
          lines_with_photos: photosPayload.length,
          any_marked_R: it.lines.some(x=>x.marker==='R'), vendor: it.vendor, tecnico: it.tecnico,
          remarks_len: (it.remarks||'').length, created_at: new Date().toISOString()
        };

        const payload = {
          meta: { naviera: q.naviera, fecha: (q.fecha||new Date().toISOString().slice(0,10)), unidad: q.container },
          form: {
            container:q.container, folio:q.folio, tipo:q.tipo, gate:q.gate, fecha:q.fecha,
            estado:q.estado, para:q.para, naviera:q.naviera, lugar:q.lugar,
            vacio:q.vacio, oog:q.oog, transportista:q.transportista, patente:q.patente,
            nave:q.nave, pto_embarque:q.pto_embarque, pto_descarga:q.pto_descarga, tara_kgs:q.tara_kgs, gross_kgs:q.gross_kgs,
            class:q.class, status:q.status, interior_condition:q.interior_condition,
            inspector: it.tecnico, vendor: it.vendor, remarks: it.remarks
          },
          lines: linesPayload,
          photos: photosPayload,
          analytics: { tecnico: it.tecnico, vendor: it.vendor, lines: it.lines.length },
          unit_state
        };

        const res = await fetch(GAS_URL,{ method:'POST', headers:{'Content-Type':'text/plain;charset=utf-8'}, body: JSON.stringify(payload) });
        if(!res.ok) throw new Error('HTTP '+res.status);
        const j=await res.json();
        if(!j.ok) throw new Error(j.error||'Error en backend');
        await queueUpdate(it.id,{status:'enviado', folderUrl:j.folderUrl||null});
      }catch(err){
        console.error(err);
        await queueUpdate(it.id,{status:'fallido', retries:(it.retries||0)+1, lastError: String(err&&err.message||err) });
      }
      await renderQueue();
    }
  }
  const workers=[]; for(let i=0;i<concurrency;i++) workers.push(worker());
  await Promise.all(workers);
  setOverlay(false);
  toast('Proceso de env√≠o finalizado.',2200);
}

/* ===================== SUBMIT DIRECTO ===================== */
async function submitNow(){
  await saveToQueueFromForm();
  const all=await queueGetAll();
  const pend=all.filter(x=>x.status==='pendiente').sort((a,b)=> (a.createdAt<b.createdAt?1:-1));
  if(pend[0]) await sendItems([pend[0]]);
  const item = await queueGetAll().then(list => list.find(x => x.id===pend[0].id));
  const folderUrl = item?.folderUrl;
  if(folderUrl){ $("#btnFolder").href = folderUrl; $("#btnFolder").style.display='inline-block'; } else { $("#btnFolder").style.display='none'; }
  show('done');
}

/* ===================== USER (t√©cnico/vendor) ===================== */
function loadUserBadge(){
  const t=localStorage.getItem('tec_name')||''; const v=localStorage.getItem('tec_vendor')||'';
  $("#userBadge").textContent = (t||v) ? `üë§ ${t||'‚Äî'} ¬∑ ${v||'‚Äî'}` : 'üë§ T√©cnico & Vendor';
  $("#insp").value = t; $("#vendor").value = v;
}
function openUserModal(){ $("#u_tecnico").value=localStorage.getItem('tec_name')||''; $("#u_vendor").value=localStorage.getItem('tec_vendor')||''; $("#userModal").style.display='flex'; }
function saveUserModal(){ localStorage.setItem('tec_name',$("#u_tecnico").value.trim()); localStorage.setItem('tec_vendor',$("#u_vendor").value.trim()); $("#userModal").style.display='none'; loadUserBadge(); toast('Datos guardados.',1400); }

/* ===================== ADMIN AUTH/API ===================== */
let AUTH_USER=null, AUTH_HASH=null, IS_ADMIN=false;
async function sha256Hex(str){ const enc=new TextEncoder().encode(str); const buf=await crypto.subtle.digest('SHA-256',enc); return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join(''); }
async function apiGet(fn, params={}){
  const u=new URL(API_URL); u.searchParams.set('fn',fn);
  if(AUTH_USER) u.searchParams.set('user', AUTH_USER);
  if(AUTH_HASH) u.searchParams.set('passHash', AUTH_HASH);
  Object.entries(params).forEach(([k,v])=>u.searchParams.set(k,v));
  const res=await fetch(u.toString(),{method:'GET'}); return res.json();
}
async function apiPost(fn, body={}){
  const u=new URL(API_URL); u.searchParams.set('fn',fn);
  if(AUTH_USER) body.user=AUTH_USER; if(AUTH_HASH) body.passHash=AUTH_HASH;
  const res=await fetch(u.toString(),{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)}); return res.json();
}
function setAdminUI(isAdmin){
  IS_ADMIN=!!isAdmin;
  $("#btnAdminLogin").style.display = IS_ADMIN ? 'none':'inline-block';
  $("#btnAdminLogout").style.display = AUTH_USER ? 'inline-block':'none';
  $("#btnGoAdmin").style.display = IS_ADMIN ? 'inline-block':'none';
  $("#adminBadge").textContent = IS_ADMIN ? `üë§ Admin (${AUTH_USER||'‚Äî'})` : 'üë§ Invitado';
}
function openLogin(){ $("#loginModal").style.display='flex'; $("#loginUser").focus(); }
function closeLogin(){ $("#loginModal").style.display='none'; }
async function doLogin(){
  const u=$("#loginUser").value.trim(); const p=$("#loginPass").value;
  if(!u || !p){ toast('Ingresa usuario y contrase√±a',1800); return; }
  const h=await sha256Hex(p); AUTH_USER=u; AUTH_HASH=h;
  const info=await apiGet('whoami'); if(info?.ok && info.isAdmin){ localStorage.setItem('auth_user',AUTH_USER); localStorage.setItem('auth_hash',AUTH_HASH); setAdminUI(true); closeLogin(); toast('Admin activo',1200); } else { AUTH_USER=null; AUTH_HASH=null; toast('Credenciales inv√°lidas',1800); }
}
function doLogout(){ AUTH_USER=null; AUTH_HASH=null; IS_ADMIN=false; localStorage.removeItem('auth_user'); localStorage.removeItem('auth_hash'); setAdminUI(false); show('queue'); }

/* ===================== DASHBOARD: datos/paginaci√≥n ===================== */
let a_all=[], a_filtered=[], a_selected=new Set(), a_page=1, a_per=20;
function a_kpis(rows){
  const pend=rows.filter(x=>x.status==='pendiente').length;
  const prog=rows.filter(x=>x.status==='enviando').length;
  const ok=rows.filter(x=>x.status==='enviado').length;
  const fail=rows.filter(x=>x.status==='fallido').length;
  $("#a_kpiPend").textContent=pend; $("#a_kpiProg").textContent=prog; $("#a_kpiOk").textContent=ok; $("#a_kpiFail").textContent=fail;
}
function a_applyFilters(){
  const q=($("#a_txtSearch").value||'').trim().toUpperCase();
  const st=$("#a_selStatus").value;
  a_filtered = a_all.filter(x=> (x.container||x.folio||x.folderUrl)); // oculta vac√≠os
  if(st!=='all') a_filtered=a_filtered.filter(x=>(x.status||'').toLowerCase()===st);
  if(q) a_filtered=a_filtered.filter(x=> (x.container||'').toUpperCase().includes(q) || (x.folio||'').toUpperCase().includes(q) );
  a_filtered.sort((a,b)=> (String(a.fecha)<String(b.fecha)?1:-1));
}
function a_render(){
  a_applyFilters();
  const tb=$("#a_tbody"); tb.innerHTML='';
  const total=a_filtered.length; const pages=Math.max(1, Math.ceil(total/a_per)); if(a_page>pages) a_page=pages;
  const ini=(a_page-1)*a_per, fin=Math.min(total, ini+a_per);
  for(let i=ini;i<fin;i++){
    const r=a_filtered[i]; const stc=r.status==='pendiente'?'b-pend': r.status==='enviado'?'b-send': r.status==='enviando'?'b-prog':'b-fail';
    const checked = a_selected.has(r.id) ? 'checked' : '';
    const folderCell = r.folderUrl ? `<a href="${r.folderUrl}" target="_blank" rel="noopener">Abrir</a>` : '<span class="muted">‚Äî</span>';
    const tr=document.createElement('tr');
    tr.innerHTML =
      `<td><input type="checkbox" class="row-check" data-id="${r.id}" ${checked}></td>
       <td>${String(r.fecha||'').toString().slice(0,10)}</td>
       <td><b>${r.container||''}</b></td>
       <td>${r.gate||''}</td>
       <td>${r.naviera||''}</td>
       <td>${r.folio||''}</td>
       <td>${r.estado||''}</td>
       <td>${r.linesCount??(r.lines?.length||0)??0}</td>
       <td>${r.photosCount??r.photos_total??0}</td>
       <td><span class="badge ${stc}">${r.status||''}</span></td>
       <td>${folderCell}</td>`;
    tb.appendChild(tr);
  }
  $("#a_pageInfo").textContent = `P√°gina ${a_page}/${Math.max(1,Math.ceil(total/a_per))}`;
  $("#a_lastUpdate").textContent = '√ölt. actualizaci√≥n: ' + new Date().toLocaleString();
}
async function a_refresh(){
  if(!IS_ADMIN){ toast('Acceso admin requerido',1500); return; }
  const res=await apiGet('getinspections');
  if(res?.ok){ a_all=res.items||[]; a_page=1; a_render(); }
}
async function a_export(){
  if(!IS_ADMIN){ toast('Acceso admin requerido',1500); return; }
  const ids=Array.from(a_selected); if(!ids.length){ toast('Selecciona al menos 1 unidad',1600); return; }
  const btn=$("#btnExportSel"); const txt=btn.textContent; btn.disabled=true; btn.textContent='Preparando‚Ä¶';
  try{
    const res=await apiPost('exportinspectionsbyids',{ids});
    if(!res?.ok) throw new Error(res?.error||'Error exportando');
    const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([JSON.stringify(res,null,2)],{type:'application/json'})); a.download='inspecciones_'+Date.now()+'.json'; a.click();
  }catch(err){ console.error(err); toast(String(err&&err.message||err),2200); }
  finally{ btn.disabled=false; btn.textContent=txt; }
}

/* ===================== CARGA/INIT ===================== */
function attachEvents(){
  // vistas
  $("#btnNew").onclick = ()=>{ show('form'); };
  $("#btnBackQueue").onclick = ()=>show('queue');
  $("#btnBackQueue2").onclick = ()=>show('queue');

  // user
  $("#btnChangeUser").onclick = openUserModal;
  $("#btnUserSave").onclick = saveUserModal;
  $("#btnUserCancel").onclick = ()=> $("#userModal").style.display='none';

  // scanner
  $("#btnContScan").onclick = startScanner;
  $("#scanClose").onclick = stopScanner;
  $("#scanUse").onclick = scanUse;
  $("#scanCapture").onclick = scanCapture;

  // form actions
  $("#btnAdd").onclick = ()=> addRow();
  $("#btnClear").onclick = ()=>{ bodyEl.innerHTML=''; photos.clear(); seq=0; addRow(); };
  $("#btnSaveQueue").onclick = saveToQueueFromForm;
  $("#btnSubmit").onclick = submitNow;

  // queue actions globales
  $("#btnSendAll").onclick = async ()=>{ const all=await queueGetAll(); const pend=all.filter(x=>x.status==='pendiente'||x.status==='fallido'); if(!pend.length){ toast('No hay pendientes.',1500); return; } sendItems(pend); };
  $("#btnRetryFail").onclick = async ()=>{ const all=await queueGetAll(); const fail=all.filter(x=>x.status==='fallido'); if(!fail.length){ toast('Sin fallidas.',1500); return; } sendItems(fail); };
  $("#btnClearSent").onclick = async ()=>{ const all=await queueGetAll(); for(const it of all){ if(it.status==='enviado') await queueDelete(it.id); } renderQueue(); toast('Enviadas eliminadas.',1400); };
  $("#qSearch").oninput = renderQueue;
  $("#qFilter").onchange = renderQueue;

  // admin
  $("#btnAdminLogin").onclick = openLogin;
  $("#btnLoginCancel").onclick = closeLogin;
  $("#btnLoginOk").onclick = doLogin;
  $("#btnAdminLogout").onclick = doLogout;
  $("#btnGoAdmin").onclick = ()=>{ if(!IS_ADMIN){ toast('Acceso admin requerido',1500); return; } show('admin'); a_refresh(); };
  $("#btnAdminBack").onclick = ()=>{ show('queue'); };
  $("#btnAdminRefresh").onclick = a_refresh;
  $("#btnExportSel").onclick = a_export;

  // Admin table interacciones
  $("#a_tbody").addEventListener('change',(e)=>{
    const ch=e.target.closest('.row-check'); if(!ch) return;
    const id=ch.getAttribute('data-id');
    if(ch.checked) a_selected.add(id); else a_selected.delete(id);
  });
  $("#a_checkAll").onclick = (e)=>{
    const on=e.target.checked;
    document.querySelectorAll('#a_tbody .row-check').forEach(ch=>{
      ch.checked=on; const id=ch.getAttribute('data-id'); if(on) a_selected.add(id); else a_selected.delete(id);
    });
  };
  $("#a_txtSearch").oninput = ()=> a_render();
  $("#a_selStatus").onchange = ()=> a_render();
  $("#a_perPage").onchange = ()=>{ a_per = Number($("#a_perPage").value||20); a_page=1; a_render(); };
  $("#a_prev").onclick = ()=>{ if(a_page>1){ a_page--; a_render(); } };
  $("#a_next").onclick = ()=>{ const pages=Math.max(1, Math.ceil(a_filtered.length/a_per)); if(a_page<pages){ a_page++; a_render(); } };
}

function init(){
  logEl=$("#log"); bodyEl=$("#body");
  attachEvents(); addRow(); loadUserBadge();
  // restaurar sesi√≥n admin
  const u=localStorage.getItem('auth_user'), h=localStorage.getItem('auth_hash');
  if(u && h){ AUTH_USER=u; AUTH_HASH=h; apiGet('whoami').then(info=> setAdminUI(!!info.isAdmin)); }
  else setAdminUI(false);
  show('queue'); renderQueue();
}

window.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
