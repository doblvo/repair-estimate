<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>COT — Reporte Digital (v6-móvil)</title>
<meta name="color-scheme" content="light">
<style>
  :root{
    --bg:#f6f8fb; --surface:#ffffff; --ink:#0f172a; --muted:#64748b; --line:#e5e7eb;
    --brand:#0b74c7; --danger:#b91c1c;
    --radius:10px; --pad:10px; --gap:4px; --thin:1px;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.35 system-ui,Segoe UI,Roboto,Helvetica,Arial}
  .wrap{max-width:1100px;margin:0 auto;padding:10px}
  header h1{margin:0 0 4px;font-size:18px;font-weight:700}
  header .meta{color:var(--muted);font-size:12px;margin-bottom:6px}
  .card{background:var(--surface);border:var(--thin) solid var(--line);border-radius:var(--radius);padding:var(--pad);margin-bottom:8px}
  .sectitle{font-weight:700;margin:0 0 4px;color:var(--ink);font-size:14px}
  .grid{display:grid;gap:var(--gap)}
  .g2{grid-template-columns:repeat(2,1fr); column-gap:8px}
  .g3{grid-template-columns:repeat(3,1fr); column-gap:8px}

  /* ==== COMPACTACIÓN ESPECÍFICA EN CONTENEDORES ==== */
  #containers .container-card{padding-top:6px}
  #containers .container-head{margin-bottom:2px}
  #containers .g3{grid-template-columns: 1fr 1fr 1fr; column-gap:6px; row-gap:2px}
  #containers .row{grid-template-columns:96px 1fr; gap:2px}
  #containers label{font-size:12px;margin-bottom:0}
  #containers .row > div[style*="display:flex"]{gap:4px}
/* Input N° CONTENEDOR más grande y legible */
#containers input[name$="_container"]{
  font-size:13px;       /* ✅ texto un poco más pequeño */
  width:102%;           /* ✅ recuadro más ancho */
  min-height:30px;
  padding:6px 8px;
}
/* Estilo especial para N° BOOKING */
#containers input[name$="_booking"] {
  font-size: 13px;     /* ✅ Texto un poquito más pequeño */
  width: 90%;          /* ✅ Más ancho pero sin botar a Naviera */
  min-height: 30px;
  padding: 6px 8px;
  box-sizing: border-box;
}
.input-naviera-otra {
    width: 80%;        /* Ajusta si necesitas 70% o 75% */
    font-size: 12px;   /* Letra un poco más pequeña */
    padding: 6px 10px;
    border: 1px solid #ccc;
    border-radius: 6px;
    margin-top: 4px;
}
.hidden {
    display: none;
}


  /* ================================================ */

  .row{display:grid;grid-template-columns:120px 1fr;gap:2px;align-items:center}
  @media (max-width:900px){ .g3{grid-template-columns:1fr} }
  @media (max-width:760px){ .row{grid-template-columns:1fr} .row>label{margin-bottom:1px} .g2{grid-template-columns:1fr} }
  label{font-weight:700;color:var(--ink);font-size:12px;margin-bottom:0}
  input,select,textarea{
    width:100%;padding:3px 6px;border:var(--thin) solid var(--line);border-radius:8px;background:var(--surface);color:var(--ink);font-size:13px;min-height:30px
  }
  input[type=file]{padding:4px}
  .muted{color:var(--muted);font-size:12px}
  .actions{display:flex;gap:6px;flex-wrap:wrap;align-items:center}
  .btn{ appearance:none;border-radius:8px;padding:6px 9px;font-weight:600;cursor:pointer;background:var(--surface);border:var(--thin) solid var(--line);color:var(--ink);font-size:13px }
  .btn.primary{background:var(--brand);border-color:var(--brand);color:#fff}
  .btn.link{border:none;background:transparent;color:var(--brand);padding:0}
  .btn.danger{border-color:var(--danger);color:var(--danger);background:transparent}
  .btn.sm{padding:3px 7px;font-size:12px}
  table{width:100%;border-collapse:collapse;table-layout:fixed}
  th,td{border:1px solid var(--line);padding:1px 3px;text-align:center}
  th{background:#f3f6fb}

  /* Etiquetas izquierda más delgadas */
  .table-wrap tbody th{font-weight:400 !important;text-align:left;padding:1px 8px;font-size:12px;line-height:1.15}

  /* Cabecera: input de hora más grande (fijo a 2 controles) */
  .colhdr{position:relative;padding-top:2px;padding-bottom:2px}
  .hdr-time{display:block;margin-top:2px;font-size:14px;min-height:36px}

  .line{height:1px;background:var(--line);margin:6px 0}
  .footer{font-size:12px;color:var(--muted);margin-top:6px}
  .container-card{border:1px solid var(--line);border-radius:10px;padding:8px;margin-bottom:8px;background:var(--surface)}
  .container-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;gap:8px}
  .container-head h3{margin:0;font-size:14px;font-weight:600}
  .uploader{border:1px dashed var(--line);background:#fbfdff;border-radius:8px;padding:8px;margin-top:6px}
  .thumbs{display:grid;grid-template-columns:repeat(auto-fill,minmax(110px,1fr));gap:8px;margin-top:6px}
  .thumb{background:var(--surface);border:1px solid var(--line);border-radius:8px;overflow:hidden;position:relative}
  .thumb img{display:block;width:100%;height:72px;object-fit:cover}
  .thumb .meta{padding:5px 6px;font-size:11px;color:var(--muted)}
  .thumb .x{position:absolute;top:5px;right:5px;background:transparent;border:1px solid var(--danger);color:var(--danger);
    width:22px;height:22px;border-radius:6px;display:flex;align-items:center;justify-content:center;font-weight:900;cursor:pointer}

  .overlay{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;z-index:9998}
  .overlay.show{display:block}
  .sheet{position:fixed;left:0;right:0;bottom:-100%;background:#fff;border-top-left-radius:14px;border-top-right-radius:14px;box-shadow:0 -12px 30px rgba(0,0,0,.25);padding:16px;transition:bottom .25s;z-index:9999}
  .sheet.show{bottom:0}
  .sheet .row-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}

  .rowlbl{font-weight:400}

  /* Primera columna semántica */
  .firstcol{
    width:32%;
    text-align:left;
    padding-left:10px;
    white-space:nowrap;
  }

  /* === Mejoras específicas para móvil (≤600px) === */
  @media (max-width: 600px){
    .table-wrap{ overflow-x:auto; -webkit-overflow-scrolling:touch; }
    .table-wrap table{ min-width: 560px; } /* 2 controles sin aplaste */

    .firstcol{ width:28%; font-size:12px; }
    .table-wrap tbody th{ font-size:11px; padding:2px 6px; white-space:nowrap; }

    .table-wrap td input{ min-height:40px; font-size:16px; }
    .hdr-time{ font-size:16px; min-height:40px; }

    input, select, textarea{ font-size:16px; } /* evita zoom iOS */
    .row{ grid-template-columns:1fr; }
    .g3, .g2{ grid-template-columns:1fr; }

    #containers .row{ grid-template-columns: 1fr !important; gap: 4px; }
    #containers label{ font-size: 12px; margin-bottom: 2px; }
    #containers .row > div[style*="display:flex"]{ flex-wrap: wrap; }
    #containers [name$="_naviera_otra"]{ width: 100%; margin-top: 4px; }
  }
  /* === FIN móvil === */
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>REPORTE TRATAMIENTO DE FRÍO — COT (Digital)</h1>
    <div class="meta">2 controles obligatorios con hora en encabezado • Fotos/Datalog por unidad • Máx. 3 contenedores</div>
  </header>

  <form id="cotForm" novalidate>
    <div class="card">
      <div class="sectitle">Encabezado</div>
      <div class="grid g3">
        <div class="row"><label>FOLIO</label><input name="folio" required placeholder="Ej: 000123"></div>
        <div class="row"><label>Fecha servicio</label><input type="date" name="fecha_servicio" required></div>
        <div class="row"><label>Hora de llegada Planta</label><input type="time" step="60" name="hora_llegada" required></div>
        <div class="row"><label>Hora inicio primera calibración</label><input type="time" step="60" name="hora_inicio_cal" required></div>
        <div class="row"><label>Hora término servicio</label><input type="time" step="60" name="hora_termino" required></div>
      </div>
    </div>

    <div class="card">
      <div class="sectitle">Contenedores</div>
      <div id="containers"></div>
      <div class="actions">
        <button type="button" class="btn link" id="addContainerBtn">+ Añadir contenedor</button>
      </div>
    </div>

    <div class="card">
      <div class="sectitle">Datos generales finales</div>
      <div class="grid g2">
        <div class="row"><label>Nombre del técnico</label><input name="tecnico" required></div>
        <div class="row"><label>Planta / Dirección</label><input name="planta" required></div>
        <div class="row"><label>Responsable Packing</label><input name="responsable_packing" required></div>
        <div class="row"><label>Viaje / Embarque</label><input name="viaje" placeholder="Ej: 234N"></div>
        <div class="row" style="grid-column:1/-1"><label>Comentarios</label><textarea name="comentarios" rows="3" placeholder="Observaciones, novedades, etc."></textarea></div>
      </div>
    </div>

    <div class="card">
      <div class="sectitle">Documentos de Planta (Hoja firmada) — General</div>
      <div class="uploader">
        <div class="actions">
          <!-- Cámara o galería -->
          <input id="pickDocPlanta" type="file" style="display:none">
          <button type="button" class="btn" id="btnDocPlanta">Añadir fotos del documento</button>
          <button type="button" class="btn danger" id="btnDocPlantaClear">Borrar todas</button>
          <span class="muted">Obligatorio. Se comprimen a 1200×900 ≤400 KB c/u.</span>
        </div>
        <div class="thumbs" id="thumbsDocPlanta"></div>
      </div>
    </div>

    <div class="card">
      <div class="actions">
        <button type="button" class="btn" id="testBtn">Probar validaciones</button>
        <button type="submit" class="btn primary">Enviar reporte</button>
      </div>
      <div class="footer" id="msg">Listo para enviar.</div>
    </div>
  </form>
</div>

<div id="overlay" class="overlay"></div>
<div id="mSheet" class="sheet"></div>

<script>
const $ = s=>document.querySelector(s);
const $$ = s=>Array.from(document.querySelectorAll(s));

let uid = 0;
const photoStores = new Map();
const datalogStore = new Map();
let plantaDocs = [];

function truncate(s,n){ return s.length>n ? s.slice(0,n-1)+'…' : s; }
function safeName(s){ return (s||'FILE').replace(/[^\w\.\-]+/g,'_'); }
const MAX_W=760, MAX_H=600, MAX_SIZE=150*1024;
const MAX_W_DOC=1200, MAX_H_DOC=900, MAX_SIZE_DOC=400*1024;

async function compressImage(file, {w=MAX_W, h=MAX_H, max=MAX_SIZE}={}){
  if(!file.type.startsWith('image/')) return file;
  const bitmap = await createImageBitmap(file);
  let W=bitmap.width,H=bitmap.height;
  const ratio=Math.min(w/W, h/H, 1); W=Math.round(W*ratio); H=Math.round(H*ratio);
  const canvas=document.createElement('canvas'); canvas.width=W; canvas.height=H;
  const ctx=canvas.getContext('2d'); ctx.drawImage(bitmap,0,0,W,H);
  let q=0.9; let blob=await new Promise(r=>canvas.toBlob(r,'image/jpeg',q));
  while(blob && blob.size>max && q>0.6){ q-=0.05; blob=await new Promise(r=>canvas.toBlob(r,'image/jpeg',q)); }
  if(!blob) return file;
  return new File([blob], file.name.replace(/\.[^.]+$/i,'.jpg'), {type:'image/jpeg'});
}

function mobileConfirm(message, onOK){
  const ovl = document.getElementById('overlay');
  const sh  = document.getElementById('mSheet');
  sh.innerHTML = `
    <div style="font-weight:700;margin-bottom:8px">Confirmar</div>
    <div class="muted" style="margin-bottom:10px">${message}</div>
    <div class="row-actions">
      <button type="button" class="btn" id="mCancel">Cancelar</button>
      <button type="button" class="btn danger" id="mOk">Aceptar</button>
    </div>`;
  ovl.classList.add('show'); sh.classList.add('show');
  const close = ()=>{ ovl.classList.remove('show'); sh.classList.remove('show'); };
  document.getElementById('mCancel').onclick = close;
  document.getElementById('mOk').onclick = ()=>{ close(); onOK && onOK(); };
  ovl.onclick = close;
}

function buildTableFixed2(id){
  const colsHdr = ['1° control','2° control']; // fijos y obligatorios
  const filas = [
    ['USDA 1 (°C)','usda1'],
    ['USDA 2 (°C)','usda2'],
    ['USDA 3 (°C)','usda3'],
    ['Set Point (°C)','sp'],
    ['Temperatura Suministro (°C)','sup'],
    ['Temperatura Retorno (°C)','ret']
  ];
  const dataW = Math.max(12, Math.floor(60/colsHdr.length));
  let html = '<table><thead><tr>';
  html += '<th class="firstcol">Hora control temperatura</th>';
  colsHdr.forEach((h,i)=>{
    html += `<th class="colhdr" style="width:${dataW}%">
              ${h}
              <input class="hdr-time" type="time" step="60" name="c${id}_ht_${i}" required>
            </th>`;
  });
  html += '</tr></thead><tbody>';
  filas.forEach(([label,key])=>{
    html += '<tr><th style="text-align:left;padding-left:10px;font-weight:700">'+label+'</th>';
    for(let c=0;c<colsHdr.length;c++){
      const name = `c${id}_${key}_${c}`;
      html += `<td><input type="text" name="${name}"></td>`;
    }
    html += '</tr>';
  });
  html += '</tbody></table>';
  return html;
}
function readHeaderTimes(card){
  const arr=[];
  for(let i=0;i<2;i++){
    const inp = card.querySelector(`input[name="c${card.dataset.uid}_ht_${i}"]`);
    arr[i] = inp ? inp.value : '';
  }
  return arr;
}

function readTableValues(card){
  const keys=['usda1','usda2','usda3','sp','sup','ret'];
  const vals={}; keys.forEach(k=> vals[k]=[]);
  const id = card.dataset.uid;
  for(let c=0;c<2;c++){
    keys.forEach(key=>{
      const name=`c${id}_${key}_${c}`;
      const inp=card.querySelector(`input[name="${name}"]`);
      vals[key][c]= inp? inp.value : '';
    });
  }
  return vals;
}

function restoreValues(card, vals, hrs){
  const id = card.dataset.uid;
  hrs.forEach((v,i)=>{ const inp = card.querySelector(`input[name="c${id}_ht_${i}"]`); if(inp) inp.value = v || ''; });
  Object.keys(vals).forEach(key=>{
    vals[key].forEach((v,i)=>{
      const name = `c${id}_${key}_${i}`;
      const inp = card.querySelector(`input[name="${name}"]`);
      if(inp) inp.value = v || '';
    });
  });
}

function enforceFirstNotDeletable(){
  const cards = $$('#containers .container-card');
  cards.forEach((c,i)=>{
    const del = c.querySelector('[data-del]');
    if(del) del.style.display = (i===0 ? 'none' : '');
  });
}

function updateAddButtonState(){
  const btn = $('#addContainerBtn');
  const count = $$('#containers .container-card').length;
  if(count >= 3){ btn.disabled = true; btn.textContent = 'Máx. 3 contenedores'; }
  else { btn.disabled = false; btn.textContent = '+ Añadir contenedor'; }
}

function addContainer(){
  if($$('#containers .container-card').length >= 3){ updateAddButtonState(); return; }

  uid++;
  const id = uid;
  photoStores.set(id, []); datalogStore.set(id, null);

  const card = document.createElement('div');
  card.className='container-card';
  card.dataset.uid = id;

  card.innerHTML = `
    <div class="container-head">
      <h3 data-title>Contenedor</h3>
      <div class="actions">
        <button type="button" class="btn danger sm" data-del>Eliminar contenedor</button>
      </div>
    </div>

    <div class="grid g3">
      <div class="row"><label>N° CONTENEDOR</label><input name="c${id}_container" required placeholder="Ej: TBUU1234567" pattern="[A-Za-z]{4}\\d{7}" title="Formato ABCD1234567 (4 letras + 7 dígitos)"></div>
      <div class="row"><label>N° BOOKING</label><input name="c${id}_booking" required></div>
      <div class="row"><label>Naviera</label>
        <div style="display:flex;gap:4px">
          <select name="c${id}_naviera_sel" required>
            <option value="">Selecciona…</option>
            <option>Maersk Line</option>
            <option>Hapag Lloyd</option>
            <option>Cosco Shipping</option>
            <option>Pil</option>
            <option>Otra</option>
          </select>
          <input name="c${id}_naviera_otra" class="input-naviera-otra hidden" placeholder="Especifique…">
        </div>
      </div>
    </div>

    <div class="line"></div>

    <div class="table-wrap">${buildTableFixed2(id)}</div>

    <div class="uploader">
      <div class="sectitle" style="margin:6px 0 4px">Fotos de esta unidad</div>
      <div class="actions">
        <!-- Cámara o galería -->
        <input id="pickFotos_${id}" type="file" multiple style="display:none">
        <button type="button" class="btn sm" data-pickfotos>Añadir fotos</button>
        <button type="button" class="btn danger sm" data-cleanfotos>Borrar todas</button>
        <span class="muted">Se comprimen a 760×600 ≤150 KB c/u.</span>
      </div>
      <div class="thumbs" id="thumbs_${id}"></div>
    </div>

    <div class="uploader">
      <div class="sectitle" style="margin:6px 0 4px">Data logger (esta unidad)</div>
      <div class="actions">
        <input id="pickDatalog_${id}" type="file" style="display:none">
        <button type="button" class="btn sm" data-pickdatalog>Subir/Reemplazar</button>
        <button type="button" class="btn danger sm" data-cleandatalog>Eliminar</button>
        <span class="muted" id="datalogInfo_${id}">Sin archivo.</span>
      </div>
    </div>
  `;

  // DELEGACIÓN: clicks del card
  card.addEventListener('click', (ev)=>{
    const t = ev.target;

    if(t.matches('[data-del]')){
      if(card.parentElement){
        mobileConfirm('¿Eliminar este contenedor?', ()=>{
          const id = Number(card.dataset.uid);
          photoStores.delete(id); datalogStore.delete(id);
          card.remove(); reindexTitles(); enforceFirstNotDeletable(); updateAddButtonState();
        });
      }
    }

    if(t.matches('[data-pickfotos]')){ card.querySelector('#pickFotos_'+id).click(); }
    if(t.matches('[data-cleanfotos]')){
      const store = photoStores.get(id)||[];
      if(!store.length) return;
      mobileConfirm('¿Borrar todas las fotos de esta unidad?', ()=>{
        store.length=0; renderThumbs(id, card.querySelector('#thumbs_'+id));
      });
    }
    if(t.matches('[data-pickdatalog]')){ card.querySelector('#pickDatalog_'+id).click(); }
    if(t.matches('[data-cleandatalog]')){
      if(!datalogStore.get(id)) return;
      mobileConfirm('¿Eliminar archivo datalog?', ()=>{
        datalogStore.set(id,null);
        card.querySelector('#datalogInfo_'+id).textContent='Sin archivo.';
      });
    }
  });

  // Cambios en select "Otra"
  card.addEventListener('change', (ev)=>{
    const t=ev.target;
    if(t.name===`c${id}_naviera_sel`){
      const otra = card.querySelector(`[name="c${id}_naviera_otra"]`);
      const show = t.value==='Otra';
      otra.style.display = show? 'block':'none';
      if(show) otra.focus();
    }
  });

  // File inputs (change)
  card.querySelector('#pickFotos_'+id).addEventListener('change', async (e)=>{
    const files = Array.from(e.target.files||[]);
    if(!files.length) return;
    const store = photoStores.get(id)||[];
    for(const f of files){
      const c = await compressImage(f);
      store.push({name:safeName(f.name).replace(/\.[^.]+$/i,'.jpg'), file:c, size:c.size});
    }
    photoStores.set(id, store); renderThumbs(id, card.querySelector('#thumbs_'+id)); e.target.value='';
  });
  card.querySelector('#pickDatalog_'+id).addEventListener('change', (e)=>{
    const f=(e.target.files||[])[0]; if(!f) return;
    datalogStore.set(id,f); card.querySelector('#datalogInfo_'+id).textContent=`${f.name} · ${(f.size/1024).toFixed(0)} KB`; e.target.value='';
  });

  $('#containers').appendChild(card);
  reindexTitles(); enforceFirstNotDeletable(); updateAddButtonState();
}

function reindexTitles(){ $$('#containers .container-card').forEach((c,idx)=>{ c.querySelector('[data-title]').textContent = `Contenedor #${idx+1}`; }); }

function renderThumbs(id, host){
  const store = photoStores.get(Number(id)) || [];
  host.innerHTML='';
  if(!store.length){ host.innerHTML='<div class="muted">Sin fotos.</div>'; return; }
  store.forEach((p,i)=>{
    const url = URL.createObjectURL(p.file);
    const card = document.createElement('div');
    card.className='thumb';
    card.innerHTML = `
      <img src="${url}" alt="foto ${i+1}">
      <div class="x" title="Eliminar" data-x="${i}">×</div>
      <div class="meta">${truncate(p.name,22)} · ${(p.size/1024).toFixed(0)} KB</div>`;
    host.appendChild(card);
    card.querySelector('.x').addEventListener('click', ()=>{
      URL.revokeObjectURL(url);
      store.splice(i,1); renderThumbs(id, host);
    });
  });
}

// Init
addContainer();
document.getElementById('addContainerBtn').addEventListener('click', addContainer);

// Documentos de planta
const pickDocPlanta = $('#pickDocPlanta');
const thumbsDocPlanta = $('#thumbsDocPlanta');
$('#btnDocPlanta').addEventListener('click', ()=> pickDocPlanta.click());
$('#btnDocPlantaClear').addEventListener('click', ()=>{
  if(!plantaDocs.length) return;
  mobileConfirm('¿Borrar todos los documentos de planta?', ()=>{ plantaDocs.length=0; renderPlantaDocs(); });
});
pickDocPlanta.addEventListener('change', async ()=> {
  const f = (pickDocPlanta.files || [])[0];
  if(!f) return;

    const c = await compressImage(f, {w:MAX_W_DOC, h:MAX_H_DOC, max:MAX_SIZE_DOC});
    plantaDocs.length = 0;
    plantaDocs.push({ name: safeName(f.name).replace(/\.[^.]+$/i,'.jpg'), file:c, size:c.size });
    renderPlantaDocs();
    pickDocPlanta.value = '';
});

function renderPlantaDocs(){
  thumbsDocPlanta.innerHTML='';
  if(!plantaDocs.length){ thumbsDocPlanta.innerHTML='<div class="muted">Sin archivos.</div>'; return; }
  plantaDocs.forEach((p,i)=>{
    const url = URL.createObjectURL(p.file);
    const card = document.createElement('div');
    card.className='thumb';
    card.innerHTML = `
      <img src="${url}" alt="doc ${i+1}">
      <div class="x" title="Eliminar" data-x="${i}">×</div>
      <div class="meta">${truncate(p.name,22)} · ${(p.size/1024).toFixed(0)} KB</div>`;
    thumbsDocPlanta.appendChild(card);
    card.querySelector('.x').addEventListener('click', ()=>{
      URL.revokeObjectURL(url);
      plantaDocs.splice(i,1); renderPlantaDocs();
    });
  });
}

// Validaciones y envío
function validForm(){
  const need = ['folio','fecha_servicio','hora_llegada','hora_inicio_cal','hora_termino','tecnico','planta','responsable_packing'];
  for(const n of need){ if(!$(`[name="${n}"]`).value) return {ok:false,msg:'Completa los datos generales obligatorios.'}; }
  const cards = $$('#containers .container-card');
  if(!cards.length) return {ok:false,msg:'Agrega al menos un contenedor.'};
  for(const card of cards){
    const id = card.dataset.uid;
    const cont = $(`[name="c${id}_container"]`).value.trim().toUpperCase();
    const book = $(`[name="c${id}_booking"]`).value.trim();
    if(!/^[A-Z]{4}\d{7}$/.test(cont)) return {ok:false,msg:'N° Contenedor inválido (ABCD1234567).'};
    if(!book) return {ok:false,msg:'Falta N° Booking.'};
    const navSel  = $(`[name="c${id}_naviera_sel"]`);
    const navOtra = $(`[name="c${id}_naviera_otra"]`);
    if(navSel){
      if(!navSel.value) return {ok:false,msg:'Seleccione la naviera.'};
      if(navSel.value==='Otra' && !navOtra.value.trim()) return {ok:false,msg:'Indique la naviera (Otra).'};
    }
    // horas obligatorias para 2 controles
    for(let i=0;i<2;i++){
      const t = card.querySelector(`input[name="c${id}_ht_${i}"]`);
      if(!t || !t.value) return {ok:false,msg:'Indique las horas de ambos controles.'};
    }
  }
  if(plantaDocs.length===0) return {ok:false,msg:'Debes adjuntar al menos 1 foto del documento de planta.'};
  return {ok:true};
}

$('#testBtn').addEventListener('click', ()=>{
  if(!$('#cotForm').reportValidity()){ $('#msg').textContent='Revisa campos marcados.'; return; }
  const v = validForm(); $('#msg').textContent = v.ok ? 'Validaciones OK.' : v.msg;
});

$('#cotForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  if(!$('#cotForm').reportValidity()){ $('#msg').textContent='Revisa campos marcados.'; return; }
  const v = validForm(); if(!v.ok){ $('#msg').textContent=v.msg; return; }
  const payload = await buildPayload();
  console.log('Payload COT:', payload);
  $('#msg').textContent = 'OK. Payload listo (ver consola).';
});
</script>
</body>
</html>
