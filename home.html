<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>MAERSK ‚Äî Principal</title>
<style>
:root{
  --brand:#0b74c7; --bg:#f6f8fb; --ink:#0f172a; --muted:#6b7280;
  --card:#fff; --line:#e5e7eb; --radius:12px;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.4 system-ui,Segoe UI,Roboto,Helvetica,Arial}
.wrap{max-width:1200px;margin:0 auto;padding:16px}

/* Card compacta */
.card{background:#fff;border:1px solid var(--line);border-radius:var(--radius);box-shadow:0 6px 18px rgba(0,0,0,.05)}
header{padding:10px 12px;border-bottom:1px solid var(--line);display:flex;gap:8px;align-items:center;justify-content:space-between;flex-wrap:wrap}
header h1{margin:0;font-size:16px}
.toolbar{display:flex;flex-wrap:wrap;gap:8px}
.right{margin-left:auto}

.pill{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border:1px solid var(--line);border-radius:999px;background:#fff;font-size:12px}
.btn{border:1px solid var(--line);background:#fff;border-radius:10px;padding:8px 12px;cursor:pointer}
.btn.primary{background:var(--brand);color:#fff;border-color:var(--brand)}
.btn:disabled{opacity:.6;cursor:not-allowed}

.section{padding:10px 12px}

/* Banda de estado */
.band{margin:10px 12px 0;background:#ecfdf5;border:1px solid #10b981;color:#065f46;border-radius:10px;padding:8px 10px;font-size:13px;display:none}
.band.warn{background:#fffbeb;border-color:#f59e0b;color:#92400e}

/* Barra superior (filtros + b√∫squeda) */
.controls{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap}
.ctrl-left{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.ctrl-right{display:flex;gap:8px;align-items:center}
.search{position:relative}
.search input{border:1px solid #dbe2ea;border-radius:10px;padding:8px 34px 8px 30px;font:inherit;background:#fff;min-width:260px}
.search:before{content:"üîé";position:absolute;left:10px;top:50%;transform:translateY(-50%);font-size:14px;opacity:.55}

/* Tabla compacta */
.table-wrap{overflow:auto}
table{width:100%;border-collapse:separate;border-spacing:0}
thead th{
  position:sticky;top:0;background:#f9fbfe;border-bottom:1px solid var(--line);
  font-weight:600;padding:8px 8px;z-index:1;text-align:left;white-space:nowrap
}
tbody td{border-bottom:1px dashed #eef2f7;padding:7px 8px;vertical-align:middle}
tbody tr:hover{background:#fafcff}

/* Anchos y alineaci√≥n */
th.w-date{width:120px}
th.w-cont{width:160px}
th.w-gate{width:100px;text-align:center}
th.w-ship{width:160px}
th.w-type{width:110px;text-align:center}
th.w-danos{width:80px;text-align:center}
th.w-photos{width:80px;text-align:center}
th.w-status{width:110px;text-align:center}

td.t-center{text-align:center}
td.t-right{text-align:right}

/* Chips */
.badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid #cbd5e1;background:#fff}
.b-pend{border-color:#f59e0b;color:#92400e;background:#fffbeb}
.b-send{border-color:#10b981;color:#065f46;background:#ecfdf5}
.b-fail{border-color:#ef4444;color:#7f1d1d;background:#fef2f2}
.b-prog{border-color:#3b82f6;color:#1e3a8a;background:#eff6ff}

.gate-in{border:1px solid #10b981;color:#065f46;background:#ecfdf5;border-radius:999px;padding:2px 10px;font-size:12px}
.gate-out{border:1px solid #ef4444;color:#7f1d1d;background:#fef2f2;border-radius:999px;padding:2px 10px;font-size:12px}

/* Paginaci√≥n abajo (tipo AEMS) */
.pagerbar{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px 12px;border-top:1px solid var(--line)}
.pager{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.pagebtn{border:1px solid var(--line);background:#fff;border-radius:8px;padding:6px 10px;cursor:pointer}
.pagebtn[disabled]{opacity:.6;cursor:not-allowed}
.pp-wrap{display:flex;align-items:center;gap:8px}
.pp-wrap select{border:1px solid #dbe2ea;border-radius:8px;padding:6px 24px 6px 10px;background:#fff}
.info{color:var(--muted);font-size:12px}

/* Toast */
.toast{position:fixed;left:12px;right:12px;bottom:12px;padding:10px 12px;border:1px solid #dbe2ea;border-radius:10px;background:#ffffffcc;backdrop-filter:blur(8px);display:none;z-index:9999}

/* Badge de cola */
.qbadge{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border:1px solid var(--line);border-radius:999px;background:#fff;font-size:12px}
.qbadge .dot{width:8px;height:8px;border-radius:999px;background:#22c55e}
.qbadge.warn .dot{background:#f59e0b}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <header>
      <h1>MAERSK ‚Äî Principal</h1>
      <div class="toolbar right">
        <span id="badge" class="pill">‚Äî</span>
        <span id="queueBadge" class="qbadge" title="√çtems sin enviar"><span class="dot"></span> Cola: <strong id="queueCount">0</strong></span>
        <button id="btnNew" class="btn primary">+ Nueva inspecci√≥n</button>
        <button id="btnProfile" class="btn">Mi perfil</button>
        <button id="btnLogout" class="btn">Cerrar sesi√≥n</button>
      </div>
    </header>

    <!-- Banda √öltima enviada -->
    <div id="bandLast" class="band"></div>

    <div class="section">
      <div class="controls">
        <div class="ctrl-left">
          <button class="pill" data-st="all">All</button>
          <button class="pill" data-st="pendiente">Pendientes</button>
          <button class="pill" data-st="enviado">Enviados</button>
          <button class="pill" data-st="fallido">Fallidas</button>
        </div>
        <div class="ctrl-right">
          <div class="search"><input id="txtSearch" type="text" placeholder="Buscar contenedor / folio‚Ä¶"></div>
          <button id="btnRefresh" class="btn">Refrescar</button>
        </div>
      </div>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th class="w-date">Fecha</th>
              <th class="w-cont">Contenedor</th>
              <th class="w-gate t-center">Gate</th>
              <th class="w-ship">Naviera</th>
              <th class="w-type t-center">Tipo</th>
              <th class="w-danos t-center">Da√±os</th>
              <th class="w-photos t-center">Fotos</th>
              <th class="w-status t-center">Status</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <div class="pagerbar">
        <div class="pager">
          <button id="prev" class="pagebtn">¬´ Anterior</button>
          <span id="pageInfo" class="pill">P√°gina 1/1</span>
          <button id="next" class="pagebtn">Siguiente ¬ª</button>
        </div>
        <div class="pp-wrap">
          <span class="info">Per page</span>
          <select id="perPage">
            <option value="10">10</option>
            <option value="20" selected>20</option>
            <option value="50">50</option>
            <option value="100">100</option>
            <option value="200">200</option>
          </select>
          <span id="countInfo" class="info">‚Äî</span>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="toast" class="toast"></div>

<script>
/* === CONFIG === */
const GAS_URL='https://script.google.com/macros/s/AKfycby2FX9r_Bd2H0x-wCgcmJj-WmGfKtQza36OfRqelUpSnDLv34Oh1bAih65y575GnfvtDg/exec';

/* === UTILS === */
const $=q=>document.querySelector(q);
let tmo; function toast(m){const el=$("#toast");el.textContent=m;el.style.display='block';clearTimeout(tmo);tmo=setTimeout(()=>el.style.display='none',2200);}

/* === AUTH GATE === */
const user=localStorage.getItem('auth_user'); const role=localStorage.getItem('auth_role');
if(!user||!role){ location.href='login.html'; }
$("#badge").textContent = `üë§ ${user} ¬∑ ${role.toUpperCase()}`;

/* === NAV === */
$("#btnLogout").onclick=()=>{localStorage.removeItem('auth_user');localStorage.removeItem('auth_role');location.href='login.html';};
$("#btnNew").onclick=()=> location.href='inspect.html';
$("#btnProfile").onclick=()=> toast("Configura t√©cnico/vendor en la p√°gina de inspecci√≥n.");
$("#btnRefresh").onclick=()=> loadData();

/* === STATE === */
let all=[], filtered=[], page=1, per=Number(localStorage.getItem('home_per')||20), status=localStorage.getItem('home_status')||'all';
$("#perPage").value=String(per);

/* === FILTROS === */
document.querySelectorAll('[data-st]').forEach(b=>{
  if(b.dataset.st===status) b.classList.add('btn');
  b.onclick=()=>{ status=b.dataset.st; localStorage.setItem('home_status',status); document.querySelectorAll('[data-st]').forEach(x=>x.classList.remove('btn')); b.classList.add('btn'); page=1; render(); };
});

/* === API === */
async function apiGet(fn, params={}){
  const u=new URL(GAS_URL); u.searchParams.set('fn',fn);
  Object.entries(params).forEach(([k,v])=>u.searchParams.set(k,v));
  const r=await fetch(u.toString()); return r.json();
}

/* === IndexedDB (para contador de cola) === */
const DB='reefer_inspections_db', VER=1, STORE='queue';
function idbOpen(){
  return new Promise((res,rej)=>{
    const r=indexedDB.open(DB,VER);
    r.onupgradeneeded=()=>{ const db=r.result; if(!db.objectStoreNames.contains(STORE)){ db.createObjectStore(STORE,{keyPath:'id'});} };
    r.onsuccess=()=>res(r.result);
    r.onerror=()=>rej(r.error);
  });
}
async function queueCount(){
  const db=await idbOpen(); const tx=db.transaction(STORE,'readonly'); const store=tx.objectStore(STORE); const req=store.getAllKeys();
  return new Promise((res)=>{ req.onsuccess=()=>{ db.close(); res(req.result.length||0); }; });
}
async function refreshQueueBadge(){
  const n = await queueCount();
  const el=$("#queueCount"); if(el) el.textContent=String(n);
  const badge=$("#queueBadge");
  if(badge){
    badge.classList.toggle('warn', n>0);
    badge.title = n>0 ? `Tienes ${n} √≠tem(s) pendiente(s) por enviar` : 'Sin pendientes';
  }
}

/* === Banda ‚Äú√∫ltima enviada‚Äù === */
function showLastSent(){
  const id = localStorage.getItem('last_sent_id');
  const unit = localStorage.getItem('last_sent_unit');
  const band = $("#bandLast");
  if(unit){
    band.textContent = `‚úÖ √öltima enviada: ${unit} (ID ${id||'-'})`;
    band.style.display='block';
    // se limpia sola luego de unos segundos
    setTimeout(()=>{ band.style.display='none'; localStorage.removeItem('last_sent_id'); localStorage.removeItem('last_sent_unit'); }, 5000);
  }else{
    band.style.display='none';
  }
}

/* === LOAD DATA === */
async function loadData(){
  const btn=$("#btnRefresh"), txt=btn.textContent; btn.disabled=true; btn.textContent='Cargando‚Ä¶';
  try{
    const res=await apiGet('getinspections');
    if(!res?.ok){ toast("No se pudo cargar desde la hoja"); return; }
    all = res.items||[];
    render();
  }finally{ btn.disabled=false; btn.textContent=txt; }
}

/* === HELPERS DE RENDER === */
function gateChip(val){
  const v = String(val || '').trim().toUpperCase();
  if (v==='IN' || v==='GATE IN' || v==='GATEIN' || v.includes('IN'))  return '<span class="gate-in">GATE IN</span>';
  if (v==='OUT' || v==='GATE OUT' || v==='GATEOUT' || v.includes('OUT')) return '<span class="gate-out">GATE OUT</span>';
  return '<span class="pill" style="font-size:12px;padding:2px 8px">‚Äî</span>';
}
function statusBadge(v){
  const s=String(v||'').toLowerCase();
  const cls = s==='pendiente'?'b-pend' : s==='enviando'?'b-prog' : s==='enviado'?'b-send' : 'b-fail';
  return `<span class="badge ${cls}">${s||''}</span>`;
}

/* === RENDER === */
function render(){
  const q=($("#txtSearch").value||'').trim().toUpperCase();

  filtered = (all||[]).filter(x=> (x.container||x.folio||x.folderUrl));
  if(status!=='all') filtered=filtered.filter(x=> (String(x.status||'').toLowerCase()===status));
  if(q) filtered=filtered.filter(x=> (String(x.container||'').toUpperCase().includes(q) || String(x.folio||'').toUpperCase().includes(q)));

  filtered.sort((a,b)=> (String(a.fecha)<String(b.fecha)?1:-1));

  const tb=$("#tbody"); tb.innerHTML='';
  const total=filtered.length; const pages=Math.max(1,Math.ceil(total/per)); if(page>pages) page=pages;
  const ini=(page-1)*per, fin=Math.min(total,ini+per);

  for(let i=ini;i<fin;i++){
    const r=filtered[i];
    const danos  = (r.linesCount ?? r.danosCount ?? (Array.isArray(r.lines)? r.lines.length : 0)) || 0;
    const fotos  = (r.photosCount ?? r.fotosCount ?? r.photos_total) ?? 0;

    const tr=document.createElement('tr');
    tr.innerHTML = `
      <td>${String(r.fecha||'').slice(0,10)}</td>
      <td><b>${r.container||''}</b></td>
      <td class="t-center">${gateChip(r.gate)}</td>
      <td>${r.naviera||''}</td>
      <td class="t-center">${r.tipo||''}</td>
      <td class="t-center">${danos}</td>
      <td class="t-center">${fotos}</td>
      <td class="t-center">${statusBadge(r.status)}</td>`;
    tb.appendChild(tr);
  }

  $("#pageInfo").textContent=`P√°gina ${page}/${pages}`;
  $("#countInfo").textContent=`Showing ${Math.min(fin-ini,per)} of ${total}`;
  refreshQueueBadge();
}

/* === PAGINACI√ìN / SEARCH / PER PAGE === */
$("#perPage").onchange=()=>{ per=Number($("#perPage").value||20); localStorage.setItem('home_per',String(per)); page=1; render(); }
$("#prev").onclick=()=>{ if(page>1){ page--; render(); } }
$("#next").onclick=()=>{ const pages=Math.max(1,Math.ceil(filtered.length/per)); if(page<pages){ page++; render(); } }
let sT; $("#txtSearch").addEventListener('input',()=>{ clearTimeout(sT); sT=setTimeout(()=>{ page=1; render(); },250); });

/* === INIT === */
(function init(){
  showLastSent();
  loadData();
  refreshQueueBadge();
})();
</script>
</body>
</html>
