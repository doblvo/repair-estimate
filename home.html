<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>MAERSK — Principal</title>
<style>
:root{
  --brand:#0b74c7;
  --bg:#0b1120;
  --card:#111827;
  --ink:#f9fafb;
  --muted:#9ca3af;
  --line:#1f2937;
  --radius:12px;
  --ok:#10b981;
  --warn:#f59e0b;
  --danger:#ef4444;
}
*{box-sizing:border-box}
body{
  margin:0;
  background:var(--bg);
  color:var(--ink);
  font:14px/1.4 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
}
.wrap{max-width:1200px;margin:0 auto;padding:16px}
.card{
  background:var(--card);
  border:1px solid var(--line);
  border-radius:var(--radius);
  box-shadow:0 1px 3px rgba(0,0,0,.3);
}
header{
  padding:10px 12px;
  border-bottom:1px solid var(--line);
  display:flex;
  gap:8px;
  align-items:center;
  justify-content:space-between;
  flex-wrap:wrap;
}
header h1{margin:0;font-size:16px;color:var(--ink)}
.toolbar{display:flex;flex-wrap:wrap;gap:8px}
.right{margin-left:auto}
.pill{
  display:inline-flex;align-items:center;gap:6px;
  padding:4px 10px;border:1px solid var(--line);
  border-radius:999px;background:#0f172a;font-size:12px;color:var(--muted)
}
.btn{
  border:1px solid var(--line);
  background:#0f172a;
  color:var(--ink);
  border-radius:10px;
  padding:8px 12px;
  cursor:pointer;
}
.btn.primary{background:var(--brand);border-color:var(--brand);color:#fff}
.btn:hover{opacity:.9}
.btn:disabled{opacity:.6;cursor:not-allowed}
.section{padding:10px 12px}

/* banda última enviada */
.band{
  margin:10px 12px 0;
  background:#052e1b;
  border:1px solid #14532d;
  color:#c8f3d6;
  border-radius:10px;
  padding:8px 10px;
  font-size:13px;
  display:none;
}
.band.warn{
  background:#2a0b0b;
  border-color:#7f1d1d;
  color:#fecaca;
}

/* filtros / buscador */
.controls{
  display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap;
}
.search input{
  border:1px solid var(--line);
  border-radius:10px;
  padding:8px 10px;
  font:inherit;
  background:#0f172a;
  color:var(--ink);
  min-width:240px;
}
.search input:focus{outline:1px solid var(--brand)}
/* tabla */
.table-wrap{overflow:auto}
table{
  width:100%;
  border-collapse:separate;
  border-spacing:0;
  color:var(--ink);
}
thead th{
  position:sticky;
  top:0;
  background:#0f1a2a;
  border-bottom:1px solid var(--line);
  font-weight:600;
  padding:8px 8px;
  z-index:1;
  text-align:left;
  white-space:nowrap;
}
tbody td{
  border-bottom:1px dashed #1f2937;
  padding:7px 8px;
  vertical-align:middle;
}
tbody tr:hover{background:#0f172a}
th.w-date{width:120px}
th.w-cont{width:160px}
th.w-gate{width:100px;text-align:center}
th.w-ship{width:160px}
th.w-type{width:110px;text-align:center}
th.w-danos{width:80px;text-align:center}
th.w-photos{width:80px;text-align:center}
th.w-status{width:110px;text-align:center}
th.w-actions{width:180px;text-align:center}
td.t-center{text-align:center}

/* chips */
.badge{
  display:inline-block;
  padding:2px 8px;
  border-radius:999px;
  font-size:12px;
  border:1px solid #374151;
  background:#0f172a;
}
.b-pend{border-color:var(--warn);color:var(--warn)}
.b-send{border-color:var(--ok);color:var(--ok)}
.b-fail{border-color:var(--danger);color:var(--danger)}
.b-prog{border-color:var(--brand);color:var(--brand)}
.gate-in{
  border:1px solid var(--ok);
  color:var(--ok);
  background:#052e1b;
  border-radius:999px;
  padding:2px 10px;
  font-size:12px
}
.gate-out{
  border:1px solid var(--danger);
  color:var(--danger);
  background:#2a0b0b;
  border-radius:999px;
  padding:2px 10px;
  font-size:12px
}

/* paginación */
.pagerbar{
  display:flex;align-items:center;justify-content:space-between;
  gap:10px;padding:10px 12px;border-top:1px solid var(--line)
}
.pager{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.pagebtn{
  border:1px solid var(--line);
  background:#0f172a;
  border-radius:8px;
  padding:6px 10px;
  cursor:pointer;
  color:var(--ink)
}
.pagebtn[disabled]{opacity:.6;cursor:not-allowed}
.pp-wrap{display:flex;align-items:center;gap:8px}
.pp-wrap select{
  border:1px solid var(--line);
  border-radius:8px;
  padding:6px 24px 6px 10px;
  background:#0f172a;
  color:var(--ink)
}
.info{color:var(--muted);font-size:12px}

/* toast */
.toast{
  position:fixed;
  left:12px;right:12px;bottom:12px;
  padding:10px 12px;
  border:1px solid var(--line);
  border-radius:10px;
  background:#0f172a;
  color:var(--ink);
  backdrop-filter:blur(8px);
  display:none;
  z-index:9999;
}

/* badge cola */
.qbadge{
  display:inline-flex;align-items:center;gap:6px;
  padding:4px 10px;border:1px solid var(--line);
  border-radius:999px;background:#0f172a;
  font-size:12px;cursor:pointer;color:var(--muted)
}
.qbadge .dot{
  width:8px;height:8px;border-radius:999px;background:#22c55e;
}
.qbadge.warn .dot{background:#f59e0b}

/* modal */
.modal{
  position:fixed;inset:0;
  background:rgba(0,0,0,.65);
  backdrop-filter:blur(3px);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:9998;
}
.modal .box{
  background:#111827;
  border-radius:12px;
  border:1px solid var(--line);
  padding:14px;
  max-width:900px;
  width:96%;
  max-height:90vh;
  overflow:auto;
  box-shadow:0 10px 30px rgba(0,0,0,.5);
  color:var(--ink)
}
.modal header{border:none;justify-content:space-between;padding:0 0 10px;display:flex;align-items:center}
.modal h2{margin:0;font-size:16px}
.modal table{width:100%;border-collapse:collapse;margin-top:8px}
.modal th,.modal td{border-bottom:1px solid #1f2937;padding:6px 8px;font-size:13px}
.modal th{text-align:left;background:#0f1a2a;position:sticky;top:0}
.modal .actions{margin-top:10px;display:flex;gap:8px;justify-content:flex-end}
.modal .actions .btn{padding:6px 12px;font-size:13px}

/* sobres */
.mail-icon{
  width:18px;height:18px;display:inline-block;margin:0 3px;cursor:pointer;
  border-radius:3px;border:1px solid #3f3f46;
  transition:all .15s;vertical-align:middle;
}
.mail-gray{background:#3f3f46;}
.mail-blue{background:#3b82f6;}
.mail-green{background:#10b981;}
.mail-red{background:#ef4444;}
.mail-icon:hover{transform:scale(1.1)}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <header>
      <h1>MAERSK — Principal</h1>
      <div class="toolbar right">
        <span id="badge" class="pill">—</span>
        <span id="queueBadge" class="qbadge" title="Ítems sin enviar">
          <span class="dot"></span> Cola: <strong id="queueCount">0</strong>
        </span>
        <button id="btnNew" class="btn primary">+ Nueva inspección</button>
        <button id="btnProfile" class="btn">Mi perfil</button>
        <button id="btnLogout" class="btn">Cerrar sesión</button>
      </div>
    </header>

    <div id="bandLast" class="band"></div>

    <div class="section">
      <div class="controls">
        <div>
          <button class="pill" data-st="all">Todos</button>
          <button class="pill" data-st="pendiente">Pendientes</button>
          <button class="pill" data-st="enviado">Enviados</button>
          <button class="pill" data-st="fallido">Fallidas</button>
        </div>
        <div class="search">
          <input id="txtSearch" placeholder="Buscar contenedor / naviera / inspector…">
          <button id="btnRefresh" class="btn">Refrescar</button>
        </div>
      </div>

      <div class="table-wrap">
        <table>
          <thead><tr>
            <th class="w-date">Fecha</th>
            <th class="w-cont">Contenedor</th>
            <th class="w-gate t-center">Gate</th>
            <th class="w-ship">Naviera</th>
            <th class="w-type t-center">Tipo</th>
            <th class="w-danos t-center">Daños</th>
            <th class="w-photos t-center">Fotos</th>
            <th class="w-status t-center">Status</th>
            <th class="w-actions t-center">Acción</th>
          </tr></thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
      <div class="pagerbar">
        <div class="pager">
          <button id="prev" class="pagebtn">« Anterior</button>
          <span id="pageInfo" class="pill">Página 1/1</span>
          <button id="next" class="pagebtn">Siguiente »</button>
        </div>
        <div class="pp-wrap">
          <span class="info">Por página</span>
          <select id="perPage">
            <option value="10">10</option>
            <option value="20" selected>20</option>
            <option value="50">50</option>
            <option value="100">100</option>
          </select>
          <span id="countInfo" class="info">—</span>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Toast -->
<div id="toast" class="toast"></div>

<!-- Modal Cola -->
<div id="modalQueue" class="modal">
  <div class="box">
    <header>
      <h2>Cola local de inspecciones</h2>
      <button id="btnCloseModal" class="btn">✕</button>
    </header>
    <table id="tblQueue">
      <thead><tr>
        <th><input type="checkbox" id="chkAll"></th>
        <th>Contenedor</th><th>Fecha</th><th>Líneas</th><th>Fotos</th><th>Status</th>
      </tr></thead>
      <tbody></tbody>
    </table>
    <div class="actions">
      <button id="btnDeleteSel" class="btn">Eliminar seleccionados</button>
      <button id="btnSendSel" class="btn primary">Enviar seleccionados</button>
    </div>
  </div>
</div>

<!-- Modal Detalle -->
<div id="modalDetail" class="modal">
  <div class="box">
    <header><h2>Detalle de Inspección</h2><button id="closeDetail" class="btn">✕</button></header>
    <div id="detailBody"></div>
  </div>
</div>

<script>
const GAS_URL='https://script.google.com/macros/s/AKfycbzFILLAVxlmEJDPLh3rftc-jHIs7ygRz21krDTlNIuMnPFPHMnIKcd9rMvzEYIMWuxk4g/exec';
const $=q=>document.querySelector(q);
let tmo;function toast(m){const el=$("#toast");el.textContent=m;el.style.display='block';clearTimeout(tmo);tmo=setTimeout(()=>el.style.display='none',2200);}

/* ========= Auth ======== */
(function(){
  const u=localStorage.getItem('auth_user');
  const r=localStorage.getItem('auth_role');
  if(!u||!r){location.href='login.html';return;}
  $("#badge").textContent=`👤 ${JSON.parse(u)} · ${r.toUpperCase()}`;
})();
$("#btnLogout").onclick=()=>{localStorage.clear();location.href='login.html';};
$("#btnNew").onclick=()=>location.href='inspect.html';
$("#btnProfile").onclick=()=>toast("Configura técnico/vendor en la página de inspección.");

/* ========= Estado/UI ======== */
let all=[],filtered=[],page=1,per=20,status='all';
$("#perPage").onchange=()=>{per=Number($("#perPage").value);page=1;render();};
document.querySelectorAll('[data-st]').forEach(b=>{
  b.onclick=()=>{status=b.dataset.st;document.querySelectorAll('[data-st]').forEach(x=>x.classList.remove('btn'));
  b.classList.add('btn');page=1;render();};
});

/* ========= API ======== */
async function apiGetInspections(){
  const u=new URL(GAS_URL);u.searchParams.set('fn','getinspections');
  const r=await fetch(u);return r.json();
}

/* ========= Refrescar ======== */
$("#btnRefresh").onclick=async()=>{
  const btn=$("#btnRefresh");btn.disabled=true;btn.textContent='Cargando…';
  try{
    const res=await apiGetInspections();
    if(!res?.ok){toast("No se pudo cargar desde la hoja");return;}
    all=res.items||[];
    render();
    // 🔢 Contar pendientes
    const pendientes=all.filter(x=>String(x.status).toLowerCase()==='pendiente').length;
    $("#queueCount").textContent=pendientes;
    const badge=$("#queueBadge");
    badge.classList.toggle('warn',pendientes>0);
    badge.querySelector('.dot').style.background=pendientes>0?'#22c55e':'#3f3f46';
    badge.title=pendientes>0?`Tienes ${pendientes} pendiente(s)`:'Sin pendientes';
  }catch(e){console.error(e);toast("Error al obtener datos");}
  finally{btn.disabled=false;btn.textContent='Refrescar';}
};

/* ========= Helpers ======== */
function gateChip(v){
  v=String(v||'').toUpperCase();
  if(v.includes('IN'))return'<span class="gate-in">GATE IN</span>';
  if(v.includes('OUT'))return'<span class="gate-out">GATE OUT</span>';
  return'<span class="pill" style="font-size:12px;padding:2px 8px">—</span>';
}
function statusBadge(v){
  v=String(v||'').toLowerCase();
  const cls=v==='pendiente'?'b-pend':v==='enviado'?'b-send':v==='fallido'?'b-fail':'b-prog';
  return `<span class="badge ${cls}">${v}</span>`;
}

/* ========= Render Tabla ======== */
function render(){
  const q=($("#txtSearch").value||'').toLowerCase();
  filtered=(all||[]).filter(x=>x.container||x.naviera||x.inspector);
  if(status!=='all')filtered=filtered.filter(x=>String(x.status||'').toLowerCase()===status);
  if(q)filtered=filtered.filter(it=>(it.container||'').toLowerCase().includes(q)||
    (it.naviera||'').toLowerCase().includes(q)||(it.inspector||'').toLowerCase().includes(q));
  filtered.sort((a,b)=>String(a.fecha)<String(b.fecha)?1:-1);
  const tb=$("#tbody");tb.innerHTML='';
  const total=filtered.length,pages=Math.max(1,Math.ceil(total/per));
  if(page>pages)page=pages;const ini=(page-1)*per,fin=Math.min(total,ini+per);
  for(let i=ini;i<fin;i++){
    const r=filtered[i];
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${r.fecha?String(r.fecha).slice(0,10):''}</td>
      <td><b>${r.container||''}</b></td>
      <td class="t-center">${gateChip(r.gate)}</td>
      <td>${r.naviera||''}</td>
      <td class="t-center">${r.tipo||''}</td>
      <td class="t-center">${r.linesCount||0}</td>
      <td class="t-center">${r.photosCount||0}</td>
      <td class="t-center">${statusBadge(r.status)}</td>
      <td class="t-center">
        ${String(r.status).toLowerCase()==='pendiente'
          ?`<button class="btn" onclick="location.href='inspect.html?id=${encodeURIComponent(r.id)}'">Editar</button>`:''
        }
        <button class="btn" onclick='viewDetail(${JSON.stringify(r).replace(/"/g,'&quot;')})'>Ver</button>
      </td>`;
    tb.appendChild(tr);
  }
  $("#pageInfo").textContent=`Página ${page}/${pages}`;
  $("#countInfo").textContent=`Mostrando ${Math.min(fin-ini,per)} de ${total}`;
}

/* ========= Detalle Modal ======== */
const modalDetail=$("#modalDetail");
$("#closeDetail").onclick=()=>modalDetail.style.display='none';
modalDetail.addEventListener('click',e=>{if(e.target===modalDetail)modalDetail.style.display='none';});
function viewDetail(item){
  const el=$("#detailBody");
  el.innerHTML=`
    <div>
      <p><b>Contenedor:</b> ${item.container||'-'}<br>
      <b>Gate:</b> ${item.gate||'-'}<br>
      <b>Naviera:</b> ${item.naviera||'-'}<br>
      <b>Tipo:</b> ${item.tipo||'-'}<br>
      <b>Inspector:</b> ${item.inspector||'-'}<br>
      <b>Vendor:</b> ${item.vendor||'-'}<br>
      <b>Fecha:</b> ${item.fecha?String(item.fecha).slice(0,10):'-'}<br>
      <b>Status:</b> ${item.status||'-'}</p>
      <p><b>Daños:</b> ${item.linesCount||0} · <b>Fotos:</b> ${item.photosCount||0}</p>
    </div>`;
  modalDetail.style.display='flex';
}

/* ========= Modal Cola ======== */
const modalQueue=$("#modalQueue"),tblBody=document.querySelector("#tblQueue tbody"),chkAll=$("#chkAll");
$("#queueBadge").onclick=()=>modalQueue.style.display='flex';
$("#btnCloseModal").onclick=()=>modalQueue.style.display='none';
modalQueue.addEventListener('click',e=>{if(e.target===modalQueue)modalQueue.style.display='none';});
chkAll.onchange=()=>{tblBody.querySelectorAll('input[type="checkbox"]').forEach(x=>x.checked=chkAll.checked);};

/* ========= Pag nav ======== */
$("#prev").onclick=()=>{if(page>1){page--;render();}};
$("#next").onclick=()=>{const pgs=Math.max(1,Math.ceil(filtered.length/per));if(page<pgs){page++;render();}};
let sT;$("#txtSearch").addEventListener('input',()=>{clearTimeout(sT);sT=setTimeout(()=>{page=1;render();},200);});

/* ========= Init ======== */
(async()=>{await $("#btnRefresh").click();})();
</script>
</body>
</html>
