<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>MAERSK — Principal</title>
<style>
:root{
  --brand:#0b74c7; --bg:#f6f8fb; --ink:#0f172a; --muted:#6b7280;
  --card:#fff; --line:#e5e7eb; --radius:12px;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.4 system-ui,Segoe UI,Roboto,Helvetica,Arial}
.wrap{max-width:1200px;margin:0 auto;padding:16px}
.card{background:#fff;border:1px solid var(--line);border-radius:var(--radius);box-shadow:0 6px 18px rgba(0,0,0,.05)}
header{padding:10px 12px;border-bottom:1px solid var(--line);display:flex;gap:8px;align-items:center;justify-content:space-between;flex-wrap:wrap}
header h1{margin:0;font-size:16px}
.toolbar{display:flex;flex-wrap:wrap;gap:8px}
.right{margin-left:auto}
.pill{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border:1px solid var(--line);border-radius:999px;background:#fff;font-size:12px}
.btn{border:1px solid var(--line);background:#fff;border-radius:10px;padding:8px 12px;cursor:pointer}
.btn.primary{background:var(--brand);color:#fff;border-color:var(--brand)}
.btn:disabled{opacity:.6;cursor:not-allowed}
.section{padding:10px 12px}

/* banda */
.band{margin:10px 12px 0;background:#ecfdf5;border:1px solid #10b981;color:#065f46;border-radius:10px;padding:8px 10px;font-size:13px;display:none}
.band.warn{background:#fffbeb;border-color:#f59e0b;color:#92400e}

/* filtros */
.controls{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap}
.ctrl-left{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.ctrl-right{display:flex;gap:8px;align-items:center}
.search{position:relative}
.search input{border:1px solid #dbe2ea;border-radius:10px;padding:8px 34px 8px 30px;font:inherit;background:#fff;min-width:260px}
.search:before{content:"🔎";position:absolute;left:10px;top:50%;transform:translateY(-50%);font-size:14px;opacity:.55}

/* tabla */
.table-wrap{overflow:auto}
table{width:100%;border-collapse:separate;border-spacing:0}
thead th{position:sticky;top:0;background:#f9fbfe;border-bottom:1px solid var(--line);font-weight:600;padding:8px 8px;z-index:1;text-align:left;white-space:nowrap}
tbody td{border-bottom:1px dashed #eef2f7;padding:7px 8px;vertical-align:middle}
tbody tr:hover{background:#fafcff}
th.w-date{width:120px}
th.w-cont{width:160px}
th.w-gate{width:100px;text-align:center}
th.w-ship{width:160px}
th.w-type{width:110px;text-align:center}
th.w-danos{width:80px;text-align:center}
th.w-photos{width:80px;text-align:center}
th.w-status{width:110px;text-align:center}
th.w-actions{width:120px;text-align:center}
td.t-center{text-align:center}

/* chips */
.badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid #cbd5e1;background:#fff}
.b-pend{border-color:#f59e0b;color:#92400e;background:#fffbeb}
.b-send{border-color:#10b981;color:#065f46;background:#ecfdf5}
.b-fail{border-color:#ef4444;color:#7f1d1d;background:#fef2f2}
.b-prog{border-color:#3b82f6;color:#1e3a8a;background:#eff6ff}
.gate-in{border:1px solid #10b981;color:#065f46;background:#ecfdf5;border-radius:999px;padding:2px 10px;font-size:12px}
.gate-out{border:1px solid #ef4444;color:#7f1d1d;background:#fef2f2;border-radius:999px;padding:2px 10px;font-size:12px}

/* pager */
.pagerbar{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px 12px;border-top:1px solid var(--line)}
.pager{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.pagebtn{border:1px solid var(--line);background:#fff;border-radius:8px;padding:6px 10px;cursor:pointer}
.pagebtn[disabled]{opacity:.6;cursor:not-allowed}
.pp-wrap{display:flex;align-items:center;gap:8px}
.pp-wrap select{border:1px solid #dbe2ea;border-radius:8px;padding:6px 24px 6px 10px;background:#fff}
.info{color:var(--muted);font-size:12px}

/* toast */
.toast{position:fixed;left:12px;right:12px;bottom:12px;padding:10px 12px;border:1px solid #dbe2ea;border-radius:10px;background:#ffffffcc;backdrop-filter:blur(8px);display:none;z-index:9999}

/* badge cola */
.qbadge{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border:1px solid var(--line);border-radius:999px;background:#fff;font-size:12px;cursor:pointer}
.qbadge .dot{width:8px;height:8px;border-radius:999px;background:#22c55e}
.qbadge.warn .dot{background:#f59e0b}

/* modal cola */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.4);backdrop-filter:blur(3px);display:none;align-items:center;justify-content:center;z-index:9998}
.modal .box{background:#fff;border-radius:12px;border:1px solid var(--line);padding:14px;max-width:900px;width:96%;max-height:90vh;overflow:auto;box-shadow:0 10px 30px rgba(0,0,0,.15)}
.modal header{border:none;justify-content:space-between;padding:0 0 10px;display:flex;align-items:center}
.modal h2{margin:0;font-size:16px}
.modal table{width:100%;border-collapse:collapse;margin-top:8px}
.modal th,.modal td{border-bottom:1px solid #eee;padding:6px 8px;font-size:13px}
.modal th{text-align:left;background:#f9fafb;position:sticky;top:0}
.modal .actions{margin-top:10px;display:flex;gap:8px;justify-content:flex-end}
.modal .actions .btn{padding:6px 12px;font-size:13px}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <header>
      <h1>MAERSK — Principal</h1>
      <div class="toolbar right">
        <span id="badge" class="pill">—</span>
        <span id="queueBadge" class="qbadge" title="Ítems sin enviar"><span class="dot"></span> Cola: <strong id="queueCount">0</strong></span>
        <button id="btnNew" class="btn primary">+ Nueva inspección</button>
        <button id="btnProfile" class="btn">Mi perfil</button>
        <button id="btnLogout" class="btn">Cerrar sesión</button>
      </div>
    </header>

    <div id="bandLast" class="band"></div>

    <div class="section">
      <div class="controls">
        <div class="ctrl-left">
          <button class="pill" data-st="all">All</button>
          <button class="pill" data-st="pendiente">Pendientes</button>
          <button class="pill" data-st="enviado">Enviados</button>
          <button class="pill" data-st="fallido">Fallidas</button>
        </div>
        <div class="ctrl-right">
          <div class="search"><input id="txtSearch" type="text" placeholder="Buscar contenedor / naviera / inspector…"></div>
          <button id="btnRefresh" class="btn">Refrescar</button>
        </div>
      </div>
      <div class="table-wrap">
        <table>
          <thead><tr>
            <th class="w-date">Fecha</th>
            <th class="w-cont">Contenedor</th>
            <th class="w-gate t-center">Gate</th>
            <th class="w-ship">Naviera</th>
            <th class="w-type t-center">Tipo</th>
            <th class="w-ship">Inspector</th>
            <th class="w-ship">Vendor</th>
            <th class="w-danos t-center">Daños</th>
            <th class="w-photos t-center">Fotos</th>
            <th class="w-status t-center">Status</th>
            <th class="w-actions t-center">Acción</th>
          </tr></thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
      <div class="pagerbar">
        <div class="pager">
          <button id="prev" class="pagebtn">« Anterior</button>
          <span id="pageInfo" class="pill">Página 1/1</span>
          <button id="next" class="pagebtn">Siguiente »</button>
        </div>
        <div class="pp-wrap">
          <span class="info">Per page</span>
          <select id="perPage">
            <option value="10">10</option><option value="20" selected>20</option>
            <option value="50">50</option><option value="100">100</option><option value="200">200</option>
          </select>
          <span id="countInfo" class="info">—</span>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Toast -->
<div id="toast" class="toast"></div>

<!-- Modal Cola -->
<div id="modalQueue" class="modal">
  <div class="box">
    <header>
      <h2>Cola local de inspecciones</h2>
      <button id="btnCloseModal" class="btn">✕</button>
    </header>
    <table id="tblQueue">
      <thead><tr>
        <th><input type="checkbox" id="chkAll"></th>
        <th>Contenedor</th><th>Fecha</th><th>Líneas</th><th>Fotos</th><th>Status</th>
      </tr></thead>
      <tbody></tbody>
    </table>
    <div class="actions">
      <button id="btnDeleteSel" class="btn">Eliminar seleccionados</button>
      <button id="btnSendSel" class="btn primary">Enviar seleccionados</button>
    </div>
  </div>
</div>

<script>
/* ================== CONFIG / CONST ================== */
const GAS_URL='https://script.google.com/macros/s/AKfycbyXgHEwB2nvhue9o8qfTZVTLvsy8EVRwVg8KD3m7iJqeDS2TiTv0KyB_86IGiRezqMejw/exec';

const $=q=>document.querySelector(q);
let tmo; function toast(m){const el=$("#toast");el.textContent=m;el.style.display='block';clearTimeout(tmo);tmo=setTimeout(()=>el.style.display='none',2200);}

/* ================== AUTH GUARD ================== */
(function(){
  try{
    const u=JSON.parse(localStorage.getItem('auth_user')||'null');
    if(!u){ location.href='login.html'; return; }
  }catch(_){ location.href='login.html'; }
})();

/* Header user badge + nav */
(function(){
  const user=JSON.parse(localStorage.getItem('auth_user')||'"-"');
  const role=localStorage.getItem('auth_role')||'-';
  $("#badge").textContent = `👤 ${user} · ${role.toUpperCase()}`;
  $("#btnLogout").onclick=()=>{localStorage.removeItem('auth_user');localStorage.removeItem('auth_role');location.href='login.html';};
  $("#btnNew").onclick=()=> location.href='inspect.html';
  $("#btnProfile").onclick=()=> toast("Configura técnico/vendor en la página de inspección.");
})();

/* ================== STATE ================== */
let all=[], filtered=[], page=1, per=Number(localStorage.getItem('home_per')||20), status=localStorage.getItem('home_status')||'all';
$("#perPage").value=String(per);

/* ================== FILTROS ================== */
document.querySelectorAll('[data-st]').forEach(b=>{
  if(b.dataset.st===status) b.classList.add('btn');
  b.onclick=()=>{ status=b.dataset.st; localStorage.setItem('home_status',status); document.querySelectorAll('[data-st]').forEach(x=>x.classList.remove('btn')); b.classList.add('btn'); page=1; render(); };
});

/* ================== API ================== */
async function apiGetInspections(){
  const u=new URL(GAS_URL); u.searchParams.set('fn','getinspections');
  const r=await fetch(u.toString()); return r.json();
}

/* ================== HELPERS UI ================== */
function gateChip(val){
  const v = String(val || '').trim().toUpperCase();
  if (v==='IN' || v==='GATE IN' || v==='GATEIN' || v.includes('IN'))  return '<span class="gate-in">GATE IN</span>';
  if (v==='OUT' || v==='GATE OUT' || v==='GATEOUT' || v.includes('OUT')) return '<span class="gate-out">GATE OUT</span>';
  return '<span class="pill" style="font-size:12px;padding:2px 8px">—</span>';
}
function statusBadge(v){
  const s=String(v||'').toLowerCase();
  const cls = s==='pendiente'?'b-pend' : s==='enviando'?'b-prog' : s==='enviado'?'b-send' : 'b-fail';
  return `<span class="badge ${cls}">${s||''}</span>`;
}
function showLastSent(){
  const id = localStorage.getItem('last_sent_id');
  const unit = localStorage.getItem('last_sent_unit');
  const band = $("#bandLast");
  if(unit){
    band.textContent = `✅ Última enviada: ${unit} (ID ${id||'-'})`;
    band.style.display='block';
    setTimeout(()=>{ band.style.display='none'; localStorage.removeItem('last_sent_id'); localStorage.removeItem('last_sent_unit'); }, 5000);
  }else{
    band.style.display='none';
  }
}

/* ================== LOAD DATA + RENDER ================== */
$("#btnRefresh").onclick=()=> loadData();

async function loadData(){
  const btn=$("#btnRefresh"), txt=btn.textContent; btn.disabled=true; btn.textContent='Cargando…';
  try{
    const res=await apiGetInspections();
    if(!res?.ok){ toast("No se pudo cargar desde la hoja"); return; }
    all = res.items||[];
    render();
  }catch(err){
    console.error(err); toast("Error al obtener datos","err");
  }finally{
    btn.disabled=false; btn.textContent=txt;
  }
}

function normalizeCounts(r){
  const lines = (r.linesCount ?? r.danosCount ?? (Array.isArray(r.lines)? r.lines.length : 0)) || 0;
  const photos= (r.photosCount ?? r.fotosCount ?? r.photos_total ?? 0);
  return {lines,photos};
}

function render(){
  const q=($("#txtSearch").value||'').trim().toLowerCase();
  filtered = (all||[]).filter(x=> (x.container||x.naviera||x.inspector||x.vendor));
  if(status!=='all') filtered=filtered.filter(x=> (String(x.status||'').toLowerCase()===status));
  if(q) filtered=filtered.filter(it=>
    (it.container||'').toLowerCase().includes(q) ||
    (it.naviera||'').toLowerCase().includes(q) ||
    (it.inspector||'').toLowerCase().includes(q) ||
    (it.vendor||'').toLowerCase().includes(q) ||
    (it.tipo||'').toLowerCase().includes(q)
  );
  filtered.sort((a,b)=> (String(a.fecha)<String(b.fecha)?1:-1));

  const tb=$("#tbody"); tb.innerHTML='';
  const total=filtered.length; const pages=Math.max(1,Math.ceil(total/per)); if(page>pages) page=pages;
  const ini=(page-1)*per, fin=Math.min(total,ini+per);

  for(let i=ini;i<fin;i++){
    const r=filtered[i];
    const {lines,photos}=normalizeCounts(r);
    const canEdit = String(r.status).toLowerCase()==='pendiente';
    const tr=document.createElement('tr');
    tr.innerHTML = `
      <td>${r.fecha? String(r.fecha).slice(0,10) : ''}</td>
      <td><b>${r.container||''}</b></td>
      <td class="t-center">${gateChip(r.gate)}</td>
      <td>${r.naviera||''}</td>
      <td class="t-center">${r.tipo||''}</td>
      <td>${r.inspector||''}</td>
      <td>${r.vendor||''}</td>
      <td class="t-center">${lines}</td>
      <td class="t-center">${photos}</td>
      <td class="t-center">${statusBadge(r.status)}</td>
      <td class="t-center">
        ${ canEdit
            ? `<button class="btn" data-edit="${r.id}">Editar</button>`
            : `<span class="pill">—</span>` }
      </td>`;
    tb.appendChild(tr);
  }
  $("#pageInfo").textContent=`Página ${page}/${pages}`;
  $("#countInfo").textContent=`Showing ${Math.min(fin-ini,per)} of ${total}`;

  // bind editores
  document.querySelectorAll('[data-edit]').forEach(b=>{
    b.onclick=()=>{ const id=b.getAttribute('data-edit'); location.href='inspect.html?id='+encodeURIComponent(id); };
  });

  refreshQueueBadge();
}

/* ================== PAGINACIÓN / SEARCH / PER PAGE ================== */
$("#perPage").onchange=()=>{ per=Number($("#perPage").value||20); localStorage.setItem('home_per',String(per)); page=1; render(); }
$("#prev").onclick=()=>{ if(page>1){ page--; render(); } }
$("#next").onclick=()=>{ const pages=Math.max(1,Math.ceil(filtered.length/per)); if(page<pages){ page++; render(); } }
let sT; $("#txtSearch").addEventListener('input',()=>{ clearTimeout(sT); sT=setTimeout(()=>{ page=1; render(); },200); });

/* ================== COLA LOCAL — BADGE (IndexedDB) ================== */
const DB='reefer_inspections_db', VER=1, STORE='queue';
function idbOpen(){
  return new Promise((res,rej)=>{
    const r=indexedDB.open(DB,VER);
    r.onupgradeneeded=()=>{ const db=r.result; if(!db.objectStoreNames.contains(STORE)){ db.createObjectStore(STORE,{keyPath:'id'});} };
    r.onsuccess=()=>res(r.result);
    r.onerror=()=>rej(r.error);
  });
}
async function queueCount(){
  const db=await idbOpen(); const tx=db.transaction(STORE,'readonly'); const store=tx.objectStore(STORE); const req=store.getAllKeys();
  return new Promise((res)=>{ req.onsuccess=()=>{ db.close(); res(req.result.length||0); }; });
}
async function refreshQueueBadge(){
  const n = await queueCount();
  const el=$("#queueCount"); if(el) el.textContent=String(n);
  const badge=$("#queueBadge");
  if(badge){
    badge.classList.toggle('warn', n>0);
    badge.title = n>0 ? `Tienes ${n} ítem(s) pendiente(s) por enviar` : 'Sin pendientes';
  }
}

/* ================== MODAL COLA — ABRIR/CERRAR ================== */
const modal=$("#modalQueue");
$("#queueBadge").onclick=async()=>{ await populateQueueTable(); modal.style.display='flex'; };
$("#btnCloseModal").onclick=()=>{ modal.style.display='none'; };
modal.addEventListener('click',e=>{ if(e.target===modal) modal.style.display='none'; });

/* ================== MODAL COLA — RENDER ================== */
const tblBody = document.querySelector("#tblQueue tbody");
const chkAll = $("#chkAll");
chkAll.onchange=()=>{ tblBody.querySelectorAll('input[type="checkbox"][data-id]').forEach(x=>x.checked=chkAll.checked); };

function sumPhotos(item){
  try{
    const ph=item.photos||[];
    return ph.reduce((a,row)=> a + (Array.isArray(row)? row.length : 0), 0);
  }catch{ return 0; }
}

async function queueAll(){
  const db=await idbOpen(); const tx=db.transaction(STORE,'readonly'); const store=tx.objectStore(STORE); const req=store.getAll();
  return new Promise((res)=>{ req.onsuccess=()=>{ db.close(); res(req.result||[]); }; });
}

async function populateQueueTable(){
  const items = await queueAll();
  tblBody.innerHTML='';
  for(const it of items){
    const q=it.questionnaire||{};
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td><input type="checkbox" data-id="${it.id}"></td>
      <td><b>${q.container||'-'}</b></td>
      <td>${q.fecha||'-'}</td>
      <td>${(it.lines||[]).length}</td>
      <td>${sumPhotos(it)}</td>
      <td><span class="badge b-pend">${it.status||'pendiente'}</span></td>
    `;
    tblBody.appendChild(tr);
  }
  chkAll.checked=false;
}

/* ================== INIT ================== */
(function init(){
  showLastSent();
  refreshQueueBadge();
  loadData();
})();
</script>
<script>
/* =============== ENVÍO DESDE LA COLA (SELECCIONADOS) =============== */
const btnSendSel=$("#btnSendSel");
const btnDeleteSel=$("#btnDeleteSel");

/* utilidades básicas */
async function queueGet(id){
  const db=await idbOpen(); const tx=db.transaction(STORE,'readonly');
  const req=tx.objectStore(STORE).get(id);
  return new Promise(res=>{ req.onsuccess=()=>{ db.close(); res(req.result); }; });
}
async function queueDelete(id){
  const db=await idbOpen(); const tx=db.transaction(STORE,'readwrite');
  tx.objectStore(STORE).delete(id);
  return new Promise(res=>{ tx.oncomplete=()=>{ db.close(); res(); }; });
}
function blobToBase64(blob){
  return new Promise((res,rej)=>{
    const fr=new FileReader();
    fr.onload=()=>{ const s=String(fr.result); res(s.substring(s.indexOf(',')+1)); };
    fr.onerror=rej; fr.readAsDataURL(blob);
  });
}

/* construir y enviar un item completo */
async function sendOneItem(it){
  const linesPayload=[], photosPayload=[];
  for(let i=0;i<(it.lines||[]).length;i++){
    const L=it.lines[i];
    linesPayload.push({
      line:L.n||L.num||i+1,
      code:L.code||L.marker||'',
      desc:L.desc||L.dano||'',
      qty:L.qty||1,
      hh:L.hh||0
    });
    const files=((it.photos||[])[i]||[]);
    for(const pf of files){
      const b64=await blobToBase64(pf.blob||pf.file);
      photosPayload.push({ name:pf.name||('foto_'+Date.now()), mimeType:pf.type||'image/jpeg', dataBase64:b64, line:(L.n||i+1) });
    }
  }

  const q=it.questionnaire||{};
  const payload={
    meta:{ naviera:q.naviera, fecha:(q.fecha||new Date().toISOString().slice(0,10)), unidad:q.container },
    form:{
      container:q.container, gate:q.gate, tipo:q.tipo, naviera:q.naviera,
      inspector:it.tecnico||q.inspector, vendor:it.vendor||q.vendor
    },
    lines:linesPayload, photos:photosPayload
  };

  const res=await fetch(GAS_URL,{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify(payload)
  });
  const j=await res.json();
  if(!res.ok||!j?.ok) throw new Error(j?.error||('HTTP '+res.status));
  return j;
}

/* helpers comunes */
async function withBusyButtons(fn){
  btnSendSel.disabled=true; btnDeleteSel.disabled=true;
  try{ await fn(); }finally{ btnSendSel.disabled=false; btnDeleteSel.disabled=false; }
}

/* ===== Enviar seleccionados ===== */
btnSendSel.onclick=()=>withBusyButtons(async()=>{
  const ids=[...tblBody.querySelectorAll('input[type="checkbox"][data-id]:checked')].map(x=>x.dataset.id);
  if(ids.length===0){ toast('Selecciona al menos 1 ítem'); return; }

  let ok=0, fail=0;
  for(const id of ids){
    try{
      const it=await queueGet(id);
      if(!it){ fail++; continue; }
      const rowChk = tblBody.querySelector(`input[data-id="${id}"]`);
      if(rowChk){ rowChk.closest('tr').querySelector('td:last-child').innerHTML='<span class="badge b-prog">enviando…</span>'; }

      await sendOneItem(it);
      await queueDelete(id);
      ok++;
      if(rowChk){ rowChk.closest('tr').querySelector('td:last-child').innerHTML='<span class="badge b-send">enviado</span>'; }
      await new Promise(r=>setTimeout(r,150));
    }catch(err){
      console.error(err); fail++;
      const rowChk = tblBody.querySelector(`input[data-id="${id}"]`);
      if(rowChk){ rowChk.closest('tr').querySelector('td:last-child').innerHTML='<span class="badge b-fail">fallido</span>'; }
    }
  }
  await refreshQueueBadge();
  await populateQueueTable();
  toast(`Envío terminado: ${ok} ok, ${fail} error(es).`);
  loadData();
});

/* ===== Eliminar seleccionados ===== */
btnDeleteSel.onclick=()=>withBusyButtons(async()=>{
  const ids=[...tblBody.querySelectorAll('input[type="checkbox"][data-id]:checked')].map(x=>x.dataset.id);
  if(ids.length===0){ toast('Selecciona al menos 1 ítem'); return; }
  for(const id of ids){ await queueDelete(id); }
  await refreshQueueBadge();
  await populateQueueTable();
  toast(`Se eliminaron ${ids.length} ítem(s) de la cola local.`);
});

/* ===== Accesibilidad / extras ===== */
window.addEventListener('keydown',e=>{
  if(e.key==='Escape' && $("#modalQueue").style.display==='flex'){
    $("#modalQueue").style.display='none';
  }
});
$("#toast").addEventListener('click',()=>$("#toast").style.display='none');
document.addEventListener('visibilitychange',()=>{
  if(!document.hidden) showLastSent();
});
window.addEventListener('error',e=>{
  if(String(e.message).includes('IndexedDB')){
    toast('⚠️ Error en almacenamiento local (IndexedDB)');
  }
});
</script>
</body>
</html>
