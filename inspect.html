<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>MAERSK ‚Äî Inspecci√≥n de Unidad</title>
<style>
:root{
  --brand:#0b74c7;--bg:#0b1120;--card:#111827;--ink:#f9fafb;
  --muted:#9ca3af;--line:#1f2937;--radius:12px;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.5 'Segoe UI',sans-serif}
.wrap{max-width:1200px;margin:0 auto;padding:20px}
.card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);padding:16px;margin-bottom:16px;box-shadow:0 1px 3px rgba(0,0,0,0.2)}
h1,h2{margin-top:0;font-weight:600}
h1{font-size:1.4rem;margin-bottom:12px;display:flex;align-items:center;gap:8px}
input,select,textarea{width:100%;padding:6px 8px;background:#1e293b;border:1px solid var(--line);border-radius:6px;color:var(--ink)}
input:focus,select:focus{outline:1px solid var(--brand)}
label{display:block;font-size:13px;margin-bottom:4px;color:var(--muted)}
.flex{display:flex;gap:12px}
.flex>div{flex:1}
button{background:var(--brand);border:none;color:#fff;padding:8px 14px;border-radius:8px;cursor:pointer;font-weight:600}
button:hover{opacity:.9}
.btn-muted{background:#374151}
.btn-warn{background:#f59e0b;color:#111}
.btn-sm{padding:4px 10px;font-size:13px}
table{width:100%;border-collapse:collapse;margin-top:8px}
th,td{padding:6px 8px;text-align:left}
th{background:#1e293b}
tr:nth-child(even){background:#0f172a}
hr{border:none;border-top:1px solid var(--line);margin:16px 0}
.iconR{width:24px;height:24px;border-radius:50%;border:2px solid var(--brand);display:flex;align-items:center;justify-content:center;cursor:pointer;font-weight:bold;color:var(--brand);transition:all .2s}
.iconR.active{background:var(--brand);color:#fff}
.previewFoto img{width:50px;height:50px;object-fit:cover;border-radius:6px;border:1px solid var(--line)}
.tag{background:#1e293b;padding:4px 10px;border-radius:20px;font-size:12px;margin-right:4px}
</style>
</head>
<body>
<div class="wrap">

<!-- Encabezado -->
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
  <h1>üîé Inspecci√≥n de Unidad</h1>
  <div>
    <button class="btn-muted" onclick="goBack()">‚Üê Volver</button>
    <button class="btn-warn" onclick="savePending()">Guardar pendiente</button>
    <button onclick="submitNow()">Enviar</button>
  </div>
</div>

<!-- Info superior -->
<div class="card" id="infoBox">
  <div class="flex">
    <div><span class="tag">ID: <b id="idLabel">nuevo</b></span></div>
    <div><span class="tag">Fecha: <b id="fechaLabel"></b></span></div>
    <div><span class="tag">Naviera: <b id="navieraLabel"></b></span></div>
    <div><span class="tag">Unidad: <b id="unidadLabel"></b></span></div>
  </div>
</div>

<!-- Bloque: Inspecci√≥n Box -->
<div class="card">
  <h2>üßæ Inspecci√≥n Box</h2>
  <div class="flex">
    <div><label>Lugar</label><input id="lugar"></div>
    <div><label>Pto. Embarque</label><input id="ptoEmbarque"></div>
    <div><label>Pto. Descarga</label><input id="ptoDescarga"></div>
  </div>
  <div class="flex">
    <div><label>Transportista</label><input id="transportista"></div>
    <div><label>Patente Cami√≥n</label><input id="patenteCamion"></div>
    <div><label>Cliente</label><input id="cliente"></div>
  </div>
  <div class="flex">
    <div><label>Estado Unidad</label><input id="estadoUnidad"></div>
    <div><label>Fecha Fab.</label><input id="fechaFab" placeholder="MM/AAAA"></div>
    <div><label>Class / Grado</label><input id="classGrado"></div>
  </div>
  <div class="flex">
    <div><label>MGW</label><input id="mgw"></div>
    <div><label>TARA</label><input id="tara"></div>
    <div><label>PAYLOAD</label><input id="payload"></div>
  </div>
  <div class="flex">
    <div><label>EIR</label><input id="eir"></div>
    <div><label>Nave</label><input id="nave"></div>
    <div><label>Viaje</label><input id="viaje"></div>
  </div>
</div>

<!-- Datos generales -->
<div class="card">
  <h2>‚öôÔ∏è Datos generales</h2>
  <div class="flex">
    <div><label>Container</label><input id="container" placeholder="Ej: MNBU1234567"></div>
    <div>
      <label>Gate</label>
      <select id="gate"><option value="-">-</option><option>Gate In</option><option>Gate Out</option></select>
    </div>
    <div>
      <label>Naviera</label>
      <select id="naviera">
        <option>Maersk</option><option>Hapag</option><option>OOCL</option><option>COSCO</option><option>Transmares</option>
      </select>
    </div>
  </div>
  <div class="flex">
    <div>
      <label>Tipo</label>
      <select id="tipo"><option>-</option><option>Inspecci√≥n</option><option>Reparaci√≥n</option></select>
    </div>
    <div><label>Inspector</label><input id="inspector"></div>
    <div><label>Vendor</label><input id="vendor"></div>
  </div>
</div>

<!-- Da√±os / L√≠neas -->
<div class="card">
  <h2>üß© Detalle de Da√±os</h2>
  <table id="tblLines">
    <thead>
      <tr>
        <th>#</th>
        <th>Ubicaci√≥n</th>
        <th>Componente</th>
        <th>Da√±o</th>
        <th>Resp.</th>
        <th>Reparado</th>
        <th>Foto</th>
        <th></th>
      </tr>
    </thead>
    <tbody id="linesBody"></tbody>
  </table>
  <div style="margin-top:10px">
    <button class="btn-sm" onclick="addLine()">+ Agregar l√≠nea</button>
  </div>
</div>

<!-- Resumen -->
<div class="card">
  <h2>üìä Resumen</h2>
  <div class="flex">
    <div><label>Estado</label><input id="status" value="pendiente" readonly></div>
    <div><label>L√≠neas</label><input id="resLineas" value="0" readonly></div>
  </div>
</div>

</div><!-- wrap -->

<script>
const GAS_URL = "https://script.google.com/macros/s/AKfycbyVP_CRMF5ojF3-1fVv76vf0zwnojF_fy_JhHIh-Ktz9g5PUeSkq7eB9nKTDMCXrVslmg/exec";

const state={id:null,fechaISO:null,lines:[]};
const byId=id=>document.getElementById(id);
const qs=s=>document.querySelector(s);

function goBack(){if(history.length>1)history.back();else location.href='home.html';}
function setTagValues(){
  const today=new Date();
  state.fechaISO=today.toISOString();
  byId('fechaLabel').textContent=today.toLocaleDateString();
}
function updateCounts(){byId('resLineas').value=state.lines.length;}

// Renderizar tabla
function renderLines(){
  const body=byId('linesBody');
  body.innerHTML='';
  state.lines.forEach((ln,idx)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${idx+1}</td>
      <td><input value="${ln.ubi||''}" oninput="setLine(${idx},'ubi',this.value)"></td>
      <td><input value="${ln.comp||''}" oninput="setLine(${idx},'comp',this.value)"></td>
      <td><input value="${ln.dano||''}" oninput="setLine(${idx},'dano',this.value)"></td>
      <td><input value="${ln.resp||''}" oninput="setLine(${idx},'resp',this.value)"></td>
      <td style="text-align:center">
        <div class="iconR ${ln.reparado?'active':''}" onclick="toggleReparado(${idx},this)">R</div>
      </td>
      <td style="text-align:center">
        <input type="file" accept="image/*" capture="environment" style="display:none" id="file_${idx}" onchange="handlePhoto(event,${idx})">
        <button class="btn-sm" onclick="byId('file_${idx}').click()">üì∏ Foto</button>
        <div class="previewFoto">${ln.foto?`<img src="${ln.foto}">`:''}</div>
      </td>
      <td><button class="btn-sm btn-muted" onclick="removeLine(${idx})">‚úï</button></td>
    `;
    body.appendChild(tr);
  });
  updateCounts();
}

function addLine(){state.lines.push({ubi:'',comp:'',dano:'',resp:'',reparado:false,foto:null});renderLines();}
function removeLine(i){state.lines.splice(i,1);renderLines();}
function setLine(i,k,v){state.lines[i][k]=v;}
function toggleReparado(i,el){state.lines[i].reparado=!state.lines[i].reparado;el.classList.toggle('active');}

async function handlePhoto(ev,idx){
  const file=ev.target.files[0]; if(!file)return;
  const reader=new FileReader();
  reader.onload=e=>{
    state.lines[idx].foto=e.target.result;
    renderLines();
  };
  reader.readAsDataURL(file);
}

// Guardar pendiente
async function savePending(){
  const payload=buildPayload('pendiente');
  const res=await fetch(GAS_URL+"?fn=saveinspection",{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
  const json=await res.json();
  if(json.ok){byId('idLabel').textContent=json.id;byId('status').value='pendiente';alert('Guardado pendiente');}
  else alert('Error: '+json.error);
}

// Enviar
async function submitNow(){
  const payload=buildPayload('enviado');
  const res=await fetch(GAS_URL+"?fn=saveinspection",{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
  const json=await res.json();
  if(json.ok){byId('idLabel').textContent=json.id;byId('status').value='enviado';alert('Enviado con √©xito');}
  else alert('Error: '+json.error);
}

function buildPayload(status){
  return {
    id:state.id||crypto.randomUUID(),
    timestamp:state.fechaISO,
    status,
    container:byId('container').value.trim(),
    gate:byId('gate').value,
    naviera:byId('naviera').value,
    tipo:byId('tipo').value,
    inspector:byId('inspector').value.trim(),
    vendor:byId('vendor').value.trim(),
    lugar:byId('lugar').value,
    ptoEmbarque:byId('ptoEmbarque').value,
    ptoDescarga:byId('ptoDescarga').value,
    transportista:byId('transportista').value,
    patenteCamion:byId('patenteCamion').value,
    cliente:byId('cliente').value,
    estadoUnidad:byId('estadoUnidad').value,
    fechaFab:byId('fechaFab').value,
    classGrado:byId('classGrado').value,
    mgw:byId('mgw').value,
    tara:byId('tara').value,
    payload:byId('payload').value,
    eir:byId('eir').value,
    nave:byId('nave').value,
    viaje:byId('viaje').value,
    daniosJSON:JSON.stringify(state.lines)
  };
}

// Inicializar
window.addEventListener('DOMContentLoaded',()=>{
  setTagValues();
  addLine();
});
</script>
</body>
</html>
