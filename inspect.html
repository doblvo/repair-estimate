<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>MAERSK — Inspección</title>
<style>
:root{
  --brand:#0b74c7; --bg:#0b1220; --panel:#0f172a; --ink:#e5e7eb; --muted:#94a3b8;
  --ok:#10b981; --warn:#f59e0b; --err:#ef4444; --line:#1f2937; --radius:14px;
}
*{box-sizing:border-box} html,body{height:100%}
body{
  margin:0; background:linear-gradient(180deg,#0b1220,#0a1327 40%,#0b152f);
  color:var(--ink); font:14px/1.4 system-ui,Segoe UI,Roboto,Inter,Arial,sans-serif;
}
.app{max-width:1000px;margin:0 auto;padding:16px}
.header{
  display:flex;align-items:center;gap:12px;justify-content:space-between;margin:8px 0 16px
}
.brand{display:flex;align-items:center;gap:12px}
.logo{width:36px;height:36px;border-radius:10px;background:#0b74c7;
  box-shadow:0 0 0 2px #0b74c7 inset,0 10px 30px rgba(11,116,199,.25)}
h1{font-size:18px;margin:0}
.badge{padding:2px 8px;border:1px solid #1f2a44;border-radius:999px;color:#9fb6d9;
  background:#0d1731}
.actions{display:flex;gap:8px;flex-wrap:wrap}
.btn{
  appearance:none;border:1px solid #2a3a5e;background:#0e1a35;color:#dbe7ff;
  border-radius:12px;padding:10px 14px;cursor:pointer;transition:.15s;font-weight:600
}
.btn:hover{transform:translateY(-1px);filter:brightness(1.05)}
.btn:disabled{opacity:.6;cursor:not-allowed}
.btn.primary{background:linear-gradient(180deg,#1480da,#0b74c7);border-color:#0b74c7;color:#fff}
.btn.ghost{background:transparent}
.btn.ok{background:#0e2b22;border-color:#155e52;color:#acf2d8}
.btn.warn{background:#2c220e;border-color:#8b5a17;color:#ffd89a}
.btn.err{background:#2c1111;border-color:#7a1a1a;color:#ffb3b3}

.card{
  background:linear-gradient(180deg,#0e1628,#0b1325);
  border:1px solid #15223d;border-radius:var(--radius);padding:16px;margin:12px 0;
  box-shadow:0 10px 30px rgba(4,10,24,.25), inset 0 1px 0 rgba(255,255,255,.03)
}
.card h2{font-size:16px;margin:0 0 12px;color:#d7e3ff}
.row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
@media (max-width:820px){.row,.row3{grid-template-columns:1fr}}
.field{display:flex;flex-direction:column;gap:6px}
label{color:#9fb6d9;font-weight:600}
input,select,textarea{
  background:#0b1220;border:1px solid #1e2b49;border-radius:12px;
  padding:10px 12px;color:#dbe7ff;outline:none
}
input:focus,select:focus,textarea:focus{border-color:#2b66ff;box-shadow:0 0 0 3px rgba(43,102,255,.15)}
.small{font-size:12px;color:#89a2c9}

.table{width:100%;border-collapse:separate;border-spacing:0 8px}
.table th,.table td{padding:8px 10px;text-align:left}
.table th{color:#9fb6d9;font-weight:600}
.rowline{background:#0b1220;border:1px solid #1b2746}
.rowline td{border-top:1px solid #1b2746;border-bottom:1px solid #1b2746}
.kbd{font-family:ui-monospace,Consolas,monospace;background:#0b1220;border:1px solid #223055;
  padding:2px 6px;border-radius:6px;color:#cfe2ff}

.previewGrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:8px}
.thumb{position:relative;border:1px solid #1e2b49;border-radius:12px;overflow:hidden;background:#0b1220}
.thumb img{display:block;width:100%;height:90px;object-fit:cover}
.thumb .cap{padding:6px 8px;color:#9fb6d9;font-size:12px;border-top:1px solid #1e2b49}
.thumb .x{position:absolute;top:6px;right:6px;background:#2c1111;border:1px solid #7a1a1a;
  color:#ffb3b3;border-radius:8px;padding:2px 6px;cursor:pointer}

.toast{
  position:fixed;left:50%;bottom:20px;transform:translateX(-50%);
  background:#0e1a35;border:1px solid #2a3a5e;color:#dbe7ff;border-radius:12px;
  padding:10px 14px;box-shadow:0 10px 30px rgba(0,0,0,.4);z-index:999;display:none
}
.meta{display:flex;gap:8px;flex-wrap:wrap}
.meta .chip{border:1px dashed #2a3a5e;border-radius:999px;padding:4px 8px;color:#9fb6d9}
</style>
</head>
<body>
<div class="app">
  <div class="header">
    <div class="brand">
      <div class="logo"></div>
      <div>
        <h1>Inspección de Unidad</h1>
        <div id="metaChips" class="meta"></div>
      </div>
    </div>
    <div class="actions">
      <button id="btnBack" class="btn ghost">← Volver</button>
      <button id="btnSave" class="btn warn">Guardar pendiente</button>
      <button id="btnSend" class="btn primary">Enviar</button>
    </div>
  </div>

  <!-- Datos principales -->
  <div class="card">
    <h2>Datos generales</h2>
    <div class="row3">
      <div class="field"><label>Container</label><input id="inContainer" placeholder="Ej: MNBU1234567"/></div>
      <div class="field"><label>Gate</label><select id="inGate"><option value="">-</option><option>Gate IN</option><option>Gate OUT</option></select></div>
      <div class="field"><label>Naviera</label><input id="inNaviera" placeholder="Maersk / Hapag / OOCL / COSCO / ..."/></div>
    </div>
    <div class="row3" style="margin-top:10px">
      <div class="field"><label>Tipo</label><select id="inTipo"><option value="">-</option><option>Pre-Trip</option><option>Repair</option><option>Estimate</option></select></div>
      <div class="field"><label>Inspector</label><input id="inInspector" placeholder="Nombre técnico"/></div>
      <div class="field"><label>Vendor</label><input id="inVendor" placeholder="Proveedor / Taller"/></div>
    </div>
    <div class="small" style="margin-top:8px">
      <span class="kbd">Nota:</span> Si reabres un “pendiente”, este formulario carga los valores guardados y permite agregar/eliminar líneas y fotos sin duplicar el registro.
    </div>
  </div>

  <!-- Líneas -->
  <div class="card">
    <h2>Daños / Líneas</h2>
    <table class="table" id="linesTable">
      <thead>
        <tr>
          <th style="width:64px">#</th>
          <th>Código / Descripción</th>
          <th style="width:100px">Cant.</th>
          <th style="width:100px">HH</th>
          <th style="width:64px"></th>
        </tr>
      </thead>
      <tbody id="linesBody"></tbody>
    </table>
    <div class="actions">
      <button id="btnAddLine" class="btn">+ Agregar línea</button>
      <span class="small">Puedes vincular fotos a una línea (se muestra en el pie de cada miniatura).</span>
    </div>
  </div>

  <!-- Fotos -->
  <div class="card">
    <h2>Fotos</h2>
    <div class="row">
      <div class="field">
        <label>Agregar fotos</label>
        <input id="inPhotos" type="file" accept="image/*" multiple/>
        <span class="small">Se conservan las fotos anteriores; puedes eliminar manualmente las que no correspondan.</span>
      </div>
      <div class="field">
        <label>Asociar fotos a línea (opcional)</label>
        <input id="inLineTag" type="number" min="1" placeholder="N° de línea para las nuevas fotos"/>
        <span class="small">Si indicas un número, las fotos que agregues quedarán marcadas con esa línea.</span>
      </div>
    </div>
    <div id="photosGrid" class="previewGrid" style="margin-top:10px"></div>
  </div>

  <div class="card">
    <h2>Resumen</h2>
    <div class="row3">
      <div class="field"><label>Estado</label><input id="outStatus" disabled value="pendiente"/></div>
      <div class="field"><label>Líneas</label><input id="outLines" disabled/></div>
      <div class="field"><label>Fotos</label><input id="outPhotos" disabled/></div>
    </div>
  </div>
</div>

<div id="toast" class="toast"></div>

<script>
/* =================== CONFIG =================== */
const API_BASE = "https://script.google.com/macros/s/AKfycbyVP_CRMF5ojF3-1fVv76vf0zwnojF_fy_JhHIh-Ktz9g5PUeSkq7eB9nKTDMCXrVslmg/exec";
const STORAGE_KEY = "inspect_drafts_v2"; // cola local (pendientes)
/* ============================================== */

const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));

const state = {
  id: null,
  meta: { fecha: new Date().toISOString().slice(0,10), naviera:"", unidad:"" },
  form: { container:"", gate:"", naviera:"", tipo:"", inspector:"", vendor:"" },
  lines: [],
  photos: [], // {name,dataBase64,mimeType,line?, id?}
  isSaving: false
};

function toast(msg, kind="info", ms=2400){
  const el = $("#toast");
  el.textContent = msg;
  el.style.display = "block";
  el.style.borderColor = (kind==="ok")?"#155e52":(kind==="err")?"#7a1a1a":"#2a3a5e";
  el.style.background = (kind==="ok")?"#0e2b22":(kind==="err")?"#2c1111":"#0e1a35";
  clearTimeout(el._t); el._t=setTimeout(()=>el.style.display="none", ms);
}

function authGuard(){
  try{
    const u = JSON.parse(localStorage.getItem("auth_user")||"null");
    if(!u){ location.replace("login.html"); return; }
  }catch{ location.replace("login.html"); }
}

/* ===== Local Storage queue helpers ===== */
function loadQueue(){
  try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)||"[]"); }
  catch(_){ return []; }
}
function saveQueue(arr){ localStorage.setItem(STORAGE_KEY, JSON.stringify(arr)); }
function getDraftById(id){ return loadQueue().find(x=>x.id===id) || null; }
function upsertDraft(d){
  const q = loadQueue();
  const i = q.findIndex(x=>x.id===d.id);
  if(i>=0) q[i]=d; else q.push(d);
  saveQueue(q);
}
function deleteDraft(id){
  const q = loadQueue().filter(x=>x.id!==id);
  saveQueue(q);
}

/* ===== Lines UI ===== */
function newLineObj(){
  return { code:"", desc:"", qty:1, hh:0, num: state.lines.length+1 };
}
function renderLines(){
  const tbody = $("#linesBody");
  tbody.innerHTML = "";
  state.lines.forEach((ln, idx)=>{
    const tr = document.createElement("tr");
    tr.className="rowline";
    tr.innerHTML = `
      <td><span class="kbd">${ln.num}</span></td>
      <td>
        <div class="row">
          <input class="inCode" placeholder="Código" value="${ln.code||""}"/>
          <input class="inDesc" placeholder="Descripción" value="${ln.desc||""}"/>
        </div>
      </td>
      <td><input class="inQty" type="number" min="0" value="${ln.qty||0}"/></td>
      <td><input class="inHH" type="number" step="0.01" min="0" value="${ln.hh||0}"/></td>
      <td><button class="btn err btnDel">×</button></td>
    `;
    tr.querySelector(".inCode").addEventListener("input", e=>{ ln.code=e.target.value; });
    tr.querySelector(".inDesc").addEventListener("input", e=>{ ln.desc=e.target.value; });
    tr.querySelector(".inQty").addEventListener("input", e=>{ ln.qty=Number(e.target.value||0); });
    tr.querySelector(".inHH").addEventListener("input", e=>{ ln.hh=Number(e.target.value||0); });
    tr.querySelector(".btnDel").addEventListener("click", ()=>{
      state.lines.splice(idx,1);
      state.lines.forEach((x,i)=>x.num=i+1);
      renderLines(); renderCounters(); renderPhotos();
    });
    tbody.appendChild(tr);
  });
}
$("#btnAddLine").addEventListener("click", ()=>{
  state.lines.push(newLineObj()); renderLines(); renderCounters();
});

/* ===== Photos UI ===== */
function renderPhotos(){
  const grid = $("#photosGrid");
  grid.innerHTML="";
  state.photos.forEach((p, i)=>{
    const div = document.createElement("div");
    div.className="thumb";
    const tag = p.line ? `Línea ${p.line}` : "Sin línea";
    div.innerHTML = `
      <img src="${p.dataBase64}" alt="${p.name||"foto"}"/>
      <div class="cap">${p.name||"foto"}</div>
      <div class="cap" style="border-top:none;color:#7fb7ff">${tag}</div>
      <button class="x">Eliminar</button>
    `;
    div.querySelector(".x").addEventListener("click", ()=>{
      state.photos.splice(i,1); renderPhotos(); renderCounters();
    });
    grid.appendChild(div);
  });
}
async function filesToBase64(file){
  return new Promise((res,rej)=>{
    const r = new FileReader();
    r.onload = ()=> res(r.result);
    r.onerror = rej;
    r.readAsDataURL(file);
  });
}
$("#inPhotos").addEventListener("change", async (e)=>{
  const files = Array.from(e.target.files||[]);
  if(!files.length) return;
  const lineTag = Number($("#inLineTag").value||0) || null;
  for(const f of files){
    const b64 = await filesToBase64(f);
    state.photos.push({ name:f.name, dataBase64:b64, mimeType:f.type||"image/jpeg", line: lineTag });
  }
  e.target.value = "";
  renderPhotos(); renderCounters();
});

/* ===== Counters / Meta ===== */
function renderCounters(){
  $("#outLines").value = String(state.lines.length);
  $("#outPhotos").value = String(state.photos.length);
  const chips = $("#metaChips");
  chips.innerHTML="";
  const mk = (t)=>{ const s=document.createElement("span"); s.className="chip"; s.textContent=t; return s; }
  chips.append(
    mk(`ID: ${state.id||"nuevo"}`),
    mk(`Fecha: ${state.meta.fecha}`),
    mk(`Naviera: ${state.form.naviera||"-"}`),
    mk(`Unidad: ${state.form.container||"-"}`)
  );
}

/* ===== Bind form ===== */
function pullForm(){
  state.form.container = $("#inContainer").value.trim().toUpperCase();
  state.form.gate      = $("#inGate").value.trim();
  state.form.naviera   = $("#inNaviera").value.trim();
  state.form.tipo      = $("#inTipo").value.trim();
  state.form.inspector = $("#inInspector").value.trim();
  state.form.vendor    = $("#inVendor").value.trim();
  state.meta.naviera = state.form.naviera;
  state.meta.unidad  = state.form.container;
}
function pushForm(){
  $("#inContainer").value = state.form.container||"";
  $("#inGate").value = state.form.gate||"";
  $("#inNaviera").value = state.form.naviera||"";
  $("#inTipo").value = state.form.tipo||"";
  $("#inInspector").value = state.form.inspector||"";
  $("#inVendor").value = state.form.vendor||"";
}

/* ===== Helpers ===== */
function uuid(){
  // Suficiente para id local (será reemplazado si backend retorna otro)
  return "xxxxxx-4xxx-yxxx-xxxxxx".replace(/[xy]/g, c=>{
    const r = Math.random()*16|0, v = c==='x'?r:(r&0x3|0x8); return v.toString(16);
  });
}
function qs(name){
  const m = new URLSearchParams(location.search).get(name); return m?decodeURIComponent(m):"";
}

/* ===== Save Pending (registerPending) ===== */
async function savePending(){
  pullForm();
  if(!state.form.container){ toast("Falta Container", "err"); return; }

  // asegurar ID y merge con cola local
  if(!state.id) state.id = uuid();

  const draft = {
    id: state.id,
    meta: state.meta,
    form: state.form,
    lines: state.lines,
    photos: state.photos
  };
  upsertDraft(draft);

  const payload = {
    fn:"registerPending",
    pending:{
      id: state.id,
      container: state.form.container,
      gate: state.form.gate,
      naviera: state.form.naviera,
      tipo: state.form.tipo,
      tecnico: state.form.inspector,
      vendor: state.form.vendor,
      fecha: state.meta.fecha,
      linesCount: state.lines.length,
      photosCount: state.photos.length
    }
  };

  try{
    if(state.isSaving) return;
    state.isSaving = true; $("#btnSave").disabled=true;

    const r = await fetch(API_BASE, {
      method:"POST",
      headers:{ "Content-Type":"text/plain;charset=utf-8" },
      body: JSON.stringify(payload)
    });
    const j = await r.json();
    if(!j.ok) throw new Error(j.error||"Error en registerPending");
    // el backend podría devolver otro ID; mantenemos coherencia por si acaso
    state.id = j.id || state.id;
    upsertDraft({ ...draft, id: state.id }); // actualizar id si cambió

    $("#outStatus").value = "pendiente";
    renderCounters();
    toast("Pendiente guardado ✍️", "ok");
  }catch(err){
    console.error(err); toast("No se pudo guardar el pendiente", "err");
  }finally{
    state.isSaving=false; $("#btnSave").disabled=false;
  }
}

/* ===== Final Submit (Drive + Principal + borra de Pendientes) ===== */
async function sendFinal(){
  pullForm();
  if(!state.form.container){ toast("Falta Container", "err"); return; }
  if(!state.lines.length){ toast("Agrega al menos 1 línea", "err"); return; }

  // Normalizar fotos a {dataBase64,mimeType,name,line}
  const photos = state.photos.map(p=>({
    name: p.name || ("foto_"+Date.now()+".jpg"),
    dataBase64: (p.dataBase64||"").split(",").pop(), // solo payload base64
    mimeType: p.mimeType || "image/jpeg",
    line: p.line||null
  }));

  const body = {
    // NOTA: doPost del backend toma cualquier POST que no sea fn=registerPending como envío final.
    id: state.id || uuid(),
    meta: { fecha: state.meta.fecha, naviera: state.form.naviera, unidad: state.form.container },
    form: { ...state.form },
    lines: state.lines.map(x=>({code:x.code, desc:x.desc, qty:x.qty, hh:x.hh, line:x.num})),
    photos
  };

  try{
    if(state.isSaving) return;
    state.isSaving = true; $("#btnSend").disabled=true;

    const r = await fetch(API_BASE, {
      method:"POST",
      headers:{ "Content-Type":"text/plain;charset=utf-8" },
      body: JSON.stringify(body)
    });
    const j = await r.json();
    if(!j.ok) throw new Error(j.error||"Error en envío final");

    $("#outStatus").value = "enviado";
    renderCounters();
    // borrar de la cola local si existía
    if(state.id) deleteDraft(state.id);
    toast("Enviado ✅ — Respaldos creados en Drive", "ok", 3200);

    // opcional: volver a home
    setTimeout(()=>{ location.replace("home.html"); }, 800);
  }catch(err){
    console.error(err); toast("No se pudo enviar", "err");
  }finally{
    state.isSaving=false; $("#btnSend").disabled=false;
  }
}

/* ===== Back button ===== */
$("#btnBack").addEventListener("click", ()=>{
  history.length>1 ? history.back() : location.replace("home.html");
});

/* ===== Bind actions ===== */
$("#btnSave").addEventListener("click", savePending);
$("#btnSend").addEventListener("click", sendFinal);

/* ===== Init ===== */
function initFromDraft(d){
  if(!d) return;
  state.id    = d.id || state.id;
  state.meta  = d.meta || state.meta;
  state.form  = d.form || state.form;
  state.lines = Array.isArray(d.lines) ? d.lines.map((x,i)=>({ ...x, num:(x.num||i+1) })) : [];
  state.photos= Array.isArray(d.photos)? d.photos.slice() : [];
}
function init(){
  authGuard();

  // Reabrir por ?id=...
  const qid = qs("id");
  if(qid){
    const d = getDraftById(qid);
    if(d) initFromDraft(d);
    else state.id = qid; // si no está en local, igual respetar id (podría venir de otra vista)
  }else{
    // Nuevo => prepara 1 línea por defecto
    if(state.lines.length===0) state.lines=[newLineObj()];
  }

  pushForm();
  renderLines();
  renderPhotos();
  renderCounters();
}
init();
</script>
</body>
</html>
