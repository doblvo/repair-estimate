<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>MAERSK ‚Äî Inspecci√≥n de Unidad</title>
<style>
:root{
  --brand:#0b74c7; --bg:#0b1120; --card:#111827; --ink:#f9fafb;
  --muted:#9ca3af; --line:#1f2937; --radius:12px;
  --danger:#ef4444; --ok:#10b981; --warn:#f59e0b;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;background:var(--bg);color:var(--ink);
  font:14px/1.5 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
}
.wrap{max-width:1200px;margin:0 auto;padding:16px}
.card{
  background:var(--card);border:1px solid var(--line);border-radius:var(--radius);
  padding:16px;margin-bottom:16px;box-shadow:0 1px 3px rgba(0,0,0,.2);
}
h1,h2{margin:0 0 12px 0;font-weight:600}
h1{font-size:1.35rem;display:flex;align-items:center;gap:8px}
label{display:block;font-size:12.5px;color:var(--muted);margin:0 0 6px}
input,select,textarea{
  width:100%;padding:8px 10px;border-radius:8px;color:var(--ink);
  background:#0f172a;border:1px solid var(--line);
}
input:focus,select:focus,textarea:focus{outline:1px solid var(--brand);border-color:var(--brand)}
input.invalid, select.invalid, textarea.invalid{border-color:var(--danger) !important; outline:1px solid var(--danger) !important}
.field-hint{font-size:12px;color:#fca5a5;display:none;margin-top:4px}
.field-hint.show{display:block}
.flex{display:flex;gap:12px}
.flex>div{flex:1}
.row{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
@media (max-width:900px){ .row{grid-template-columns:1fr 1fr} }
@media (max-width:640px){ .row{grid-template-columns:1fr} }

.btn{
  background:var(--brand);color:#fff;border:none;border-radius:10px;
  padding:10px 14px;font-weight:700;cursor:pointer
}
.btn:hover{opacity:.92}
.btn-muted{background:#374151}
.btn-warn{background:var(--warn);color:#111}
.btn-sm{padding:6px 10px;border-radius:8px;font-weight:600}
.btn-ghost{background:#0f172a;border:1px dashed var(--line);color:var(--muted)}
.actions-top, .actions-bottom{
  display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:flex-end
}

/* Info chips */
.tag{background:#0f172a;border:1px solid var(--line);padding:4px 10px;border-radius:18px;font-size:12px;display:inline-flex;gap:6px;align-items:center}

/* Tabla responsive en contenedor scrolleable */
.table-wrap{
  width:100%;overflow:auto;border:1px solid var(--line);border-radius:12px;background:#0b1222
}
table{width:100%;border-collapse:collapse;min-width:900px}
th,td{padding:8px 10px;text-align:left;vertical-align:middle}
th{background:#0f1a2a;color:#cbd5e1;position:sticky;top:0;z-index:1}
tbody tr:nth-child(even){background:#0f172a}

/* C√≠rculo ‚ÄúR‚Äù reparado */
.r-circle{
  width:28px;height:28px;border-radius:999px;border:2px solid var(--brand);
  display:inline-flex;align-items:center;justify-content:center;
  color:var(--brand);background:transparent;font-weight:800;cursor:pointer;user-select:none
}
.r-circle.active{background:var(--brand);color:#fff}

/* Mosaico de miniaturas por l√≠nea (m√∫ltiples fotos) */
.line-photos{
  display:flex;gap:6px;flex-wrap:wrap;align-items:center
}
.thumb{
  width:54px;height:54px;border-radius:8px;border:1px solid var(--line);overflow:hidden;background:#0f172a;position:relative
}
.thumb img{width:100%;height:100%;object-fit:cover;display:block}
.thumb .rm{
  position:absolute;top:2px;right:2px;background:#0009;border:none;color:#fff;
  width:18px;height:18px;border-radius:999px;font-size:12px;cursor:pointer
}

/* Bot√≥n de foto por l√≠nea */
.photo-btn{display:inline-flex;gap:6px;align-items:center}
.photo-btn input[type=file]{display:none}

/* Resumen */
.summary-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media (max-width:640px){ .summary-grid{grid-template-columns:1fr} }

/* Pie pegado en m√≥vil: acciones abajo siempre visibles */
.sticky-footer{
  position:sticky;bottom:0;z-index:20;margin-top:16px;
  background:linear-gradient(180deg, transparent, rgba(11,17,32,.85) 25%, rgba(11,17,32,.95) 100%);
  backdrop-filter: blur(4px);padding-top:8px
}

/* Overlay de carga */
.loading-overlay{
  position:fixed;inset:0;background:rgba(2,6,23,.72);
  display:none;align-items:center;justify-content:center;z-index:9999;
  backdrop-filter: blur(2px);
}
.spinner{
  width:56px;height:56px;border-radius:50%;
  border:4px solid rgba(255,255,255,.15);border-top-color:#fff;
  animation:spin 1s linear infinite
}
@keyframes spin{ to{ transform:rotate(360deg) } }

/* Toast suave */
.toast{
  position:fixed;left:50%;bottom:24px;transform:translateX(-50%);
  background:#0f172a;color:#e5e7eb;border:1px solid #1f2937;border-radius:12px;
  padding:10px 14px;box-shadow:0 10px 30px rgba(0,0,0,.35);z-index:10000;
  display:none;font-weight:600
}
.toast.ok{border-color:#14532d;background:#052e1b;color:#c8f3d6}
.toast.err{border-color:#7f1d1d;background:#2a0b0b;color:#fecaca}
</style>
</head>
<body>
<div class="wrap">

  <!-- Encabezado -->
  <div class="card" style="display:flex;justify-content:space-between;align-items:center;gap:10px">
    <h1>üîé Inspecci√≥n de Unidad</h1>
    <div class="actions-top">
      <button class="btn btn-muted" onclick="goBack()">‚Üê Volver</button>
    </div>
  </div>

  <!-- Chips de estado -->
  <div class="card" id="infoBox">
    <div class="flex" style="flex-wrap:wrap;gap:8px">
      <span class="tag">ID: <b id="idLabel">nuevo</b></span>
      <span class="tag">Fecha: <b id="fechaLabel"></b></span>
      <span class="tag">Naviera: <b id="navieraLabel"></b></span>
      <span class="tag">Unidad: <b id="unidadLabel"></b></span>
      <span class="tag">Estado: <b id="statusChip">pendiente</b></span>
    </div>
  </div>

  <!-- 1) DATOS GENERALES -->
  <div class="card">
    <h2>‚öôÔ∏è Datos generales</h2>
    <div class="row">
      <div>
        <label>Container</label>
        <input id="container" placeholder="Ej: MNBU1234567" maxlength="11">
        <div class="field-hint" id="hint_container">Debe tener 11 caracteres: 4 letras + 7 n√∫meros (ej: MNBU1234567)</div>
      </div>
      <div>
        <label>Gate</label>
        <select id="gate">
          <option value="-">-</option>
          <option>Gate In</option>
          <option>Gate Out</option>
        </select>
        <div class="field-hint" id="hint_gate">Selecciona un Gate v√°lido.</div>
      </div>
      <div>
        <label>Naviera</label>
        <select id="naviera">
          <option value="">-</option>
          <option>Maersk</option>
          <option>Hapag</option>
          <option>OOCL</option>
          <option>COSCO</option>
          <option>Transmares</option>
        </select>
        <div class="field-hint" id="hint_naviera">Selecciona una naviera.</div>
      </div>
    </div>
    <div class="row" style="margin-top:12px">
      <div>
        <label>Tipo</label>
        <select id="tipo">
          <option value="">-</option>
          <option>Inspecci√≥n</option>
          <option>Reparaci√≥n</option>
        </select>
        <div class="field-hint" id="hint_tipo">Selecciona un tipo.</div>
      </div>
      <div>
        <label>Inspector</label>
        <input id="inspector" placeholder="Nombre t√©cnico">
        <div class="field-hint" id="hint_inspector">Ingresa el nombre del inspector.</div>
      </div>
      <div>
        <label>Vendor</label>
        <input id="vendor" placeholder="Proveedor / Taller">
        <div class="field-hint" id="hint_vendor">Ingresa el vendor.</div>
      </div>
    </div>
  </div>

  <!-- 2) INSPECCI√ìN BOX -->
  <div class="card">
    <h2>üßæ Inspecci√≥n Box</h2>
    <div class="row">
      <div><label>Lugar</label><input id="lugar" placeholder="Ej: Depot San Antonio"></div>
      <div><label>Pto. Embarque</label><input id="ptoEmbarque" placeholder="Ej: Dummy"></div>
      <div><label>Pto. Descarga</label><input id="ptoDescarga" placeholder="Ej: SAN ANTONIO (CLSALT)"></div>
    </div>
    <div class="row" style="margin-top:12px">
      <div><label>Transportista</label><input id="transportista" placeholder="Ej: Sergio √ìrdenes"></div>
      <div><label>Patente Cami√≥n</label><input id="patenteCamion" placeholder="Ej: VX3824"></div>
      <div><label>Cliente</label><input id="cliente" placeholder="Ej: Importadora Yaru II Ltda."></div>
    </div>
    <div class="row" style="margin-top:12px">
      <div><label>Estado Unidad</label><input id="estadoUnidad" placeholder="Ej: OP-Operativo"></div>
      <div><label>Fecha Fabricaci√≥n</label><input id="fechaFab" placeholder="MM/AAAA"></div>
      <div><label>Class / Grado</label><input id="classGrado" placeholder="Ej: Grado K"></div>
    </div>
    <div class="row" style="margin-top:12px">
      <div><label>MGW</label><input id="mgw" placeholder="0.00 KGS"></div>
      <div><label>TARA</label><input id="tara" placeholder="3700.00 KGS"></div>
      <div><label>PAYLOAD</label><input id="payload" placeholder="0.00 KGS"></div>
    </div>
    <div class="row" style="margin-top:12px">
      <div><label>EIR</label><input id="eir" placeholder="Ej: EIR03758031"></div>
      <div><label>Nave</label><input id="nave" placeholder="Ej: Maersk Bali"></div>
      <div><label>Viaje</label><input id="viaje" placeholder="Ej: 538S"></div>
    </div>
  </div>

  <!-- 3) DETALLE DE DA√ëOS -->
  <div class="card" id="daniosCard">
    <h2>üß© Detalle de Da√±os</h2>
    <div class="table-wrap">
      <table id="tblLines" aria-label="Detalle de da√±os">
        <thead>
          <tr>
            <th style="width:48px">#</th>
            <th style="min-width:160px">Ubicaci√≥n</th>
            <th style="min-width:160px">Componente</th>
            <th style="min-width:160px">Da√±o</th>
            <th style="min-width:140px">M.Rep</th>
            <th style="width:90px">Cant.</th>
            <th style="min-width:120px">Resp.</th>
            <th style="width:72px;text-align:center">R</th>
            <th style="min-width:220px">Fotos</th>
            <th style="width:70px"></th>
          </tr>
        </thead>
        <tbody id="linesBody"></tbody>
      </table>
    </div>
    <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn-sm btn-ghost" id="btnAddLineTop">+ Agregar l√≠nea</button>
      <small style="color:var(--muted)">Cada l√≠nea es obligatoria y debe tener <b>al menos una foto</b>.</small>
    </div>
  </div>

  <!-- 4) RESUMEN -->
  <div class="card">
    <h2>üìä Resumen</h2>
    <div class="summary-grid">
      <div>
        <label>Estado</label>
        <input id="status" value="pendiente" readonly>
      </div>
      <div>
        <label>Total l√≠neas</label>
        <input id="resLineas" value="0" readonly>
      </div>
    </div>
  </div>

  <!-- 5) ACCIONES -->
  <div class="sticky-footer">
    <div class="card" style="margin:0">
      <div class="actions-bottom">
        <button class="btn btn-warn" id="btnSavePending">Guardar pendiente</button>
        <button class="btn" id="btnSubmit">Enviar</button>
      </div>
    </div>
  </div>

</div> <!-- /.wrap -->

<!-- Overlay de carga -->
<div class="loading-overlay" id="loadingOverlay"><div class="spinner"></div></div>
<!-- Toast -->
<div id="toast" class="toast"></div>

<script>
/* =========================
   Config
========================= */
const GAS_URL = "https://script.google.com/macros/s/AKfycbzFILLAVxlmEJDPLh3rftc-jHIs7ygRz21krDTlNIuMnPFPHMnIKcd9rMvzEYIMWuxk4g/exec";

/* =========================
   IndexedDB (cola local)
========================= */
const DB_NAME = 'maersk_inspections_db';
const DB_VERSION = 1;
const STORE = 'inspections';
function idbOpen(){
  return new Promise((resolve,reject)=>{
    const req = indexedDB.open(DB_NAME, DB_VERSION);
    req.onupgradeneeded = e=>{
      const db = e.target.result;
      if(!db.objectStoreNames.contains(STORE)){
        const st = db.createObjectStore(STORE, { keyPath:'id' });
        st.createIndex('by_date','timestamp');
      }
    };
    req.onsuccess = e=> resolve(e.target.result);
    req.onerror = e=> reject(e.target.error);
  });
}
async function idbPut(obj){
  const db = await idbOpen();
  return new Promise((res,rej)=>{
    const tx = db.transaction(STORE,'readwrite');
    tx.objectStore(STORE).put(obj);
    tx.oncomplete = ()=> res(true);
    tx.onerror = e=> rej(e.target.error);
  });
}

/* =========================
   Estado y utilidades
========================= */
const state = {
  id: null,
  fechaISO: null,
  lines: []
};
const $ = (sel, ctx=document) => ctx.querySelector(sel);
const $$ = (sel, ctx=document) => Array.from(ctx.querySelectorAll(sel));
const byId = id => document.getElementById(id);

function uid(){ return (crypto?.randomUUID?.() || ('id_'+Math.random().toString(36).slice(2))); }
function escapeHTML(s=''){ return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
function setChipValues(){
  const today = new Date();
  state.fechaISO = today.toISOString();
  byId('fechaLabel').textContent = today.toLocaleDateString();
  updateHeaderChips();
}
function updateHeaderChips(){
  byId('navieraLabel').textContent = byId('naviera')?.value || '';
  byId('unidadLabel').textContent  = byId('container')?.value || '';
  byId('statusChip').textContent   = byId('status')?.value || 'pendiente';
}
function goBack(){ if(history.length>1) history.back(); else location.href='home.html'; }
function updateCounts(){ byId('resLineas').value = state.lines.length; updateHeaderChips(); }

/* =========================
   Toast + Loading
========================= */
const overlay = byId('loadingOverlay');
const toastEl = byId('toast');
function showOverlay(){ overlay.style.display='flex'; }
function hideOverlay(){ overlay.style.display='none'; }
function showToast(msg, type='ok'){
  toastEl.textContent = msg;
  toastEl.className = 'toast ' + (type==='ok'?'ok':'err');
  toastEl.style.display = 'block';
  setTimeout(()=>{ toastEl.style.display='none'; }, 2200);
}

/* =========================
   Compresi√≥n de imagen
========================= */
async function compressToJPEG(file, maxW=1280, maxH=960, quality=0.8){
  const dataURL = await new Promise((resolve,reject)=>{
    const r = new FileReader();
    r.onload = e => resolve(e.target.result);
    r.onerror = reject;
    r.readAsDataURL(file);
  });
  const img = await new Promise((resolve,reject)=>{
    const im = new Image();
    im.onload = ()=>resolve(im);
    im.onerror = reject;
    im.src = dataURL;
  });
  let {width, height} = img;
  const ratio = Math.min(maxW/width, maxH/height, 1);
  const w = Math.round(width * ratio);
  const h = Math.round(height * ratio);
  const canvas = document.createElement('canvas');
  canvas.width = w; canvas.height = h;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(img, 0, 0, w, h);
  return canvas.toDataURL('image/jpeg', quality);
}

/* =========================
   Render de l√≠neas
========================= */
function renderLines(){
  const body = byId('linesBody');
  body.innerHTML = '';

  state.lines.forEach((ln, idx) => {
    ln._uid = ln._uid || uid();
    ln.fotos = Array.isArray(ln.fotos) ? ln.fotos : [];

    const tr = document.createElement('tr');
    tr.dataset.uid = ln._uid;
    tr.innerHTML = `
      <td>${idx+1}</td>
      <td><input value="${escapeHTML(ln.ubi||'')}" oninput="onLineChange(${idx},'ubi',this.value)" placeholder="Ej: Puerta / Techo"></td>
      <td><input value="${escapeHTML(ln.comp||'')}" oninput="onLineChange(${idx},'comp',this.value)" placeholder="Ej: Bisagra / Panel"></td>
      <td><input value="${escapeHTML(ln.dano||'')}" oninput="onLineChange(${idx},'dano',this.value)" placeholder="Ej: Abolladura / Corte"></td>
      <td><input value="${escapeHTML(ln.mrep||'')}" oninput="onLineChange(${idx},'mrep',this.value)" placeholder="Motivo de reparaci√≥n"></td>
      <td><input type="number" min="1" step="1" inputmode="numeric" pattern="\\d*" value="${Number(ln.cant ?? 1)}" oninput="onLineChange(${idx},'cant',this.value)" style="max-width:100px"></td>
      <td><input value="${escapeHTML(ln.resp||'')}" oninput="onLineChange(${idx},'resp',this.value)" placeholder="Responsable"></td>
      <td style="text-align:center">
        <div class="r-circle ${ln.reparado?'active':''}" onclick="toggleR(${idx}, this)">${ln.reparado?'R':''}</div>
      </td>
      <td>
        <div class="line-photos" id="photos_${ln._uid}">
          ${ln.fotos.map((ph,i)=>(
            `<span class="thumb">
               <img src="${ph.dataURL}" alt="${escapeHTML(ph.name||('foto_'+(i+1)))}">
               <button class="rm" title="Quitar" onclick="removePhoto('${ln._uid}', ${i})">√ó</button>
             </span>`
          )).join('')}
          <span class="photo-btn">
            <input type="file" accept="image/*" capture="environment" id="file_${ln._uid}" multiple>
            <button class="btn-sm" onclick="byId('file_${ln._uid}').click()">üì∏ Agregar</button>
          </span>
        </div>
      </td>
      <td><button class="btn-sm btn-muted" onclick="removeLine(${idx})">‚úï</button></td>
    `;
    body.appendChild(tr);

    const fileInput = byId('file_'+ln._uid);
    if(fileInput && !fileInput._bound){
      fileInput._bound = true;
      fileInput.addEventListener('change', async (ev)=>{
        const files = Array.from(ev.target.files||[]);
        await addPhotosToLine(ln._uid, files);
        ev.target.value = '';
      });
    }
  });

  updateCounts();
}

/* =========================
   Mutadores
========================= */
function addLine(line=null){
  state.lines.push({
    _uid: uid(),
    ubi: line?.ubi || '',
    comp: line?.comp || '',
    dano: line?.dano || '',
    mrep: line?.mrep || '',
    cant: Number.isFinite(line?.cant) ? line.cant : 1,
    resp: line?.resp || '',
    reparado: !!line?.reparado,
    fotos: Array.isArray(line?.fotos) ? line.fotos : []
  });
  renderLines();
}

function removeLine(i){
  state.lines.splice(i,1);
  renderLines();
}

function onLineChange(i, key, val){
  if(key==='cant') val = Math.max(1, parseInt(val || 1, 10) || 1);
  state.lines[i][key] = val;
}

function toggleR(i, el){
  state.lines[i].reparado = !state.lines[i].reparado;
  el.classList.toggle('active');
  el.textContent = state.lines[i].reparado ? 'R' : '';
}

/* Fotos */
async function addPhotosToLine(lineUid, files){
  const ln = state.lines.find(x=>x._uid===lineUid);
  if(!ln) return;
  for(const f of files){
    try{
      const dataURL = await compressToJPEG(f, 1280, 960, 0.8);
      ln.fotos.push({ id: uid(), name: f.name, dataURL });
    }catch(_){}
  }
  renderLines();
}

function removePhoto(lineUid, idx){
  const ln = state.lines.find(x=>x._uid===lineUid);
  if(!ln) return;
  ln.fotos.splice(idx,1);
  renderLines();
}

/* =========================
   Validaciones
========================= */
const reContainer = /^[A-Z]{4}\d{7}$/;
function markInvalid(el, hintId){
  if(!el) return;
  el.classList.add('invalid');
  if(hintId) { const h = byId(hintId); if(h) h.classList.add('show'); }
}
function clearInvalid(...els){
  els.forEach(el=> el && el.classList.remove('invalid'));
  $$('.field-hint.show').forEach(h=> h.classList.remove('show'));
}

function validateGeneral(){
  clearInvalid();
  const container = byId('container');
  const gate = byId('gate');
  const naviera = byId('naviera');
  const tipo = byId('tipo');
  const inspector = byId('inspector');
  const vendor = byId('vendor');

  let ok = true;

  const valC = (container.value || '').toUpperCase().trim();
  container.value = valC;
  if(!(valC.length===11 && reContainer.test(valC))){
    markInvalid(container, 'hint_container'); ok=false;
  }
  if(!gate.value || gate.value==='-'){ markInvalid(gate,'hint_gate'); ok=false; }
  if(!naviera.value){ markInvalid(naviera,'hint_naviera'); ok=false; }
  if(!tipo.value){ markInvalid(tipo,'hint_tipo'); ok=false; }
  if(!inspector.value.trim()){ markInvalid(inspector,'hint_inspector'); ok=false; }
  if(!vendor.value.trim()){ markInvalid(vendor,'hint_vendor'); ok=false; }

  return ok;
}

function validateLinesStrict(){
  // Debe existir al menos 1 l√≠nea y TODAS completas + al menos 1 foto por l√≠nea
  if(!state.lines.length) return {ok:false, msg:'Agrega al menos una l√≠nea de da√±o.'};
  for(let i=0;i<state.lines.length;i++){
    const L = state.lines[i];
    const ok =
      (L.ubi||'').trim() &&
      (L.comp||'').trim() &&
      (L.dano||'').trim() &&
      (L.mrep||'').trim() &&
      Number(L.cant||0) >= 1 &&
      (L.resp||'').trim() &&
      Array.isArray(L.fotos) && L.fotos.length >= 1;
    if(!ok){
      return {ok:false, msg:`L√≠nea ${i+1}: completa todos los campos y a√±ade al menos una foto.`};
    }
  }
  return {ok:true};
}

/* =========================
   Guardar / Enviar
========================= */
function buildPayload(status){
  return {
    id: state.id || uid(),
    timestamp: state.fechaISO || new Date().toISOString(),
    status,

    // Datos Generales
    container: byId('container').value.trim(),
    gate: byId('gate').value,
    naviera: byId('naviera').value,
    tipo: byId('tipo').value,
    inspector: byId('inspector').value.trim(),
    vendor: byId('vendor').value.trim(),

    // Inspecci√≥n Box
    lugar: byId('lugar').value.trim(),
    ptoEmbarque: byId('ptoEmbarque').value.trim(),
    ptoDescarga: byId('ptoDescarga').value.trim(),
    transportista: byId('transportista').value.trim(),
    patenteCamion: byId('patenteCamion').value.trim(),
    cliente: byId('cliente').value.trim(),
    estadoUnidad: byId('estadoUnidad').value.trim(),
    fechaFab: byId('fechaFab').value.trim(),
    classGrado: byId('classGrado').value.trim(),
    mgw: byId('mgw').value.trim(),
    tara: byId('tara').value.trim(),
    payload: byId('payload').value.trim(),
    eir: byId('eir').value.trim(),
    nave: byId('nave').value.trim(),
    viaje: byId('viaje').value.trim(),

    daniosJSON: JSON.stringify(state.lines)
  };
}

function flattenPhotos(){
  return state.lines.flatMap((ln, i) =>
    (ln.fotos||[]).map((f, k) => ({
      name: f.name || `foto_${i+1}_${k+1}.jpg`,
      mimeType: 'image/jpeg',
      dataURL: f.dataURL,
      linea: i+1
    }))
  );
}

/* Guardar pendiente -> SOLO valida Datos Generales */
async function savePendingLocal(){
  if(!validateGeneral()){
    showToast('Completa los campos obligatorios de Datos generales.', 'err');
    return;
  }
  const payload = buildPayload('pendiente');
  const record = { id: payload.id, timestamp: payload.timestamp, payload };
  await idbPut(record);
  showToast('üíæ Guardado en cola local', 'ok');
  setTimeout(()=>{ location.href = 'home.html'; }, 600);
}

/* Enviar -> valida TODO (generales + l√≠neas con fotos) */
async function submitNow(){
  if(!validateGeneral()){
    showToast('Completa Datos generales obligatorios.', 'err');
    return;
  }
  const L = validateLinesStrict();
  if(!L.ok){
    showToast(L.msg, 'err');
    return;
  }
  const payload = buildPayload('enviado');
  const fotos = flattenPhotos();
  try{
    showOverlay();
    const res = await fetch(GAS_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain;charset=utf-8' },
      body: JSON.stringify({ fn:'saveinspection', fotosJSON: JSON.stringify(fotos), ...payload })
    });
    const txt = await res.text();
    let json;
    try{ json = JSON.parse(txt); }catch{ json = {ok:false,error:txt}; }
    if(json?.ok){
      state.id = json.id || payload.id;
      byId('idLabel').textContent = state.id;
      byId('status').value = 'enviado';
      byId('statusChip').textContent = 'enviado';
      showToast('‚úÖ Enviado correctamente', 'ok');
      setTimeout(()=>{ location.href='home.html'; }, 600);
    }else{
      showToast('‚ö†Ô∏è Error al enviar: ' + (json?.error || 'desconocido'), 'err');
    }
  }catch(err){
    console.error(err);
    showToast('‚ö†Ô∏è Error de red al enviar', 'err');
  }finally{
    hideOverlay();
  }
}

/* =========================
   Cargar por ?id=...
========================= */
async function loadInspectionIfAny(){
  const id = new URLSearchParams(location.search).get('id');
  if(!id){
    state.id = null;
    byId('idLabel').textContent = 'nuevo';
    addLine(); // una l√≠nea por defecto
    return;
  }

  try{
    const res = await fetch(GAS_URL + '?fn=getinspection&id=' + encodeURIComponent(id));
    const json = await res.json();
    if(!json?.ok || !json?.item){
      addLine();
      return;
    }

    const it = json.item;
    state.id = it.ID || it.id || id;
    byId('idLabel').textContent = state.id;

    // Datos Generales
    byId('container').value = it.Container || it.container || '';
    byId('gate').value      = it.Gate || it.gate || '-';
    byId('naviera').value   = it.Naviera || it.naviera || '';
    byId('tipo').value      = it.Tipo || it.tipo || '';
    byId('inspector').value = it.Inspector || it.inspector || '';
    byId('vendor').value    = it.Vendor || it.vendor || '';

    // Inspecci√≥n Box
    byId('lugar').value         = it['Lugar'] || it.lugar || '';
    byId('ptoEmbarque').value   = it['Pto Embarque'] || it.ptoEmbarque || '';
    byId('ptoDescarga').value   = it['Pto Descarga'] || it.ptoDescarga || '';
    byId('transportista').value = it['Transportista'] || it.transportista || '';
    byId('patenteCamion').value = it['Patente Camion'] || it.patenteCamion || '';
    byId('cliente').value       = it['Cliente'] || it.cliente || '';
    byId('estadoUnidad').value  = it['Estado Unidad'] || it.estadoUnidad || '';
    byId('fechaFab').value      = it['Fecha Fab'] || it.fechaFab || '';
    byId('classGrado').value    = it['Class Grado'] || it.classGrado || '';
    byId('mgw').value           = it['MGW'] || it.mgw || '';
    byId('tara').value          = it['TARA'] || it.tara || '';
    byId('payload').value       = it['PAYLOAD'] || it.payload || '';
    byId('eir').value           = it['EIR'] || it.eir || '';
    byId('nave').value          = it['Nave'] || it.nave || '';
    byId('viaje').value         = it['Viaje'] || it.viaje || '';

    const status = it['Status'] || it.status || 'pendiente';
    byId('status').value = status;
    byId('statusChip').textContent = status;

    let lines = [];
    try{
      lines = JSON.parse(it['DaniosJSON'] || it.daniosJSON || '[]');
    }catch(_){ lines = []; }

    state.lines = (Array.isArray(lines) ? lines : []).map(L => ({
      _uid: L._uid || uid(),
      ubi: L.ubi || '',
      comp: L.comp || '',
      dano: L.dano || '',
      mrep: L.mrep || '',
      cant: Number.isFinite(L.cant) ? Math.max(1, parseInt(L.cant,10)||1) : 1,
      resp: L.resp || '',
      reparado: !!L.reparado,
      fotos: Array.isArray(L.fotos) ? L.fotos : []
    }));

    if(state.lines.length === 0) addLine(); else renderLines();
    updateCounts();
  }catch(err){
    console.error(err);
    addLine();
  }
}

/* =========================
   Init
========================= */
function bindUI(){
  byId('btnAddLineTop').addEventListener('click', ()=>addLine());
  byId('btnSavePending').addEventListener('click', savePendingLocal);
  byId('btnSubmit').addEventListener('click', submitNow);
  ['naviera','container'].forEach(id=>{
    const el = byId(id);
    if(el) el.addEventListener('input', updateHeaderChips);
  });
  // Limpia marca de error al escribir
  $$('#container, #gate, #naviera, #tipo, #inspector, #vendor').forEach(el=>{
    el.addEventListener('input', ()=> el.classList.remove('invalid'));
    el.addEventListener('change', ()=> el.classList.remove('invalid'));
  });
}

window.addEventListener('DOMContentLoaded', ()=>{
  setChipValues();
  bindUI();
  loadInspectionIfAny();
});
</script>

<script>
/* =========================
   Helpers opcionales
========================= */
document.addEventListener('touchstart', function(){}, {passive:true});
function scrollToBottom(){ window.scrollTo({top:document.body.scrollHeight, behavior:'smooth'}); }
const btnAdd = document.getElementById('btnAddLineTop');
if(btnAdd){ btnAdd.addEventListener('click', ()=>setTimeout(scrollToBottom,300)); }

console.log("‚úÖ Inspect.html ‚Äî validaciones: Generales obligatorios (cola/env√≠o) + l√≠neas con fotos para env√≠o.");
</script>
</body>
</html>
