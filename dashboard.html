<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>MAERSK â€” Dashboard en vivo</title>
<style>
  :root{ --brand:#0b74c7; --bg:#f6f8fb; --ink:#0f172a; --muted:#64748b; --card:#fff; --line:#e2e8f0; --radius:14px }
  *{ box-sizing:border-box }
  body{ margin:0; background:var(--bg); color:var(--ink); font:14px/1.35 system-ui, Segoe UI, Roboto, Helvetica, Arial }
  .wrap{ max-width:1200px; margin:0 auto; padding:16px }
  .card{ background:var(--card); border:1px solid var(--line); border-radius:var(--radius); box-shadow:0 10px 30px rgba(0,0,0,.06) }
  header{ padding:12px 14px; border-bottom:1px solid var(--line); display:flex; gap:12px; align-items:center; justify-content:space-between }
  header h1{ margin:0; font-size:18px }
  .toolbar{ display:flex; flex-wrap:wrap; gap:8px; align-items:center }
  .pill{ display:inline-flex; align-items:center; gap:6px; padding:4px 10px; border:1px solid var(--line); border-radius:999px; font-size:12px; color:#334155; background:#fff }
  .btn{ border:1px solid var(--line); background:#fff; border-radius:10px; padding:8px 12px; cursor:pointer }
  .btn.primary{ background:var(--brand); color:#fff; border-color:var(--brand) }
  .btn:disabled{ opacity:.55; cursor:not-allowed }
  .hide{ display:none !important }
  .section{ padding:12px 14px }
  .row{ display:flex; gap:8px; flex-wrap:wrap; align-items:center }
  input[type="text"], input[type="password"], select{ border:1px solid var(--line); border-radius:10px; padding:8px 10px; font:inherit; background:#fff }
  table{ width:100%; border-collapse:separate; border-spacing:0 }
  thead th{ position:sticky; top:0; background:#f1f5f9; border-bottom:1px solid var(--line); font-weight:600; padding:8px; z-index:1; text-align:left }
  tbody td{ border-bottom:1px dashed #e9eef5; padding:8px 10px; vertical-align:top }
  .badge{ display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; border:1px solid #cbd5e1; background:#fff }
  .b-pend{ border-color:#f59e0b; color:#92400e; background:#fffbeb }
  .b-send{ border-color:#10b981; color:#065f46; background:#ecfdf5 }
  .b-fail{ border-color:#ef4444; color:#7f1d1d; background:#fef2f2 }
  .b-prog{ border-color:#3b82f6; color:#1e3a8a; background:#eff6ff }
  @media (max-width:640px){ .wrap{padding:12px} table{font-size:13px} }

  /* Modal login */
  #loginModal{ position:fixed; inset:0; background:rgba(0,0,0,.6); display:none; z-index:9999; align-items:center; justify-content:center; }
  .login-card{ background:#fff; border:1px solid var(--line); border-radius:16px; padding:16px; width:min(420px,94vw); }
  .login-card h3{ margin:0 0 10px; font-size:18px }
  .login-grid{ display:grid; gap:10px }
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <header>
      <h1>MAERSK â€” Dashboard en vivo</h1>
      <div class="toolbar">
        <span class="pill" id="adminBadge">ðŸ‘¤ Invitado</span>
        <button class="btn" id="btnLogin">Iniciar sesiÃ³n</button>
        <button class="btn" id="btnLogout" style="display:none">Cerrar sesiÃ³n</button>
        <button class="btn" id="btnRefresh">Refrescar</button>
        <button class="btn primary hide" id="btnExportSel">Exportar seleccionadas</button>
      </div>
    </header>

    <div class="section">
      <div class="row" style="justify-content:space-between">
        <div class="row">
          <span class="pill">Pendientes: <b id="kpiPend">0</b></span>
          <span class="pill">Enviando: <b id="kpiProg">0</b></span>
          <span class="pill">Enviadas: <b id="kpiOk">0</b></span>
          <span class="pill">Fallidas: <b id="kpiFail">0</b></span>
        </div>
        <div class="row">
          <input id="txtSearch" type="text" placeholder="Buscar contenedor / folioâ€¦">
          <select id="selStatus">
            <option value="all">Todos</option>
            <option value="pendiente">Pendientes</option>
            <option value="enviando">Enviando</option>
            <option value="enviado">Enviadas</option>
            <option value="fallido">Fallidas</option>
          </select>
          <span class="pill">Auto-refresh <b id="pollSecs">5</b>s</span>
        </div>
      </div>

      <div style="height:10px"></div>

      <div style="overflow:auto">
        <table>
          <thead>
            <tr>
              <th id="thSel" class="hide"><input type="checkbox" id="checkAll" /></th>
              <th>Fecha</th>
              <th>Contenedor</th>
              <th>Gate</th>
              <th>Naviera</th>
              <th>Folio</th>
              <th>Estado</th>
              <th>LÃ­neas</th>
              <th>Fotos</th>
              <th>Status</th>
              <th>Carpeta</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <div class="row" style="justify-content:flex-end;margin-top:10px">
        <span class="pill" id="lastUpdate">â€”</span>
      </div>
    </div>
  </div>
</div>

<!-- Modal login -->
<div id="loginModal">
  <div class="login-card">
    <h3>Acceso administrador</h3>
    <div class="login-grid">
      <div>
        <div class="qtitle">Usuario</div>
        <input id="loginUser" type="text" placeholder="Usuario">
      </div>
      <div>
        <div class="qtitle">ContraseÃ±a</div>
        <input id="loginPass" type="password" placeholder="ContraseÃ±a">
      </div>
    </div>
    <div class="row" style="justify-content:flex-end;margin-top:12px">
      <button class="btn" id="btnLoginCancel">Cancelar</button>
      <button class="btn primary" id="btnLoginOk">Entrar</button>
    </div>
  </div>
</div>

<script>
/* ===== CONFIG ===== */
const API_URL = 'YOUR_WEBAPP_URL/exec'; // <-- pega aquÃ­ tu URL de Web App (termina en /exec)
const POLL_MS = 5000;

/* ===== State ===== */
let AUTH_USER = null;    // 'contopsa'
let AUTH_HASH = null;    // sha256 hex de la contraseÃ±a
let IS_ADMIN = false;
let allData = [];
let timer = null;

/* ===== Helpers ===== */
const $ = (q,el)=> (el||document).querySelector(q);
function download(name, content, mime){ const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([content],{type:mime||'application/json'})); a.download=name; a.click(); }
async function sha256Hex(str){
  const enc = new TextEncoder().encode(str);
  const buf = await crypto.subtle.digest('SHA-256', enc);
  const arr = Array.from(new Uint8Array(buf));
  return arr.map(b=>b.toString(16).padStart(2,'0')).join('');
}

/* ===== API ===== */
async function apiGet(fn, params={}){
  const u = new URL(API_URL);
  u.searchParams.set('fn', fn);
  if(AUTH_USER) u.searchParams.set('user', AUTH_USER);
  if(AUTH_HASH) u.searchParams.set('passHash', AUTH_HASH);
  Object.entries(params).forEach(([k,v])=> u.searchParams.set(k, v));
  const res = await fetch(u.toString(), { method:'GET' });
  return res.json();
}
async function apiPost(fn, body={}){
  const u = new URL(API_URL);
  u.searchParams.set('fn', fn);
  if(AUTH_USER) body.user = AUTH_USER;
  if(AUTH_HASH) body.passHash = AUTH_HASH;
  const res = await fetch(u.toString(), {
    method:'POST',
    headers:{ 'Content-Type':'application/json' },
    body: JSON.stringify(body)
  });
  return res.json();
}

/* ===== UI ===== */
function setAdminUI(isAdmin){
  IS_ADMIN = !!isAdmin;
  $('#adminBadge').textContent = IS_ADMIN ? `ðŸ‘¤ Admin (${AUTH_USER||'â€”'})` : (AUTH_USER ? `ðŸ‘¤ Usuario (${AUTH_USER})` : 'ðŸ‘¤ Invitado');
  $('#btnLogin').style.display = IS_ADMIN ? 'none' : 'inline-block';
  $('#btnLogout').style.display = AUTH_USER ? 'inline-block' : 'none';
  if(IS_ADMIN){ $('#btnExportSel').classList.remove('hide'); $('#thSel').classList.remove('hide'); }
  else{ $('#btnExportSel').classList.add('hide'); $('#thSel').classList.add('hide'); }
}
function kpis(rows){
  const pend = rows.filter(x=>x.status==='pendiente').length;
  const prog = rows.filter(x=>x.status==='enviando').length;
  const ok   = rows.filter(x=>x.status==='enviado').length;
  const fail = rows.filter(x=>x.status==='fallido').length;
  $('#kpiPend').textContent=pend; $('#kpiProg').textContent=prog; $('#kpiOk').textContent=ok; $('#kpiFail').textContent=fail;
}
function render(rows){
  const q = ($('#txtSearch').value||'').trim().toUpperCase();
  const st = $('#selStatus').value;
  let data = rows.slice();
  if(st!=='all') data = data.filter(x=> (x.status||'').toLowerCase()===st);
  if(q){ data = data.filter(x=> (x.container||'').toUpperCase().includes(q) || (x.folio||'').toUpperCase().includes(q)); }
  data.sort((a,b)=> (String(a.fecha) < String(b.fecha) ? 1 : -1));

  const tb = $('#tbody'); tb.innerHTML='';
  for(const r of data){
    const stClass = r.status==='pendiente'?'b-pend': r.status==='enviado'?'b-send': r.status==='enviando'?'b-prog':'b-fail';
    const folderCell = r.folderUrl ? `<a href="${r.folderUrl}" target="_blank" rel="noopener">Abrir</a>` : '<span class="muted">â€”</span>';
    const checkCol = $('#thSel').classList.contains('hide') ? '' : `<td><input type="checkbox" class="row-check" data-id="${r.id}"></td>`;
    const tr=document.createElement('tr');
    tr.innerHTML =
      `${checkCol}
       <td>${String(r.fecha||'').toString().slice(0,10)}</td>
       <td><b>${r.container||''}</b></td>
       <td>${r.gate||''}</td>
       <td>${r.naviera||''}</td>
       <td>${r.folio||''}</td>
       <td>${r.estado||''}</td>
       <td>${r.linesCount??(r.lines?.length||0)}</td>
       <td>${r.photosCount??r.photos_total??0}</td>
       <td><span class="badge ${stClass}">${r.status||''}</span></td>
       <td>${folderCell}</td>`;
    tb.appendChild(tr);
  }
  kpis(rows);
  $('#lastUpdate').textContent = 'Ãšlt. actualizaciÃ³n: ' + new Date().toLocaleString();
}
async function refresh(){
  const res = await apiGet('getinspections');
  if(res?.ok){ allData = res.items||[]; render(allData); }
}
function startPolling(){ if(timer) clearInterval(timer); timer=setInterval(refresh, POLL_MS); $('#pollSecs').textContent=String(POLL_MS/1000|0); }

/* ===== Export ===== */
function getSelectedIds(){ return Array.from(document.querySelectorAll('.row-check:checked')).map(x=>x.getAttribute('data-id')); }
async function exportSelected(){
  const ids = getSelectedIds();
  if(!ids.length){ alert('Selecciona al menos 1 unidad.'); return; }
  const btn = $('#btnExportSel'); const txt=btn.textContent; btn.disabled=true; btn.textContent='Preparandoâ€¦';
  try{
    const res = await apiPost('exportinspectionsbyids', { ids });
    if(!res?.ok) throw new Error(res?.error||'Error exportando');
    download('inspecciones_seleccionadas_'+Date.now()+'.json', JSON.stringify(res,null,2), 'application/json');
  }catch(err){ console.error(err); alert(err.message||String(err)); }
  finally{ btn.disabled=false; btn.textContent=txt; }
}

/* ===== Login simple ===== */
function openLogin(){ $('#loginModal').style.display='flex'; $('#loginUser').focus(); }
function closeLogin(){ $('#loginModal').style.display='none'; }
async function doLogin(){
  const u = $('#loginUser').value.trim();
  const p = $('#loginPass').value;
  if(!u || !p){ alert('Ingresa usuario y contraseÃ±a'); return; }
  const hash = await sha256Hex(p);
  AUTH_USER = u; AUTH_HASH = hash;
  // consultar whoami
  const info = await apiGet('whoami');
  if(info?.ok && info.isAdmin){
    // persistir sesiÃ³n local
    localStorage.setItem('auth_user', AUTH_USER);
    localStorage.setItem('auth_hash', AUTH_HASH);
    setAdminUI(true);
    closeLogin();
    refresh();
  }else{
    AUTH_USER = null; AUTH_HASH = null;
    alert('Credenciales invÃ¡lidas');
  }
}
function doLogout(){
  AUTH_USER = null; AUTH_HASH = null; IS_ADMIN = false;
  localStorage.removeItem('auth_user'); localStorage.removeItem('auth_hash');
  setAdminUI(false);
}

/* ===== Inicio ===== */
window.onload = async function(){
  // restaurar credenciales locales
  const u = localStorage.getItem('auth_user'); const h = localStorage.getItem('auth_hash');
  if(u && h){ AUTH_USER=u; AUTH_HASH=h;
    const info = await apiGet('whoami');
    setAdminUI(!!info.isAdmin);
  }else{
    setAdminUI(false);
  }

  // eventos
  $('#btnLogin').onclick = openLogin;
  $('#btnLoginCancel').onclick = closeLogin;
  $('#btnLoginOk').onclick = doLogin;
  $('#btnLogout').onclick = doLogout;

  $('#btnRefresh').onclick = refresh;
  $('#txtSearch').oninput = ()=> render(allData);
  $('#selStatus').onchange = ()=> render(allData);
  $('#btnExportSel').onclick = exportSelected;
  $('#checkAll').onclick = (e)=>{ const on=e.target.checked; document.querySelectorAll('.row-check').forEach(ch=> ch.checked=on); };

  refresh(); startPolling();
};
</script>
</body>
</html>
