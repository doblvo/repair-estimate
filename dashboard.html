<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>MAERSK â€” Inspecciones + Dashboard</title>
<script defer src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
<style>
:root{
  --brand:#0b74c7; --brand-dark:#075ea6;
  --bg:#f6f8fb; --ink:#1f2937; --muted:#64748b;
  --card:#fff; --line:#e2e8f0; --radius:12px;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);font:14px/1.4 system-ui,Segoe UI,Roboto;color:var(--ink);}
.wrap{max-width:1200px;margin:auto;padding:16px}

/* cards */
.card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);
box-shadow:0 4px 20px rgba(0,0,0,.05);overflow:hidden;}
header{padding:10px 14px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px}
h1{margin:0;font-size:18px;font-weight:600}
.toolbar{display:flex;flex-wrap:wrap;gap:6px}
.pill{display:inline-flex;align-items:center;gap:6px;background:#fff;padding:4px 10px;border:1px solid var(--line);border-radius:999px;font-size:12px;cursor:pointer;transition:.2s;}
.pill.active{background:var(--brand);color:#fff;border-color:var(--brand);}
.btn{border:1px solid var(--line);background:#fff;border-radius:8px;padding:6px 12px;cursor:pointer}
.btn.primary{background:var(--brand);border-color:var(--brand);color:#fff}
.btn.small{font-size:12px;padding:4px 8px}
.btn:disabled{opacity:.6;cursor:not-allowed}
.section{padding:12px 14px}

/* table */
table{width:100%;border-collapse:separate;border-spacing:0}
thead th{background:#f8fafc;border-bottom:1px solid var(--line);padding:8px;font-weight:600;text-align:left;position:sticky;top:0;z-index:1}
tbody td{border-bottom:1px dashed #e2e8f0;padding:6px 8px;vertical-align:top}
.badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px}
.b-pend{background:#fffbeb;color:#92400e;border:1px solid #f59e0b}
.b-prog{background:#eff6ff;color:#1e3a8a;border:1px solid #3b82f6}
.b-send{background:#ecfdf5;color:#065f46;border:1px solid #10b981}
.b-fail{background:#fef2f2;color:#7f1d1d;border:1px solid #ef4444}

/* search bar compact */
.searchbar{display:flex;align-items:center;gap:6px;background:#fff;border:1px solid var(--line);
border-radius:999px;padding:4px 10px;width:240px;}
.searchbar input{border:none;outline:none;flex:1;font:inherit;background:transparent}

/* pagination bottom */
.pager{display:flex;justify-content:space-between;align-items:center;margin-top:10px;flex-wrap:wrap;gap:8px}
.pager select{border:1px solid var(--line);border-radius:6px;padding:4px 6px}
</style>
</head>
<body>
<div class="wrap">

<!-- ==================== DASHBOARD ==================== -->
<div id="view-admin" class="card">
  <header>
    <h1>MAERSK â€” Dashboard en vivo</h1>
    <div class="toolbar">
      <span class="pill" id="adminBadge">ðŸ‘¤ Invitado</span>
      <button class="btn" id="btnAdminRefresh">Refrescar</button>
      <button class="btn small primary" id="btnExportSel" style="display:none">Exportar seleccionadas</button>
    </div>
  </header>

  <div class="section">
    <div class="row" style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:10px">
      <span class="pill active" data-st="all">All</span>
      <span class="pill" data-st="pendiente">Pendientes</span>
      <span class="pill" data-st="enviando">Enviando</span>
      <span class="pill" data-st="enviado">Enviadas</span>
      <span class="pill" data-st="fallido">Fallidas</span>
    </div>

    <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px">
      <div class="searchbar">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path stroke="#64748b" stroke-width="2" d="m21 21-4.35-4.35m2.35-5.15a7.5 7.5 0 1 1-15 0 7.5 7.5 0 0 1 15 0Z"/></svg>
        <input id="a_txtSearch" type="text" placeholder="Buscar contenedorâ€¦">
      </div>
      <span class="pill" id="a_lastUpdate">â€”</span>
    </div>

    <div style="overflow:auto;margin-top:10px">
      <table>
        <thead>
          <tr>
            <th style="width:30px"><input type="checkbox" id="a_checkAll"></th>
            <th>Fecha</th>
            <th>Contenedor</th>
            <th>Gate</th>
            <th>Naviera</th>
            <th>DaÃ±os</th>
            <th>Fotos</th>
            <th>Status</th>
            <th>Carpeta</th>
          </tr>
        </thead>
        <tbody id="a_tbody"></tbody>
      </table>
    </div>

    <div class="pager">
      <div class="row" style="display:flex;gap:8px">
        <button class="btn small" id="a_prev">Â«</button>
        <span id="a_pageInfo" class="pill">PÃ¡gina 1/1</span>
        <button class="btn small" id="a_next">Â»</button>
      </div>
      <div>
        <label style="font-size:12px;margin-right:4px">Mostrar:</label>
        <select id="a_perPage">
          <option value="20">20</option><option value="40">40</option><option value="100">100</option><option value="200">200</option>
        </select>
      </div>
    </div>
  </div>
</div>

</div>

<script>
const API_URL='https://script.google.com/macros/s/AKfycbz22e7uZGaBmSDQujQCNVYJWlKJZYmsf3ch3yMt5wzZx-UXBRb8Rte0mFG5ZzbjzcQD8w/exec';
let IS_ADMIN=true; // para pruebas
let a_all=[],a_filtered=[],a_selected=new Set(),a_page=1,a_per=20,filterState='all';

const $=(q,el=document)=>el.querySelector(q);
function toast(m){console.log(m)}
function a_applyFilters(){
  const q=($("#a_txtSearch").value||'').trim().toUpperCase();
  a_filtered=a_all.filter(r=>{
    const st=filterState==='all'?true:(r.status||'').toLowerCase()===filterState;
    const mq=!q|| (r.container||'').toUpperCase().includes(q);
    return st&&mq;
  });
  a_filtered.sort((a,b)=>String(a.fecha)<String(b.fecha)?1:-1);
}
function a_render(){
  a_applyFilters();
  const tb=$("#a_tbody");tb.innerHTML='';
  const total=a_filtered.length,pages=Math.max(1,Math.ceil(total/a_per));if(a_page>pages)a_page=pages;
  const ini=(a_page-1)*a_per,fin=Math.min(total,ini+a_per);
  for(let i=ini;i<fin;i++){
    const r=a_filtered[i];
    const stc=r.status==='pendiente'?'b-pend':r.status==='enviado'?'b-send':r.status==='enviando'?'b-prog':'b-fail';
    const checked=a_selected.has(r.id)?'checked':'';
    const folder=r.folderUrl?`<a href="${r.folderUrl}" target="_blank">Abrir</a>`:'<span class="muted">â€”</span>';
    const tr=document.createElement('tr');
    tr.innerHTML=`<td><input type="checkbox" class="row-check" data-id="${r.id}" ${checked}></td>
    <td>${String(r.fecha||'').slice(0,10)}</td>
    <td><b>${r.container||''}</b></td>
    <td>${r.gate||''}</td>
    <td>${r.naviera||''}</td>
    <td>${r.danosCount??0}</td>
    <td>${r.fotosCount??0}</td>
    <td><span class="badge ${stc}">${r.status||''}</span></td>
    <td>${folder}</td>`;
    tb.appendChild(tr);
  }
  $("#a_pageInfo").textContent=`PÃ¡gina ${a_page}/${Math.max(1,Math.ceil(total/a_per))}`;
  $("#a_lastUpdate").textContent='Actualizado: '+new Date().toLocaleString();
  $("#btnExportSel").style.display=a_selected.size?'inline-block':'none';
}
async function a_refresh(){
  const res=await fetch(API_URL+'?fn=getinspections');
  const j=await res.json();if(j.ok){a_all=j.items||[];a_page=1;a_render();}
}
$("#a_prev").onclick=()=>{if(a_page>1){a_page--;a_render();}}
$("#a_next").onclick=()=>{const pages=Math.max(1,Math.ceil(a_filtered.length/a_per));if(a_page<pages){a_page++;a_render();}}
$("#a_perPage").onchange=()=>{a_per=Number($("#a_perPage").value||20);a_page=1;a_render();}
$("#a_tbody").addEventListener('change',e=>{
  const ch=e.target.closest('.row-check');if(!ch)return;
  const id=ch.dataset.id;if(ch.checked)a_selected.add(id);else a_selected.delete(id);
  $("#btnExportSel").style.display=a_selected.size?'inline-block':'none';
});
$("#a_checkAll").onclick=e=>{
  const on=e.target.checked;
  document.querySelectorAll('.row-check').forEach(ch=>{
    ch.checked=on;const id=ch.dataset.id;if(on)a_selected.add(id);else a_selected.delete(id);
  });
  $("#btnExportSel").style.display=a_selected.size?'inline-block':'none';
};
document.querySelectorAll('.pill[data-st]').forEach(p=>{
  p.onclick=()=>{
    document.querySelectorAll('.pill[data-st]').forEach(x=>x.classList.remove('active'));
    p.classList.add('active');filterState=p.dataset.st;a_page=1;a_render();
  };
});
$("#a_txtSearch").oninput=()=>a_render();
$("#btnAdminRefresh").onclick=a_refresh;
$("#btnExportSel").onclick=async()=>{
  const ids=[...a_selected];if(!ids.length)return;
  const body={fn:'exportinspectionsbyids',ids};
  const res=await fetch(API_URL+'?fn=exportinspectionsbyids',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
  const j=await res.json();
  if(j.ok){const blob=new Blob([JSON.stringify(j,null,2)],{type:'application/json'});
    const a=document.createElement('a');a.href=URL.createObjectURL(blob);
    a.download='inspecciones_'+Date.now()+'.json';a.click();}
};
window.addEventListener('DOMContentLoaded',a_refresh);
</script>
</body>
</html>
